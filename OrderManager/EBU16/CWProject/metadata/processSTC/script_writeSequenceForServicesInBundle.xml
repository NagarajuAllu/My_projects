<?xml version="1.0" encoding="UTF-8" ?>
<script name="processSTC.writeSequenceForServicesInBundle">
  <label>Write Sequence For Services In Order</label>
  <metaVersion>4</metaVersion>
  <parameterList>
    <parameter name="bundleOrder" type="rifp">
      <type>order_ds_ws.bundleOrderSTC</type>
    </parameter>
    <parameter name="circuitContainer" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var sequence                = 1;
    var priority                = 1;
    var child_processed         = 0;
    var count_processed_in_loop = 0;
    var errorFound              = null;
    var exceptionFound          = null;
    var found_record_with_higher_priority = false;

    if(circuitContainer.services == null) {
        return errorFound;
    }

    try {
        while(child_processed < circuitContainer.services.length && errorFound == null) {
            count_processed_in_loop = 0;
            found_record_with_higher_priority = false;

            for(var i=0; i<circuitContainer.services.length && errorFound == null; i++) {
                var isProvisionable = (!processSTC.isLineItemCompleted(circuitContainer.services[i].service.lineItemStatus) &&
                                       !ds_ws.isVAS(circuitContainer.services[i].service.lineItemType) &&
                                       ds_ws.checkIfServiceTypeAllowsProvisioning(circuitContainer.services[i].service.serviceType) &&
                                       circuitContainer.services[i].service.action != 'N' &&
                                       bundleOrder.orderHeader.orderType != "F"); // services are not provisionable in "F" orders

                if(circuitContainer.services[i].service.priority == priority) {
                    // priority is good; checking if already processed
                    if(! processSTC.existRecordInOrchestrationTable(circuitContainer.services[i].service.id)) {
                        // to be processed; checking if has dependencies
                        if(circuitContainer.services[i].service.dependencies == null || circuitContainer.services[i].service.dependencies.length == 0) {
                            // no dependencies ==> add record to table
                            processSTC.writeRecordForLineItemInOrchestrationTable(bundleOrder.orderHeader.orderNumber,
                                                                                  bundleOrder.id,
                                                                                  circuitContainer.circuit.id,
                                                                                  sequence,
                                                                                  isProvisionable,
                                                                                  circuitContainer.services[i].service,
                                                                                  'S');
                            child_processed++;
                            count_processed_in_loop++;
                            errorFound = processSTC.writeSequenceForSubServicesInBundle(bundleOrder, circuitContainer.services[i]);
                        }
                        else {
                            // there are dependencies; checking if already processed
                            var all_dependencies_processed = true;
                            var dependencies = circuitContainer.services[i].service.dependencies.split(";");
                            for(var j=0; j<dependencies.length && all_dependencies_processed; j++) {
                                // check if the dependencies is in table; if yes, continue, otherwise stop;
                                var recordInOrchestrationTable = processSTC.getRecordInOrchTabByItemIdentifier_OrdNum_CwOrdId(bundleOrder.orderHeader.orderNumber, bundleOrder.id, dependencies[j]);
                                if(recordInOrchestrationTable != null) {
                                    if(recordInOrchestrationTable.elementTypeInOrchestration != 'S') {
                                        // Error in orchestration: element {0} depends on a not sibling element: {1}
                                        exceptionFound = "AE0032";
                                        Global.throwException(Global.translateText("AE0032", null, [circuitContainer.services[i].service.lineItemIdentifier, dependencies[j]]));
                                    }

                                    if(!recordInOrchestrationTable.provisionable) {
                                        // Error in orchestration: element {0} depends on a non provisionable element: {1}
                                        exceptionFound = "AE0033";
                                        Global.throwException(Global.translateText("AE0033", null, [circuitContainer.services[i].service.lineItemIdentifier, dependencies[j]]));
                                    }


                                    // checking that the current element has a higher sequence that the dependency
                                    all_dependencies_processed = (recordInOrchestrationTable.sequence < sequence);
                                }
                                else {
                                    all_dependencies_processed = false;
                                }
                            }

                            if(all_dependencies_processed) {
                                // all dependencies have been already processed ==> add record to table
                                processSTC.writeRecordForLineItemInOrchestrationTable(bundleOrder.orderHeader.orderNumber,
                                                                                      bundleOrder.id,
                                                                                      circuitContainer.circuit.id,
                                                                                      sequence,
                                                                                      isProvisionable,
                                                                                      circuitContainer.services[i].service,
                                                                                      'S');
                                child_processed++;
                                count_processed_in_loop++;
                                errorFound = processSTC.writeSequenceForSubServicesInBundle(bundleOrder, circuitContainer.services[i]);
                            }
                        }
                    }
                    else {
                        // already processed, so skipped
                    }
                }
                else {
                    // priority is different
                    if(!found_record_with_higher_priority) {
                        found_record_with_higher_priority = (circuitContainer.services[i].service.priority > priority);
                    }
                }
            } // end for

            if(count_processed_in_loop == 0) {
                // found no processable record in the for
                if(found_record_with_higher_priority) {
                    // but found a child with higher priority, so increase the priority
                    priority++
                }
                else {
                    errorFound = new DataStructure("ds_ws:OrderFailure");
                    errorFound.ErrorCode = "AE0031";
                    errorFound.ErrorDescription = Global.translateText("AE0031", null, [circuitContainer.circuit.lineItemIdentifier, bundleOrder.orderHeader.orderNumber]);
                    errorFound.ErrorTime = common.common_currentDateAsStringDDMMYYYYHH24MISS();
                    errorFound.ErrorType = "VALIDATION ERROR";
                    errorFound.FunctionName = "SUBMIT ORDER";
                    errorFound.ObjectId = bundleOrder.orderHeader.orderNumber;
                    errorFound.SystemName = "Workflow Director";
                }
            }
            else {
                // increasing the sequence because a new loop has to start
                sequence++;
            }
        }  // end while
    }
    catch(exc) {
        errorFound = new DataStructure("ds_ws:OrderFailure");
        errorFound.ErrorCode = exceptionFound;
        errorFound.ErrorDescription = exc.message;
        errorFound.ErrorTime = common.common_currentDateAsStringDDMMYYYYHH24MISS();
        errorFound.ErrorType = "VALIDATION ERROR";
        errorFound.FunctionName = "SUBMIT ORDER";
        errorFound.ObjectId = bundleOrder.orderHeader.orderNumber;
        errorFound.SystemName = "Workflow Director";
    }
    return errorFound;
  ]]></script>
</script>