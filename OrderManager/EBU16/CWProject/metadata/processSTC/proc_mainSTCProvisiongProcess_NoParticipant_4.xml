<?xml version="1.0" encoding="UTF-8" ?>
<process name="processSTC.mainSTCProvisiongProcess_NoParticipant_4">
  <activity name="start" type="seqActivity">
    <label>Start</label>
    <x>392.21542</x>
    <y>197.00128</y>
    <childList>
      <child name="hasParkProvisioningEnabled" type="switchActivity">
        <label>Has Park Provisioning Enabled?</label>
        <x>658.21545</x>
        <y>191.00128</y>
        <childList>
          <child name="yes" type="caseActivity">
            <label>Yes</label>
            <x>446.69357</x>
            <y>212.8982</y>
            <childList>
              <child name="start" type="seqActivity">
                <label>Start</label>
                <x>669.21545</x>
                <y>334.00125</y>
                <childList>
                  <child name="sendCompletionWOSUForParentElement" type="scriptActivity">
                    <label>Send Completion WOSU For Parent Element</label>
                    <x>660.21545</x>
                    <y>466.00128</y>
                    <methodList>
                      <method name="cwOnProcActBefore" type="action">
                        <category>before</category>
                        <system>true</system>
                        <script><![CDATA[
                          var parentLineItem = ds_ws.getLineItemParentOfLineItem(this.process.processOrderItem);

                          var orchestrationRecord = processSTC.getRecordInOrchestrationTableByLineItemId(parentLineItem.id);
                          if(! orchestrationRecord.provisionable) {

                          debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - generating Completion WOSU for LineItem = " + parentLineItem.lineItemIdentifier);

                              processSTC.generateCompletionWOSUForLineItem(parentLineItem, this.process.processOrder);
                          }
                          else {

                          debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - NOT generating Completion WOSU for LineItem = " + parentLineItem.lineItemIdentifier);

                          }
                        ]]></script>
                      </method>
                    </methodList>
                  </child>
                  <child name="waitForResumeProvisioningSignal" type="syncActivity">
                    <element>signal_processSTC.resumeProvisioningProcess</element>
                    <label>Wait For ResumeProvisioning Signal</label>
                    <x>835.21545</x>
                    <y>471.00128</y>
                    <methodList>
                      <method name="cwOnProcActAfter" type="action">
                        <category>script</category>
                        <system>true</system>
                        <script><![CDATA[
                          debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - received 'ResumeProvisioning' signal");
                        ]]></script>
                      </method>
                    </methodList>
                  </child>
                </childList>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActCond" type="action">
                <category>cond</category>
                <system>true</system>
                <script><![CDATA[
                  var parkProvisioningProcess = (this.process.processOrderItem.parkProvisioning && (!this.process.processOrderItem.resumeProvisioning));

                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - parkProvisioning = " + this.process.processOrderItem.parkProvisioning);
                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - resumeProvisioning = " + this.process.processOrderItem.resumeProvisioning);
                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - parkProvisioningProcess = " + parkProvisioningProcess);

                  return parkProvisioningProcess;
                ]]></script>
              </method>
            </methodList>
          </child>
          <child name="no" type="caseActivity">
            <label>No</label>
            <x>819.21545</x>
            <y>197.0013</y>
          </child>
        </childList>
      </child>
      <child name="hasToSkipSendLineItemToGranite" type="switchActivity">
        <label>Has To Skip Send LineItem To Granite?</label>
        <x>956.21545</x>
        <y>189.00128</y>
        <childList>
          <child name="yes" type="caseActivity">
            <label>Yes</label>
            <x>210.50818</x>
            <y>237.0</y>
            <childList>
              <child name="doNothing" type="scriptActivity">
                <label>Do Nothing</label>
                <x>970.21564</x>
                <y>708.0013</y>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script>this.process.processDocument.acceptedByGranite = true;;</script>
                  </method>
                </methodList>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActCond" type="action">
                <category>cond</category>
                <system>true</system>
                <script>return this.process.processOrderItem.alreadySentToGranite;</script>
              </method>
            </methodList>
          </child>
          <child name="no" type="caseActivity">
            <label>No</label>
            <x>210.50818</x>
            <y>237.0</y>
            <childList>
              <child name="start" type="seqActivity">
                <label>Start</label>
                <x>1087.4938</x>
                <y>193.47942</y>
                <childList>
                  <child name="startICMSInProcessCheck" type="seqActivity">
                    <label>Start ICMS In Process Check</label>
                    <x>1198.4939</x>
                    <y>191.47942</y>
                    <childList>
                      <child name="markICMSInProcess" type="scriptActivity">
                        <label>Mark ICMS As In Process</label>
                        <x>1306.4938</x>
                        <y>174.47943</y>
                        <methodList>
                          <method name="cwOnProcActBefore" type="action">
                            <category>before</category>
                            <system>true</system>
                            <script><![CDATA[
                              var bundleOrderHeader = this.process.processOrder.orderHeader;

                              if(bundleOrderHeader.icmsSalesOrderNumber == null) {
                              debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - No icmsSalesOrderNumber received; continue...");
                                  this.process.processDocument.icmsSONumberInUse = false;
                              }
                              else {
                                  try {
                                      ds_ws.addICMSSONumberToInProcessList(bundleOrderHeader.icmsSalesOrderNumber, bundleOrderHeader.orderNumber);
                                      this.process.processDocument.icmsSONumberInUse = false;
                              debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - icmsSalesOrderNumber " + bundleOrderHeader.icmsSalesOrderNumber + " was not in process; continue...");
                                  }
                                  catch(exc) {
                              debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - icmsSalesOrderNumber " + bundleOrderHeader.icmsSalesOrderNumber + " is already in process: sleeping ...." + exc.message);
                                      this.process.processDocument.icmsSONumberInUse = true;
                                  }
                              }
                            ]]></script>
                          </method>
                        </methodList>
                      </child>
                      <child name="isICMSSONumberInUse" type="switchActivity">
                        <label>Is ICMSSONumber In Use?</label>
                        <x>1427.4938</x>
                        <y>174.47943</y>
                        <childList>
                          <child name="yes" type="caseActivity">
                            <label>Yes</label>
                            <x>1589.4938</x>
                            <y>293.47943</y>
                            <childList>
                              <child name="startSleeping" type="seqActivity">
                                <label>Start Sleeping</label>
                                <x>1443.4938</x>
                                <y>26.479431</y>
                                <childList>
                                  <child name="repeatAndSleep" type="repeatActivity">
                                    <element>proc_processSTC.mainSTCProvisiongProcess_NoParticipant_4/seqActivity_start/switchActivity_hasToSkipSendLineItemToGranite/caseActivity_no/seqActivity_start/seqActivity_startICMSInProcessCheck</element>
                                    <label>Repeat And Sleep</label>
                                    <schedule type="sched">
                                      <duration type="dur">
                                        <methodList>
                                          <method name="cwOnDuration" type="action">
                                            <system>true</system>
                                            <script><![CDATA[
                                              // configured time for sleeping
                                              var sleepForICMSONumberInProcess = 30*Math.random();

                                              debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.id + "] - sleep for : " + sleepForICMSONumberInProcess + " secs due to ICMSONumberInProcess!");

                                              return sleepForICMSONumberInProcess;
                                            ]]></script>
                                          </method>
                                        </methodList>
                                      </duration>
                                    </schedule>
                                    <x>1194.4939</x>
                                    <y>15.479416</y>
                                  </child>
                                </childList>
                              </child>
                            </childList>
                            <methodList>
                              <method name="cwOnProcActCond" type="action">
                                <category>cond</category>
                                <system>true</system>
                                <script>return this.process.processDocument.icmsSONumberInUse;</script>
                              </method>
                            </methodList>
                          </child>
                          <child name="no" type="caseActivity">
                            <label>No</label>
                            <x>1570.9673</x>
                            <y>194.91493</y>
                          </child>
                        </childList>
                      </child>
                    </childList>
                  </child>
                  <child name="startGranite" type="seqActivity">
                    <label>Start Granite</label>
                    <x>1643.4935</x>
                    <y>197.47942</y>
                    <childList>
                      <child name="operationTypeInGranite" type="switchActivity">
                        <label>Operation Type In Granite</label>
                        <x>1641.4938</x>
                        <y>325.47943</y>
                        <childList>
                          <child name="submitOrder" type="caseActivity">
                            <label>Submit Order</label>
                            <x>210.50818</x>
                            <y>537.0</y>
                            <childList>
                              <child name="startSubmit" type="seqActivity">
                                <label>Start Submit</label>
                                <x>1812.4935</x>
                                <y>333.4794</y>
                                <childList>
                                  <child name="startSubmitForCompensate" type="seqActivity">
                                    <label>Start Submit For Compensate</label>
                                    <x>1804.4716</x>
                                    <y>441.39563</y>
                                    <childList>
                                      <child name="compensationForLockManagement" type="scriptActivity">
                                        <label>Compensation For Lock Management</label>
                                        <x>1796.2256</x>
                                        <y>580.39557</y>
                                        <childList>
                                          <child name="lockCompensation" type="compensateActivity">
                                            <compensatesList>
                                              <compensates>5</compensates>
                                            </compensatesList>
                                            <label>Lock Management Compensation</label>
                                            <x>1205.246</x>
                                            <y>489.8662</y>
                                            <childList>
                                              <child name="lockCompensation" type="subflowActivity">
                                                <element>proc_processSTC.lockManagementCompensation</element>
                                                <label>Lock Compensation</label>
                                                <x>2039.0459</x>
                                                <y>608.44745</y>
                                              </child>
                                            </childList>
                                          </child>
                                        </childList>
                                        <methodList>
                                          <method name="cwOnProcActBefore" type="action">
                                            <category>before</category>
                                            <system>true</system>
                                            <script>// just for lock compensation</script>
                                          </method>
                                        </methodList>
                                      </child>
                                      <child name="sendSubmitOrderToGranite" type="scriptActivity">
                                        <label>Send Submit Order  To Granite</label>
                                        <x>1810.8751</x>
                                        <y>720.44727</y>
                                        <childList>
                                          <child name="TimeDelay" type="compensateActivity">
                                            <compensatesList>
                                              <compensates>1</compensates>
                                            </compensatesList>
                                            <label>Time Delay</label>
                                            <x>777.15845</x>
                                            <y>601.0438</y>
                                            <childList>
                                              <child name="startSubComp" type="subflowActivity">
                                                <element>proc_processSTC.startSubComp</element>
                                                <label>Start Submit Write Compensate</label>
                                                <x>2002.2129</x>
                                                <y>764.6026</y>
                                              </child>
                                            </childList>
                                          </child>
                                        </childList>
                                        <methodList>
                                          <method name="cwOnProcActBefore" type="action">
                                            <category>before</category>
                                            <system>true</system>
                                            <script><![CDATA[
                                              // reset error flag
                                              this.process.processDocument.errorType = null;

                                              // loading order and orderItem
                                              var bundleOrder = this.process.processOrder;
                                              var orderItem = this.process.processOrderItem;


                                              try {
                                                  var inputJMS = processSTC.prepareJMSDSOrder(bundleOrder, orderItem);
                                              debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - inputJMS = " + inputJMS.toXML());

                                                  // sendDataToInterface( inputData, interfaceName, operationName, existResult, processId, operationDescription )
                                                  processSTC.sendDataToInterface(inputJMS,
                                                                                 "ifGranite_jms:XngServicesWR",
                                                                                 "SubmitOrder",
                                                                                 false,
                                                                                 this.process.id,
                                                                                 "SendSubmitOrderToGranite",
                                                                                 bundleOrder.orderHeader.orderNumber,
                                                                                 orderItem.workOrderNumber);
                                              debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - sentDataToGranite");

                                              }
                                              catch(exc) {
                                                  if(exc.message.indexOf("XE0023") >= 0 || exc.message.indexOf("XE0002")) {
                                                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - I/F ifGranite_jms:XngServicesWR/SubmitOrder error: " + exc.message);
                                                      this.process.processDocument.errorType = "Interface";
                                                  }
                                                  else {
                                                      this.process.processDocument.errorType = "Application";
                                                  }
                                              }
                                            ]]></script>
                                          </method>
                                        </methodList>
                                      </child>
                                      <child name="anyError" type="switchActivity">
                                        <label>Any Error?</label>
                                        <x>1806.8458</x>
                                        <y>902.3038</y>
                                        <childList>
                                          <child name="interfaceError" type="caseActivity">
                                            <label>Interface Error</label>
                                            <x>0.0</x>
                                            <y>0.0</y>
                                            <childList>
                                              <child name="interfaceExcp" type="exceptActivity">
                                                <element>excp_cwf.interfaceExcp</element>
                                                <label>External interface error</label>
                                                <x>2014.7755</x>
                                                <y>1048.0568</y>
                                              </child>
                                            </childList>
                                            <methodList>
                                              <method name="cwOnProcActCond" type="action">
                                                <category>cond</category>
                                                <system>true</system>
                                                <script><![CDATA[
                                                  var isInterfaceError = (this.process.processDocument.errorType == "Interface");
                                                  if(isInterfaceError) {
                                                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Interface error while sending submitOrder to Granite");
                                                  }

                                                  return isInterfaceError;
                                                ]]></script>
                                              </method>
                                            </methodList>
                                          </child>
                                          <child name="applicationError" type="caseActivity">
                                            <label>Application Error</label>
                                            <x>0.0</x>
                                            <y>0.0</y>
                                            <childList>
                                              <child name="genericApplicationError" type="exceptActivity">
                                                <element>excp_processSTC.genericApplicationError</element>
                                                <label>Generic Application Error</label>
                                                <x>1903.1691</x>
                                                <y>1048.0568</y>
                                              </child>
                                            </childList>
                                            <methodList>
                                              <method name="cwOnProcActCond" type="action">
                                                <category>cond</category>
                                                <system>true</system>
                                                <script><![CDATA[
                                                  var isApplicationError = (this.process.processDocument.errorType == "Application");
                                                  if(isApplicationError) {
                                                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Application error while sending submitOrder to Granite");
                                                  }

                                                  return isApplicationError;
                                                ]]></script>
                                              </method>
                                            </methodList>
                                          </child>
                                          <child name="noError" type="caseActivity">
                                            <label>No Error</label>
                                            <x>1796.7152</x>
                                            <y>1055.758</y>
                                          </child>
                                        </childList>
                                      </child>
                                    </childList>
                                    <methodList>
                                      <method name="cwOnProcActBefore" type="action">
                                        <category>before</category>
                                        <system>true</system>
                                        <script><![CDATA[
                                          var orderItem = this.process.processOrderItem;

                                          var workOrderType = processSTC.getWorkOrderType(this.process.processOrder.orderHeader.orderType, orderItem.action);

                                          if(orderItem.workOrderNumber == null) {
                                              var workOrderNumber = processSTC.generateWONumber(orderItem, workOrderType, this.process.processOrder); // processSTC.getNewChildOrderNumber(workOrderType);
                                              if(workOrderNumber == null) {
                                                  Global.throwException("Error in generating workOrderNumber");
                                              }
                                              orderItem.workOrderNumber = workOrderNumber;
                                              orderItem.save();
                                          }
                                        ]]></script>
                                      </method>
                                    </methodList>
                                  </child>
                                  <child name="midSubmit" type="seqActivity">
                                    <label>Mid Submit</label>
                                    <x>1797.7877</x>
                                    <y>1181.212</y>
                                    <childList>
                                      <child name="doNothing" type="scriptActivity">
                                        <label>Just for Compensation</label>
                                        <x>1780.7876</x>
                                        <y>1279.2122</y>
                                        <childList>
                                          <child name="timeDelay" type="compensateActivity">
                                            <compensatesList>
                                              <compensates>2</compensates>
                                            </compensatesList>
                                            <label>Time Delay</label>
                                            <x>615.42145</x>
                                            <y>848.82117</y>
                                            <childList>
                                              <child name="startSubReadComp" type="subflowActivity">
                                                <element>proc_processSTC.startSubReadComp</element>
                                                <label>Start Submit  Read Compensate</label>
                                                <x>1966.7018</x>
                                                <y>1269.2639</y>
                                                <methodList>
                                                  <method name="cwOnProcActBefore" type="action">
                                                    <category>before</category>
                                                    <system>true</system>
                                                    <script><![CDATA[
                                                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Start Submit Read Compensate ...");
                                                    ]]></script>
                                                  </method>
                                                </methodList>
                                              </child>
                                            </childList>
                                          </child>
                                        </childList>
                                      </child>
                                      <child name="foundMessage" type="switchActivity">
                                        <label>Found Message?</label>
                                        <x>1791.7876</x>
                                        <y>1425.212</y>
                                        <childList>
                                          <child name="no" type="caseActivity">
                                            <label>No</label>
                                            <x>808.80225</x>
                                            <y>1034.7327</y>
                                            <childList>
                                              <child name="timeoutError" type="exceptActivity">
                                                <element>excp_cwf.timeout</element>
                                                <label>Timeout Error</label>
                                                <x>1918.7877</x>
                                                <y>1425.212</y>
                                              </child>
                                            </childList>
                                            <methodList>
                                              <method name="cwOnProcActCond" type="action">
                                                <category>cond</category>
                                                <system>true</system>
                                                <script><![CDATA[
                                                  var graniteResponse = processSTC.readGraniteResponseFromDB(this.process.id);

                                                  return (graniteResponse == null);
                                                ]]></script>
                                              </method>
                                            </methodList>
                                          </child>
                                          <child name="yesButLock" type="caseActivity">
                                            <label>Yes But Lock</label>
                                            <x>1087.9877</x>
                                            <y>1408.6309</y>
                                            <childList>
                                              <child name="lockException" type="exceptActivity">
                                                <element>excp_processSTC.lockException</element>
                                                <label>Lock Exception</label>
                                                <x>1827.7876</x>
                                                <y>1550.2122</y>
                                              </child>
                                            </childList>
                                            <methodList>
                                              <method name="cwOnProcActCond" type="action">
                                                <category>cond</category>
                                                <system>true</system>
                                                <script><![CDATA[
                                                  var graniteResponse = processSTC.readGraniteResponseFromDB(this.process.id);

                                                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Received SubmitResponse from Granite and checking for lock: " + graniteResponse.toXML());

                                                  var isLock = false;
                                                  if(graniteResponse != null) {
                                                      if(graniteResponse.failure != null && graniteResponse.failure.length > 0) {
                                                          // check number of retries for lock error
                                                          isLock = ds_ws.isLockError(graniteResponse.failure);
                                                      }
                                                  }

                                                  if(isLock) {
                                                      var maxNumberOfRetriesForLock = Global.getConfigVariable("NUM_RETRIES_LOCK", 5);
                                                      if(maxNumberOfRetriesForLock == Number.NAN) {
                                                          maxNumberOfRetriesForLock = 5;
                                                      }
                                                      isLock = (this.process.processDocument.numberOfRetriesForLock < maxNumberOfRetriesForLock);
                                                  }

                                                  if(isLock) {
                                                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - found Lock in Granite response; removing Granite response!");

                                                      // STCSUP-1445: remove the "lock" response to avoid that EOC reprocesses the old response;
                                                      processSTC.deleteGraniteResponseFromDB(this.process.id);

                                                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - found Lock in Granite response; removed Granite response!");
                                                  }

                                                  return isLock;
                                                ]]></script>
                                              </method>
                                            </methodList>
                                          </child>
                                          <child name="yes" type="caseActivity">
                                            <label>Yes</label>
                                            <x>808.80225</x>
                                            <y>1034.7327</y>
                                            <childList>
                                              <child name="checkIfMessageIsReceived" type="scriptActivity">
                                                <label>Check If Message Is Received</label>
                                                <x>1652.7877</x>
                                                <y>1417.2122</y>
                                                <methodList>
                                                  <method name="cwOnProcActBefore" type="action">
                                                    <category>before</category>
                                                    <system>true</system>
                                                    <script><![CDATA[
                                                      var graniteResponse = processSTC.readGraniteResponseFromDB(this.process.id);

                                                      if(graniteResponse == null) {
                                                          Global.throwException("cwf.timeout");
                                                      }

                                                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - receivedSubmitResponse = " + graniteResponse.toXML());


                                                      var orderAcceptedByGranite = (graniteResponse.failure == null || graniteResponse.failure.length == 0);

                                                      // updates info in lineItem
                                                      this.process.processOrderItem.workOrderNumber = graniteResponse.workOrderNumber;
                                                      this.process.processOrderItem.lineItemStatus = ((orderAcceptedByGranite) ? "READY" : "FAILED");
                                                      this.process.processOrderItem.alreadySentToGranite = orderAcceptedByGranite;
                                                      this.process.processOrderItem.sentAnytimeToGranite = (orderAcceptedByGranite || this.process.processOrderItem.sentAnytimeToGranite);
                                                      this.process.processOrderItem.save();

                                                      // updates bundle and orderHeader status
                                                      ds_ws.updateBundleAndOrderHeaderStatus(this.process.processOrder, this.process.processOrderItem);

                                                      // update orchestrationRecord to know if Granite accepted the WorkOrder
                                                      var recordInOrchestrationTable = processSTC.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);
                                                      if(orderAcceptedByGranite) {
                                                          debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - submitOrderForElement = " + this.process.processOrderItem.id + " processed SUCCESSFULLY");
                                                          this.process.processDocument.acceptedByGranite = true;
                                                          // saving result of provisioning process
                                                          recordInOrchestrationTable.provisioningProcessResult = "OK";
                                                      }
                                                      else {
                                                          debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - submitOrderForElement = " + this.process.processOrderItem.id + " REJECTED BY GRANITE!!!!");
                                                          this.process.processDocument.acceptedByGranite = false;
                                                          // saving result of provisioning process; KO ==> block all provisioning processes for such order
                                                          recordInOrchestrationTable.provisioningProcessResult = "KO";

                                                          if(ds_ws.isLockError(graniteResponse.failure)) {
                                                              // it means that the order exceeded the retry attemps and so the orderNumber is stored into the orderLocked table to be re-processed the next day
                                                              processSTC.addOrderToFailedOrdersForLockList(this.process.processOrder.orderHeader.orderNumber);
                                                          }
                                                      }
                                                      recordInOrchestrationTable.save();

                                                      if(!orderAcceptedByGranite) {
                                                          // 2015-09-07: dummy WOSU management for failed order
                                                          var supportDummyWOSU = Global.getConfigVariable("DUMMY_WOSU_FOR_FAILED_ORDER", "FALSE");
                                                          if(supportDummyWOSU == "TRUE") {
                                                              processSTC.generateDummyWOSUForFailedOrderToGranite(this.process.processOrder.orderHeader.orderNumber, this.process.processOrderItem);
                                                          }
                                                      }


                                                      // removing icmsSalesOrderNumber from in Process
                                                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - removing icmsSalesOrderNumber from in Process = " +
                                                                   this.process.processOrder.orderHeader.icmsSalesOrderNumber + "; orderNumber = " + this.process.processOrder.orderHeader.orderNumber);
                                                      ds_ws.removeICMSSONumberFromInProcessList(this.process.processOrder.orderHeader.icmsSalesOrderNumber, this.process.processOrder.orderHeader.orderNumber);
                                                    ]]></script>
                                                  </method>
                                                </methodList>
                                              </child>
                                            </childList>
                                          </child>
                                        </childList>
                                      </child>
                                    </childList>
                                    <methodList>
                                      <method name="cwOnProcActBefore" type="action">
                                        <category>before</category>
                                        <system>true</system>
                                        <script><![CDATA[
                                          this.process.processDocument.rollbackNumber = "2";

                                          this.process.processOrderItem.lineItemStatus = "Waiting for Granite Resp";
                                          this.process.processOrderItem.save();
                                          debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Restarting waiting ...");
                                        ]]></script>
                                      </method>
                                    </methodList>
                                  </child>
                                </childList>
                                <methodList>
                                  <method name="cwOnProcActBefore" type="action">
                                    <category>before</category>
                                    <system>true</system>
                                    <script><![CDATA[this.process.processDocument.rollbackNumber = "1";]]></script>
                                  </method>
                                </methodList>
                              </child>
                            </childList>
                            <methodList>
                              <method name="cwOnProcActCond" type="action">
                                <category>cond</category>
                                <system>true</system>
                                <script><![CDATA[
                                  var isSubmit = (this.process.processDocument.isSubmit == "Y");
                                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - isSubmit = " + isSubmit);

                                  return isSubmit;
                                ]]></script>
                              </method>
                            </methodList>
                          </child>
                          <child name="updateOrder" type="caseActivity">
                            <label>Update Order</label>
                            <x>210.50818</x>
                            <y>537.0</y>
                            <childList>
                              <child name="startUpdate" type="seqActivity">
                                <label>Start Update</label>
                                <x>1412.4938</x>
                                <y>330.4794</y>
                                <childList>
                                  <child name="startUpdateForCompensate" type="seqActivity">
                                    <label>Start Update For Compensate</label>
                                    <x>1404.2256</x>
                                    <y>434.39557</y>
                                    <childList>
                                      <child name="compensationForLockManagement" type="scriptActivity">
                                        <label>Compensation For Lock Management</label>
                                        <x>1396.2256</x>
                                        <y>572.39557</y>
                                        <childList>
                                          <child name="lockCompensation" type="compensateActivity">
                                            <compensatesList>
                                              <compensates>6</compensates>
                                            </compensatesList>
                                            <label>Lock Management Compensation</label>
                                            <x>1205.246</x>
                                            <y>489.8662</y>
                                            <childList>
                                              <child name="lockCompensation" type="subflowActivity">
                                                <element>proc_processSTC.lockManagementCompensation</element>
                                                <label>Lock Compensation</label>
                                                <x>1234.0459</x>
                                                <y>568.44745</y>
                                              </child>
                                            </childList>
                                          </child>
                                        </childList>
                                        <methodList>
                                          <method name="cwOnProcActBefore" type="action">
                                            <category>before</category>
                                            <system>true</system>
                                            <script>// just for lock compensation</script>
                                          </method>
                                        </methodList>
                                      </child>
                                      <child name="sendUpdateOrderToGranite" type="scriptActivity">
                                        <label>Send Update Order  To Granite</label>
                                        <x>1411.0459</x>
                                        <y>703.44745</y>
                                        <childList>
                                          <child name="TimeDelay" type="compensateActivity">
                                            <compensatesList>
                                              <compensates>3</compensates>
                                            </compensatesList>
                                            <label>Time Delay</label>
                                            <x>0.0</x>
                                            <y>0.0</y>
                                            <childList>
                                              <child name="startUpdComp" type="subflowActivity">
                                                <element>proc_processSTC.startSubComp</element>
                                                <label>Start Update Write Compensate</label>
                                                <x>1225.354</x>
                                                <y>754.6027</y>
                                              </child>
                                            </childList>
                                          </child>
                                        </childList>
                                        <methodList>
                                          <method name="cwOnProcActBefore" type="action">
                                            <category>before</category>
                                            <system>true</system>
                                            <script><![CDATA[
                                              // reset error flag
                                              this.process.processDocument.errorType = null;

                                              // loading order and orderItem
                                              var bundleOrder = this.process.processOrder;
                                              var orderItem = this.process.processOrderItem;


                                              try {
                                                  var inputJMS = processSTC.prepareJMSDSOrder(bundleOrder, orderItem);
                                              debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - inputJMS = " + inputJMS.toXML());

                                                  // sendDataToInterface( inputData, interfaceName, operationName, existResult, processId, operationDescription )
                                                  processSTC.sendDataToInterface(inputJMS,
                                                                                 "ifGranite_jms:XngServicesWR",
                                                                                 "UpdateOrder",
                                                                                 false,
                                                                                 this.process.id,
                                                                                 "SendUpdateOrderToGranite",
                                                                                 bundleOrder.orderHeader.orderNumber,
                                                                                 orderItem.workOrderNumber);
                                              debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - sentDataToGranite");

                                              }
                                              catch(exc) {
                                                  if(exc.message.indexOf("XE0023") >= 0 || exc.message.indexOf("XE0002")) {
                                                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - I/F ifGranite_jms:XngServicesWR/UpdateOrder error: " + exc.message);
                                                      this.process.processDocument.errorType = "Interface";
                                                  }
                                                  else {
                                                      this.process.processDocument.errorType = "Application";
                                                  }
                                              }
                                            ]]></script>
                                          </method>
                                        </methodList>
                                      </child>
                                      <child name="anyError" type="switchActivity">
                                        <label>Any Error?</label>
                                        <x>1407.0465</x>
                                        <y>874.3038</y>
                                        <childList>
                                          <child name="interfaceError" type="caseActivity">
                                            <label>Interface Error</label>
                                            <x>0.0</x>
                                            <y>0.0</y>
                                            <childList>
                                              <child name="interfaceExcp" type="exceptActivity">
                                                <element>excp_cwf.interfaceExcp</element>
                                                <label>External interface error</label>
                                                <x>1200.9039</x>
                                                <y>1026.0568</y>
                                              </child>
                                            </childList>
                                            <methodList>
                                              <method name="cwOnProcActCond" type="action">
                                                <category>cond</category>
                                                <system>true</system>
                                                <script><![CDATA[
                                                  var isInterfaceError = (this.process.processDocument.errorType == "Interface");
                                                  if(isInterfaceError) {
                                                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Interface error while sending submitOrder to Granite");
                                                  }

                                                  return isInterfaceError;
                                                ]]></script>
                                              </method>
                                            </methodList>
                                          </child>
                                          <child name="applicationError" type="caseActivity">
                                            <label>Application Error</label>
                                            <x>0.0</x>
                                            <y>0.0</y>
                                            <childList>
                                              <child name="genericApplicationError" type="exceptActivity">
                                                <element>excp_processSTC.genericApplicationError</element>
                                                <label>Generic Application Error</label>
                                                <x>1296.1832</x>
                                                <y>1027.0568</y>
                                              </child>
                                            </childList>
                                            <methodList>
                                              <method name="cwOnProcActCond" type="action">
                                                <category>cond</category>
                                                <system>true</system>
                                                <script><![CDATA[
                                                  var isApplicationError = (this.process.processDocument.errorType == "Application");
                                                  if(isApplicationError) {
                                                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Application error while sending submitOrder to Granite");
                                                  }

                                                  return isApplicationError;
                                                ]]></script>
                                              </method>
                                            </methodList>
                                          </child>
                                          <child name="noError" type="caseActivity">
                                            <label>No Error</label>
                                            <x>1429.8435</x>
                                            <y>1052.7579</y>
                                          </child>
                                        </childList>
                                      </child>
                                    </childList>
                                  </child>
                                  <child name="midUpdate" type="seqActivity">
                                    <label>Mid Update</label>
                                    <x>1431.7877</x>
                                    <y>1173.212</y>
                                    <childList>
                                      <child name="doNothing" type="scriptActivity">
                                        <label>Just for Compensation</label>
                                        <x>1414.7876</x>
                                        <y>1286.2122</y>
                                        <childList>
                                          <child name="timeDelay" type="compensateActivity">
                                            <compensatesList>
                                              <compensates>4</compensates>
                                            </compensatesList>
                                            <label>Time Delay</label>
                                            <x>0.0</x>
                                            <y>0.0</y>
                                            <childList>
                                              <child name="startUpdReadComp" type="subflowActivity">
                                                <element>proc_processSTC.startSubReadComp</element>
                                                <label>Start Update  Read Compensate</label>
                                                <x>1225.8346</x>
                                                <y>1266.2638</y>
                                                <methodList>
                                                  <method name="cwOnProcActBefore" type="action">
                                                    <category>before</category>
                                                    <system>true</system>
                                                    <script><![CDATA[
                                                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Start Update Read Compensate ...");
                                                    ]]></script>
                                                  </method>
                                                </methodList>
                                              </child>
                                            </childList>
                                          </child>
                                        </childList>
                                      </child>
                                      <child name="foundMessage" type="switchActivity">
                                        <label>Found Message?</label>
                                        <x>1425.7876</x>
                                        <y>1427.2119</y>
                                        <childList>
                                          <child name="no" type="caseActivity">
                                            <label>No</label>
                                            <x>808.80225</x>
                                            <y>1034.7327</y>
                                            <childList>
                                              <child name="timeoutError" type="exceptActivity">
                                                <element>excp_cwf.timeout</element>
                                                <label>Timeout Error</label>
                                                <x>1318.7877</x>
                                                <y>1427.2119</y>
                                              </child>
                                            </childList>
                                            <methodList>
                                              <method name="cwOnProcActCond" type="action">
                                                <category>cond</category>
                                                <system>true</system>
                                                <script><![CDATA[
                                                  var graniteResponse = processSTC.readGraniteResponseFromDB(this.process.id);

                                                  return (graniteResponse == null);
                                                ]]></script>
                                              </method>
                                            </methodList>
                                          </child>
                                          <child name="yesButLock" type="caseActivity">
                                            <label>Yes But Lock</label>
                                            <x>1087.9877</x>
                                            <y>1408.6309</y>
                                            <childList>
                                              <child name="lockException" type="exceptActivity">
                                                <element>excp_processSTC.lockException</element>
                                                <label>Lock Exception</label>
                                                <x>1382.7876</x>
                                                <y>1548.212</y>
                                              </child>
                                            </childList>
                                            <methodList>
                                              <method name="cwOnProcActCond" type="action">
                                                <category>cond</category>
                                                <system>true</system>
                                                <script><![CDATA[
                                                  var graniteResponse = processSTC.readGraniteResponseFromDB(this.process.id);

                                                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Received SubmitResponse from Granite and checking for lock: " + graniteResponse.toXML());

                                                  var isLock = false;
                                                  if(graniteResponse != null) {
                                                      if(graniteResponse.failure != null && graniteResponse.failure.length > 0) {
                                                          // check number of retries for lock error
                                                          isLock = ds_ws.isLockError(graniteResponse.failure);
                                                      }
                                                  }

                                                  if(isLock) {
                                                      var maxNumberOfRetriesForLock = Global.getConfigVariable("NUM_RETRIES_LOCK", 5);
                                                      if(maxNumberOfRetriesForLock == Number.NAN) {
                                                          maxNumberOfRetriesForLock = 5;
                                                      }
                                                      isLock = (this.process.processDocument.numberOfRetriesForLock < maxNumberOfRetriesForLock);
                                                  }

                                                  if(isLock) {
                                                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - found Lock in Granite response; removing Granite response!");

                                                      // STCSUP-1445: remove the "lock" response to avoid that EOC reprocesses the old response;
                                                      processSTC.deleteGraniteResponseFromDB(this.process.id);

                                                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - found Lock in Granite response; removed Granite response!");
                                                  }


                                                  return isLock;
                                                ]]></script>
                                              </method>
                                            </methodList>
                                          </child>
                                          <child name="yes" type="caseActivity">
                                            <label>Yes</label>
                                            <x>808.80225</x>
                                            <y>1034.7327</y>
                                            <childList>
                                              <child name="checkIfMessageIsReceived" type="scriptActivity">
                                                <label>Check If Message Is Received</label>
                                                <x>1536.788</x>
                                                <y>1417.212</y>
                                                <methodList>
                                                  <method name="cwOnProcActBefore" type="action">
                                                    <category>before</category>
                                                    <system>true</system>
                                                    <script><![CDATA[
                                                      var graniteResponse = processSTC.readGraniteResponseFromDB(this.process.id);

                                                      if(graniteResponse == null) {
                                                          Global.throwException("cwf.timeout");
                                                      }

                                                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - receivedUpdateResponse = " + graniteResponse.toXML());

                                                      var orderAcceptedByGranite = (graniteResponse.failure == null || graniteResponse.failure.length == 0);

                                                      // updates info in lineItem
                                                      this.process.processOrderItem.workOrderNumber = graniteResponse.workOrderNumber;
                                                      this.process.processOrderItem.lineItemStatus = ((orderAcceptedByGranite) ? "READY" : "FAILED");
                                                      this.process.processOrderItem.alreadySentToGranite = orderAcceptedByGranite;
                                                      this.process.processOrderItem.save();

                                                      // updates bundle and orderHeader status
                                                      ds_ws.updateBundleAndOrderHeaderStatus(this.process.processOrder, this.process.processOrderItem);

                                                      // update orchestrationRecord to know if Granite accepted the WorkOrder
                                                      var recordInOrchestrationTable = processSTC.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);
                                                      if(orderAcceptedByGranite) {
                                                          debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - updateOrderForElement = " + this.process.processOrderItem.id + " processed SUCCESSFULLY");
                                                          this.process.processDocument.acceptedByGranite = true;
                                                          // saving result of provisioning process
                                                          recordInOrchestrationTable.provisioningProcessResult = "OK";
                                                      }
                                                      else {
                                                          debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - updateOrderForElement = " + this.process.processOrderItem.id + " REJECTED BY GRANITE!!!!");
                                                          this.process.processDocument.acceptedByGranite = false;
                                                          // saving result of provisioning process; KO ==> block all provisioning processes for such order
                                                          recordInOrchestrationTable.provisioningProcessResult = "KO";

                                                          if(ds_ws.isLockError(graniteResponse.failure)) {
                                                              // it means that the order exceeded the retry attemps and so the orderNumber is stored into the orderLocked table to be re-processed the next day
                                                              processSTC.addOrderToFailedOrdersForLockList(this.process.processOrder.orderHeader.orderNumber);
                                                          }
                                                      }
                                                      recordInOrchestrationTable.save();

                                                      if(!orderAcceptedByGranite) {
                                                          // 2015-09-07: dummy WOSU management for failed order
                                                          var supportDummyWOSU = Global.getConfigVariable("DUMMY_WOSU_FOR_FAILED_ORDER", "FALSE");
                                                          if(supportDummyWOSU == "TRUE") {
                                                              processSTC.generateDummyWOSUForFailedOrderToGranite(this.process.processOrder.orderHeader.orderNumber, this.process.processOrderItem);
                                                          }
                                                      }

                                                      // removing icmsSalesOrderNumber from in Process
                                                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - removing icmsSalesOrderNumber from in Process = " +
                                                                   this.process.processOrder.orderHeader.icmsSalesOrderNumber + "; orderNumber = " + this.process.processOrder.orderHeader.orderNumber);
                                                      ds_ws.removeICMSSONumberFromInProcessList(this.process.processOrder.orderHeader.icmsSalesOrderNumber, this.process.processOrder.orderHeader.orderNumber);
                                                    ]]></script>
                                                  </method>
                                                </methodList>
                                              </child>
                                            </childList>
                                          </child>
                                        </childList>
                                      </child>
                                    </childList>
                                    <methodList>
                                      <method name="cwOnProcActBefore" type="action">
                                        <category>before</category>
                                        <system>true</system>
                                        <script><![CDATA[
                                          this.process.processDocument.rollbackNumber = "4";

                                          this.process.processOrderItem.lineItemStatus = "Waiting for Granite Resp";
                                          this.process.processOrderItem.save();
                                          debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Restarting waiting ...");
                                        ]]></script>
                                      </method>
                                    </methodList>
                                  </child>
                                </childList>
                                <methodList>
                                  <method name="cwOnProcActBefore" type="action">
                                    <category>before</category>
                                    <system>true</system>
                                    <script><![CDATA[this.process.processDocument.rollbackNumber = "3";]]></script>
                                  </method>
                                </methodList>
                              </child>
                            </childList>
                          </child>
                        </childList>
                      </child>
                    </childList>
                  </child>
                  <child name="sendOrderAckToCRM" type="subflowActivity">
                    <element>proc_processSTC.sendOrderAckToCRM</element>
                    <label>Send OrderAck To CRM</label>
                    <x>1594.4938</x>
                    <y>1599.4795</y>
                    <methodList>
                      <method name="cwOnProcActBefore" type="action">
                        <category>before</category>
                        <system>true</system>
                        <script><![CDATA[this.process.processDocument.firstPassOrderAck = "Y";]]></script>
                      </method>
                    </methodList>
                  </child>
                </childList>
              </child>
            </childList>
          </child>
        </childList>
      </child>
      <child name="childOrderAcceptedByGranite" type="switchActivity">
        <label>Child Order Accepted By Granite?</label>
        <x>959.2155</x>
        <y>1616.0015</y>
        <childList>
          <child name="yes" type="caseActivity">
            <label>Yes</label>
            <x>210.50818</x>
            <y>237.0</y>
            <childList>
              <child name="handleGraniteWOSUEvents" type="subflowActivity">
                <element>proc_processSTC.handleGraniteWorkOrderStatusUpdates</element>
                <label>Handle Granite WOSU Events</label>
                <schedule type="sched">
                  <duration type="dur">
                    <methodList>
                      <method name="cwOnDuration" type="action">
                        <system>true</system>
                        <script><![CDATA[
                          // configured time for sleeping
                          var submitSleep = Global.getConfigVariable("SLEEP_BEFORE_WOSU", "10");

                          var isB2BOrder = (this.processOrder != null ? processSTC.isB2BOrder(this.processOrder.orderHeader) : false);

                          var sleepTime = 0;
                          if(isB2BOrder) {
                              sleepTime = submitSleep;
                          }

                          debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.id + "] - sleep before WOSU for : " + sleepTime + " secs");

                          return sleepTime;
                        ]]></script>
                      </method>
                    </methodList>
                  </duration>
                </schedule>
                <x>765.2155</x>
                <y>1610.0015</y>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActCond" type="action">
                <category>cond</category>
                <system>true</system>
                <script><![CDATA[
                  // 2015/09/07: dummy WOSU management
                  // OLD:
                  //    return this.process.processDocument.acceptedByGranite;
                  // NEW:

                  var result = this.process.processDocument.acceptedByGranite;

                  var supportDummyWOSU = Global.getConfigVariable("DUMMY_WOSU_FOR_FAILED_ORDER", "FALSE");
                  if(supportDummyWOSU == "TRUE") {
                      // if support dummy WOSU for Failed Orders, it has to continue
                      result = true;
                  }
                  return result;
                ]]></script>
              </method>
            </methodList>
          </child>
          <child name="no" type="caseActivity">
            <label>No</label>
            <x>963.2156</x>
            <y>1787.0012</y>
          </child>
        </childList>
      </child>
      <child name="sendSignalToWakeUpParent" type="scriptActivity">
        <label>WakeUp &quot;STC Element Orchestration Process&quot;</label>
        <x>749.2155</x>
        <y>1751.0012</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              var orchestrationRecord = processSTC.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);

              /****

              var processInstance = Process.getProcessInfo(orchestrationRecord.orchestrationProcessId);
              if(processInstance != null) {
                  if(processInstance.processStatus == 8) {
                      // the process is in status 8, so STALE; resume it
                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Resuming Stale process " + orchestrationRecord.orchestrationProcessId);
                      Process.resumeAllStaleProcesses(orchestrationRecord.orchestrationProcessId);
                  }
                  else {
                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Process " + orchestrationRecord.orchestrationProcessId + " not in Stale status: " + processInstance.processStatus);
                  }
              }
              else {
                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Unable to find process info for " + orchestrationRecord.orchestrationProcessId);
              }

              ***/

              debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - sending signal 'notifyProvisioningIsCompleted' to orchestration process " + orchestrationRecord.orchestrationProcessId);


              Process.sendSignal("processSTC:notifyProvisioningIsCompleted", orchestrationRecord.orchestrationProcessId);
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="interfaceExcp" type="onExceptionActivity">
        <element>excp_cwf.interfaceExcp</element>
        <label>External interface error</label>
        <x>0.0</x>
        <y>0.0</y>
        <childList>
          <child name="startIntrErr" type="seqActivity">
            <label>Start Interface Error</label>
            <x>560.2628</x>
            <y>364.0013</y>
            <childList>
              <child name="rollbackGrSubmit" type="rollbackActivity">
                <element>proc_processSTC.mainSTCProvisiongProcess_NoParticipant_4/seqActivity_start</element>
                <label>Rollback Granite Submit</label>
                <x>563.4007</x>
                <y>458.76218</y>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[
                      var rb = this.process.processDocument.rollbackNumber;
                      return rb;
                    ]]></script>
                  </method>
                </methodList>
              </child>
              <child name="resumeGraniteSubmit" type="resumeActivity">
                <label>Resume Granite Submit</label>
                <x>564.06866</x>
                <y>584.8657</y>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActBefore" type="action">
                <category>before</category>
                <system>true</system>
                <script><![CDATA[
                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - External Interface Error ...");
                ]]></script>
              </method>
            </methodList>
          </child>
        </childList>
      </child>
      <child name="genericApplError" type="onExceptionActivity">
        <element>excp_processSTC.genericApplicationError</element>
        <label>Generic Application Error</label>
        <x>0.0</x>
        <y>0.0</y>
        <childList>
          <child name="startSrvFaultErr" type="seqActivity">
            <label>Start Service Fault Error</label>
            <x>458.57843</x>
            <y>367.00122</y>
            <childList>
              <child name="rollbackGrSubmit" type="rollbackActivity">
                <label>Rollback Granite Submit</label>
                <x>471.0493</x>
                <y>461.7622</y>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[
                      var rb = this.process.processDocument.rollbackNumber;
                      return rb;
                    ]]></script>
                  </method>
                </methodList>
              </child>
              <child name="resumeGraniteSubmit" type="resumeActivity">
                <label>Resume Granite Submit</label>
                <x>471.71725</x>
                <y>581.8657</y>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActBefore" type="action">
                <category>before</category>
                <system>true</system>
                <script><![CDATA[
                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - External Service fault Error ...");
                ]]></script>
              </method>
            </methodList>
          </child>
        </childList>
      </child>
      <child name="timeout" type="onExceptionActivity">
        <element>excp_cwf.timeout</element>
        <label>Timeout</label>
        <x>0.0</x>
        <y>0.0</y>
        <childList>
          <child name="startTimeoutErr" type="seqActivity">
            <label>Start Timeout Error</label>
            <x>343.90775</x>
            <y>358.00128</y>
            <childList>
              <child name="orderType" type="switchActivity">
                <label>Order Type</label>
                <x>338.37436</x>
                <y>467.46338</y>
                <childList>
                  <child name="submit" type="caseActivity">
                    <label>Submit</label>
                    <x>0.0</x>
                    <y>0.0</y>
                    <childList>
                      <child name="startSubmit" type="seqActivity">
                        <label>Start Submit</label>
                        <x>392.32733</x>
                        <y>595.9175</y>
                        <childList>
                          <child name="rollbackGraniteSubmitRead" type="rollbackActivity">
                            <label>Rollback Granite Submit Read</label>
                            <x>391.72693</x>
                            <y>704.9693</y>
                            <methodList>
                              <method name="cwOnProcActBefore" type="action">
                                <category>before</category>
                                <system>true</system>
                                <script><![CDATA[
                                  var rb = this.process.processDocument.rollbackNumber;
                                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Value read from the processDocument for compensate = " + rb);
                                  return rb;
                                ]]></script>
                              </method>
                            </methodList>
                          </child>
                          <child name="resumeGraniteSubmitRead" type="resumeActivity">
                            <label>Resume Granite Submit Read</label>
                            <x>392.3949</x>
                            <y>845.774</y>
                          </child>
                        </childList>
                      </child>
                    </childList>
                    <methodList>
                      <method name="cwOnProcActCond" type="action">
                        <category>cond</category>
                        <system>true</system>
                        <script><![CDATA[
                          var isSubmit = (this.process.processDocument.isSubmit == "Y");
                          debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - isSubmit = " + isSubmit);

                          return isSubmit;
                        ]]></script>
                      </method>
                    </methodList>
                  </child>
                  <child name="update" type="caseActivity">
                    <label>Update</label>
                    <x>0.0</x>
                    <y>0.0</y>
                    <childList>
                      <child name="startUpdate" type="seqActivity">
                        <label>Start Update</label>
                        <x>297.76877</x>
                        <y>595.9175</y>
                        <childList>
                          <child name="rollbackGraniteUpdateRead" type="rollbackActivity">
                            <label>Rollback Granite Update Read</label>
                            <x>297.70743</x>
                            <y>704.9693</y>
                            <methodList>
                              <method name="cwOnProcActBefore" type="action">
                                <category>before</category>
                                <system>true</system>
                                <script><![CDATA[
                                  var rb = this.process.processDocument.rollbackNumber;
                                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Value read from the processDocument for compensate = " + rb);
                                  return rb;
                                ]]></script>
                              </method>
                            </methodList>
                          </child>
                          <child name="resumeGraniteUpdateRead" type="resumeActivity">
                            <label>Resume Granite Update Read</label>
                            <x>298.3754</x>
                            <y>845.774</y>
                          </child>
                        </childList>
                      </child>
                    </childList>
                  </child>
                </childList>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActBefore" type="action">
                <category>before</category>
                <system>true</system>
                <script><![CDATA[
                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Timeout Error ...");
                ]]></script>
              </method>
            </methodList>
          </child>
        </childList>
      </child>
      <child name="stopProcess" type="onExceptionActivity">
        <element>excp_cwf.stop</element>
        <label>Stop Process</label>
        <x>49.0</x>
        <y>264.0</y>
        <childList>
          <child name="start" type="seqActivity">
            <label>Start</label>
            <x>49.707428</x>
            <y>362.00128</y>
            <childList>
              <child name="stopProvisioningProcess" type="completeActivity">
                <label>Stop Provisioning Process</label>
                <x>39.70742</x>
                <y>463.0013</y>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[
                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Received Stop for this Provisioning process");
                    ]]></script>
                  </method>
                </methodList>
              </child>
            </childList>
          </child>
        </childList>
      </child>
      <child name="onLockException" type="onExceptionActivity">
        <element>excp_processSTC.lockException</element>
        <label>On Lock Exception</label>
        <x>373.69357</x>
        <y>190.8982</y>
        <childList>
          <child name="startLockMgmtErr" type="seqActivity">
            <label>Start Lock Mgmt Error</label>
            <x>170.21541</x>
            <y>362.0013</y>
            <childList>
              <child name="orderType" type="switchActivity">
                <label>Order Type</label>
                <x>170.3744</x>
                <y>475.46338</y>
                <childList>
                  <child name="submit" type="caseActivity">
                    <label>Submit</label>
                    <x>0.0</x>
                    <y>0.0</y>
                    <childList>
                      <child name="startSubmit" type="seqActivity">
                        <label>Start Submit</label>
                        <x>224.32738</x>
                        <y>595.9175</y>
                        <childList>
                          <child name="rollbackGraniteLockError" type="rollbackActivity">
                            <label>Rollback Granite Lock Error</label>
                            <x>219.72696</x>
                            <y>709.9693</y>
                            <methodList>
                              <method name="cwOnProcActBefore" type="action">
                                <category>before</category>
                                <system>true</system>
                                <script><![CDATA[
                                  var rb = "5"; // hardcoded because it's to manage Lock Error
                                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - LOCK - Value returned for compensate = " + rb);
                                  return rb;
                                ]]></script>
                              </method>
                            </methodList>
                          </child>
                          <child name="resumeGraniteLockError" type="resumeActivity">
                            <label>Resume Granite Lock Error</label>
                            <x>219.39494</x>
                            <y>876.7739</y>
                          </child>
                        </childList>
                      </child>
                    </childList>
                    <methodList>
                      <method name="cwOnProcActCond" type="action">
                        <category>cond</category>
                        <system>true</system>
                        <script><![CDATA[
                          var isSubmit = (this.process.processDocument.isSubmit == "Y");
                          debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - LOCK - isSubmit = " + isSubmit);

                          return isSubmit;
                        ]]></script>
                      </method>
                    </methodList>
                  </child>
                  <child name="update" type="caseActivity">
                    <label>Update</label>
                    <x>0.0</x>
                    <y>0.0</y>
                    <childList>
                      <child name="startUpdate" type="seqActivity">
                        <label>Start Update</label>
                        <x>124.76874</x>
                        <y>593.9175</y>
                        <childList>
                          <child name="rollbackGraniteLockError" type="rollbackActivity">
                            <label>Rollback Granite Lock Error</label>
                            <x>120.70744</x>
                            <y>713.9693</y>
                            <methodList>
                              <method name="cwOnProcActBefore" type="action">
                                <category>before</category>
                                <system>true</system>
                                <script><![CDATA[
                                  var rb = "6"; // hardcoded because it's to manage Lock Error
                                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - LOCK - Value returned for compensate = " + rb);
                                  return rb;
                                ]]></script>
                              </method>
                            </methodList>
                          </child>
                          <child name="resumeGraniteLockError" type="resumeActivity">
                            <label>Resume Granite Lock Error</label>
                            <x>120.37538</x>
                            <y>874.7739</y>
                          </child>
                        </childList>
                      </child>
                    </childList>
                  </child>
                </childList>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActBefore" type="action">
                <category>before</category>
                <system>true</system>
                <script><![CDATA[
                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Lock Error ...");
                ]]></script>
              </method>
            </methodList>
          </child>
        </childList>
      </child>
    </childList>
    <methodList>
      <method name="cwOnProcActBefore" type="action">
        <category>before</category>
        <system>true</system>
        <script><![CDATA[
          this.process.processDocument.firstPassSub = "Y";
          this.process.processDocument.firstPassSubRead = "Y";
          this.process.processDocument.countSubRead = 0;
          this.process.processDocument.numberOfRetriesForLock = 0;

          // reset error flag
          this.process.processDocument.errorType = null;

          this.process.processDocument.isSubmit = (this.process.processOrderItem.isSubmit ? "Y" : "N");

          debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Start for element: " + this.process.processOrderItem.id);
        ]]></script>
      </method>
    </methodList>
  </activity>
  <curRevision>true</curRevision>
  <description><![CDATA[
    <p style="margin-top: 0">
      Implements the provisioning of a single element; processOrderItem =
      single element of the order!!!
    </p>
    <p style="margin-top: 0">
      It uses &quot;sendOrderAckToCRM&quot; subflow to send Granite response to CRM.
    </p>
    <p style="margin-top: 0">
      It uses &quot;handleGraniteWOSU&quot; subflow to receive Granite WOSU, update
      orderStatus and forward WOSU to CRM.
    </p>
  ]]></description>
  <document>doc_processSTC.STC_PROCESS_DOCUMENT</document>
  <label>Main STC Provisioning Process - No Participant - 4</label>
  <metaVersion>25</metaVersion>
  <priority>8</priority>
  <revision>35</revision>
  <subflowReferenceList>
    <subflowReference type="sref">
      <revision>14</revision>
      <subflow>proc_processSTC.handleGraniteWorkOrderStatusUpdates</subflow>
    </subflowReference>
    <subflowReference type="sref">
      <revision>6</revision>
      <subflow>proc_processSTC.startSubComp</subflow>
    </subflowReference>
    <subflowReference type="sref">
      <revision>12</revision>
      <subflow>proc_processSTC.startSubReadComp</subflow>
    </subflowReference>
    <subflowReference type="sref">
      <revision>13</revision>
      <subflow>proc_processSTC.sendOrderAckToCRM</subflow>
    </subflowReference>
    <subflowReference type="sref">
      <revision>6</revision>
      <subflow>proc_processSTC.lockManagementCompensation</subflow>
    </subflowReference>
  </subflowReferenceList>
  <type>User</type>
</process>