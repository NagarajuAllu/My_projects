<?xml version="1.0" encoding="UTF-8" ?>
<process name="processSTC.mainSTCProvisiongProcess_BlackListed">
  <activity name="start" type="seqActivity">
    <label>Start</label>
    <x>50.50818</x>
    <y>51.0</y>
    <childList>
      <child name="startGenerateBlackListedMessages" type="seqActivity">
        <label>Start Generate BlackListed Messages</label>
        <x>145.48608</x>
        <y>50.9162</y>
        <childList>
          <child name="generateBlackListedOrderAck" type="scriptActivity">
            <label>Generate OrderAck - BlackListed</label>
            <x>265.48608</x>
            <y>36.9162</y>
            <methodList>
              <method name="cwOnProcActBefore" type="action">
                <category>before</category>
                <system>true</system>
                <script><![CDATA[
                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - generating orderACK for BlackList for serviceNumber " + this.process.processOrderItem.serviceNumber);

                  var bundleOrder = this.process.processOrder;
                  var processItem = this.process.processOrderItem;

                  processSTC.generateOrderAck_BlackListed(bundleOrder.orderHeader.orderNumber,
                                                          processItem.workOrderNumber,
                                                          processItem.lineItemIdentifier,
                                                          this.process.id);

                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - generated orderACK for BlackList for serviceNumber " + this.process.processOrderItem.serviceNumber);
                ]]></script>
              </method>
            </methodList>
          </child>
          <child name="generateBlackListedInitialWOSU" type="scriptActivity">
            <label>Generate Initial WOSU - BlackListed</label>
            <x>388.48608</x>
            <y>34.9162</y>
            <methodList>
              <method name="cwOnProcActBefore" type="action">
                <category>before</category>
                <system>true</system>
                <script><![CDATA[
                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - generating 'READY' WOSU for BlackList for serviceNumber " + this.process.processOrderItem.serviceNumber);

                  var bundleOrder = this.process.processOrder;
                  var processItem = this.process.processOrderItem;

                  var jmsWOSU = processSTC.generateWOSU_BlackListed(bundleOrder.orderHeader.orderNumber,
                                                                    processItem.workOrderNumber,
                                                                    processItem.serviceNumber,
                                                                    "READY",
                                                                    processItem.locationACCLICode,
                                                                    processItem.locationBCCLICode);

                  ifGranite_jms.manageGraniteMsg_WorkOrderStatusUpdate(jmsWOSU);

                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - generated 'READY' WOSU for BlackList for serviceNumber " + this.process.processOrderItem.serviceNumber);
                ]]></script>
              </method>
            </methodList>
          </child>
          <child name="generateBlackListedCompletionWOSU" type="scriptActivity">
            <label>Generate Completion WOSU - BlackListed</label>
            <x>495.48608</x>
            <y>34.9162</y>
            <methodList>
              <method name="cwOnProcActBefore" type="action">
                <category>before</category>
                <system>true</system>
                <script><![CDATA[
                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - generating COMPLETION WOSU for BlackList for serviceNumber " + this.process.processOrderItem.serviceNumber);

                  var bundleOrder = this.process.processOrder;
                  var processItem = this.process.processOrderItem;

                  var jmsWOSU = processSTC.generateWOSU_BlackListed(bundleOrder.orderHeader.orderNumber,
                                                                    processItem.workOrderNumber,
                                                                    processItem.serviceNumber,
                                                                    "COMPLETED",
                                                                    processItem.locationACCLICode,
                                                                    processItem.locationBCCLICode);

                  ifGranite_jms.manageGraniteMsg_WorkOrderStatusUpdate(jmsWOSU);

                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - generated COMPLETION WOSU for BlackList for serviceNumber " + this.process.processOrderItem.serviceNumber);
                ]]></script>
              </method>
            </methodList>
          </child>
        </childList>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              var orderItem = this.process.processOrderItem;

              var workOrderType = processSTC.getWorkOrderType(this.process.processOrder.orderHeader.orderType, orderItem.action);

              if(orderItem.workOrderNumber == null) {
                  var workOrderNumber = processSTC.generateWONumber(orderItem, workOrderType, this.process.processOrder); // processSTC.getNewChildOrderNumber(workOrderType);
                  if(workOrderNumber == null) {
                      Global.throwException("Error in generating workOrderNumber");
                  }
                  orderItem.workOrderNumber = workOrderNumber;
                  orderItem.save();
              }
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="processOrderAckMsgReceived" type="scriptActivity">
        <label>Process OrderAck Message Received</label>
        <x>500.80225</x>
        <y>202.73267</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              var graniteResponse = processSTC.readGraniteResponseFromDB(this.process.id);

              debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - receivedSubmitResponse = " + graniteResponse.toXML());


              var orderAcceptedByGranite = (graniteResponse.failure == null || graniteResponse.failure.length == 0);

              // updates info in lineItem
              this.process.processOrderItem.workOrderNumber = graniteResponse.workOrderNumber;
              this.process.processOrderItem.lineItemStatus = ((orderAcceptedByGranite) ? "READY" : "FAILED");
              this.process.processOrderItem.alreadySentToGranite = orderAcceptedByGranite;
              this.process.processOrderItem.sentAnytimeToGranite = (orderAcceptedByGranite || this.process.processOrderItem.sentAnytimeToGranite);
              this.process.processOrderItem.save();

              // updates bundle and orderHeader status
              ds_ws.updateBundleAndOrderHeaderStatus(this.process.processOrder, this.process.processOrderItem);

              // update orchestrationRecord to know if Granite accepted the WorkOrder
              var recordInOrchestrationTable = processSTC.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);
              if(orderAcceptedByGranite) {
                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - submitOrderForElement = " + this.process.processOrderItem.id + " processed SUCCESSFULLY");
                  this.process.processDocument.acceptedByGranite = true;
                  // saving result of provisioning process
                  recordInOrchestrationTable.provisioningProcessResult = "OK";
              }
              else {
                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - submitOrderForElement = " + this.process.processOrderItem.id + " REJECTED BY GRANITE!!!!");
                  this.process.processDocument.acceptedByGranite = false;
                  // saving result of provisioning process; KO ==> block all provisioning processes for such order
                  recordInOrchestrationTable.provisioningProcessResult = "KO";
              }
              recordInOrchestrationTable.save();

              if(!orderAcceptedByGranite) {
                  // 2015-09-07: dummy WOSU management for failed order
                  var supportDummyWOSU = Global.getConfigVariable("DUMMY_WOSU_FOR_FAILED_ORDER", "FALSE");
                  if(supportDummyWOSU == "TRUE") {
                      processSTC.generateDummyWOSUForFailedOrderToGranite(this.process.processOrder.orderHeader.orderNumber, this.process.processOrderItem);
                  }
              }
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="sendOrderAckToCRM" type="subflowActivity">
        <element>proc_processSTC.sendOrderAckToCRM</element>
        <label>Send OrderAck To CRM</label>
        <x>698.5082</x>
        <y>204.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[this.process.processDocument.firstPassOrderAck = "Y";]]></script>
          </method>
        </methodList>
      </child>
      <child name="childOrderAcceptedByGranite" type="switchActivity">
        <label>Child Order Accepted By Granite?</label>
        <x>691.5082</x>
        <y>384.0</y>
        <childList>
          <child name="yes" type="caseActivity">
            <label>Yes</label>
            <x>210.50818</x>
            <y>237.0</y>
            <childList>
              <child name="handleGraniteWOSUEvents" type="subflowActivity">
                <element>proc_processSTC.handleGraniteWorkOrderStatusUpdates</element>
                <label>Handle Granite WOSU Events</label>
                <x>545.5082</x>
                <y>375.0</y>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActCond" type="action">
                <category>cond</category>
                <system>true</system>
                <script><![CDATA[
                  // 2015/09/07: dummy WOSU management
                  // OLD:
                  //    return this.process.processDocument.acceptedByGranite;
                  // NEW:

                  var result = this.process.processDocument.acceptedByGranite;

                  var supportDummyWOSU = Global.getConfigVariable("DUMMY_WOSU_FOR_FAILED_ORDER", "FALSE");
                  if(supportDummyWOSU == "TRUE") {
                      // if support dummy WOSU for Failed Orders, it has to continue
                      result = true;
                  }
                  return result;
                ]]></script>
              </method>
            </methodList>
          </child>
          <child name="no" type="caseActivity">
            <label>No</label>
            <x>707.5082</x>
            <y>543.0</y>
          </child>
        </childList>
      </child>
      <child name="sendSignalToWakeUpParent" type="scriptActivity">
        <label>WakeUp &quot;STC Element Orchestration Process&quot;</label>
        <x>529.5082</x>
        <y>517.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Completed 'BlackListed' Process for element: " + this.process.processOrderItem.id);

              var orchestrationRecord = processSTC.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);

              debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - sending signal 'notifyProvisioningIsCompleted' to orchestration process " + orchestrationRecord.orchestrationProcessId);

              Process.sendSignal("processSTC:notifyProvisioningIsCompleted", orchestrationRecord.orchestrationProcessId);
            ]]></script>
          </method>
        </methodList>
      </child>
    </childList>
    <methodList>
      <method name="cwOnProcActBefore" type="action">
        <category>before</category>
        <system>true</system>
        <script><![CDATA[
          this.process.processDocument.firstPassSub = "Y";
          this.process.processDocument.firstPassSubRead = "Y";
          this.process.processDocument.countSubRead = 0;

          // reset error flag
          this.process.processDocument.errorType = null;

          this.process.processDocument.isSubmit = (this.process.processOrderItem.isSubmit ? "Y" : "N");

          debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Start 'BlackListed' Process for element: " + this.process.processOrderItem.id);
        ]]></script>
      </method>
    </methodList>
  </activity>
  <curRevision>true</curRevision>
  <description><![CDATA[
    <p style="margin-top: 0">
      Provisioning process for blackListed services... doesn't push the order
      into Granite but auto-generate orderAck, initial WOSU and completion WOSU
    </p>
  ]]></description>
  <document>doc_processSTC.STC_PROCESS_DOCUMENT</document>
  <label>Main STC Provisioning Process - BlackListed</label>
  <metaVersion>25</metaVersion>
  <priority>8</priority>
  <revision>35</revision>
  <subflowReferenceList>
    <subflowReference type="sref">
      <revision>14</revision>
      <subflow>proc_processSTC.handleGraniteWorkOrderStatusUpdates</subflow>
    </subflowReference>
    <subflowReference type="sref">
      <revision>13</revision>
      <subflow>proc_processSTC.sendOrderAckToCRM</subflow>
    </subflowReference>
  </subflowReferenceList>
  <type>User</type>
</process>