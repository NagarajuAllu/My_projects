<?xml version="1.0" encoding="UTF-8" ?>
<script name="processSTC.generateCompletionWOSUForLineItem">
  <label>Generate Completion WOSU For LineItem</label>
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="inputLineItem" type="rifp">
      <type>doc_ds_ws.lineItemDocument</type>
    </parameter>
    <parameter name="bundleOrder" type="rifp">
      <type>order_ds_ws.bundleOrderSTC</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var debug = " generateCompletionWOSUForLineItem - ";

    if(inputLineItem == null || bundleOrder == null) {

    debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "GRAVE ERROR: one of the input parameter is null: lineItem = " +
                 (inputLineItem != null ? inputLineItem.lineItemIdentifier : "NULL") + "; order = " + (bundleOrder != null ? bundleOrder.orderHeader.orderNumber : "NULL"));

        return;
    }

    var serviceNumber = inputLineItem.serviceNumber;
    var elementTypeInOrderTree = inputLineItem.elementTypeInOrderTree;
    var woName = inputLineItem.workOrderNumber;
    var elementStatus = null;

    if(elementTypeInOrderTree == 'B' || elementTypeInOrderTree == 'C') {
        // the lineItem is represented in Granite as a Path
        var path = granite.getPathInGranite(serviceNumber);

        if(path != null) {
            elementStatus = path.STATUS;
            if(woName == null) {
                woName = granite.getWONameForPath(path.CIRC_PATH_INST_ID);
            }
        }
    }
    else {
        var resource = granite.getResourceInGranite(serviceNumber);

        if(resource != null) {
            elementStatus = resource.STATUS;
            if(woName == null) {
                woName = granite.getWONameForResource(path.RESOURCE_INST_ID);
            }
        }
    }

    if(woName == null) {
        // trying to get it from active version of the service
        var activeParentLineItem = ds_ws.getLineItemByServiceNumberAndLIIdAndProvFlag(null, bundleOrder.bundles[0].bundle.lineItemIdentifier, "ACTIVE");
        if(activeParentLineItem != null) {
            var parentLineItemInActiveBundle = ds_ws.getLineItemInBundleWithIdentifier(activeParentLineItem, inputLineItem.lineItemIdentifier);
            if(parentLineItemInActiveBundle != null) {
                woName = parentLineItemInActiveBundle.workOrderNumber;
            }
        }
    }

    // it generates the last WOSU for the lineItem
    var wosuEvent = new DataStructure("ds_jms.workOrderStatusUpdate_el");
    wosuEvent.workOrderNumber = woName;
    wosuEvent.crmOrderNumber = bundleOrder.orderHeader.orderNumber;
    wosuEvent.serviceNumber = serviceNumber;
    wosuEvent.businessUnit = bundleOrder.orderHeader.businessUnit;
    wosuEvent.workOrderStatus =  "COMPLETED";
    wosuEvent.serviceStatus = elementStatus;

    wosuEvent.taskName = "no-info";
    wosuEvent.taskNumber = -1;
    wosuEvent.taskOperation = "no-info";
    wosuEvent.taskStatusCode = -1;

    debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "generated Completion WOSU: " + wosuEvent.toXML());


    var wosuID = processSTC.writeWOSUIntoDB("-2", wosuEvent);

    var wosuProcessDocument = new Document("processSTC.STC_PROCESS_DOCUMENT");
    wosuProcessDocument.latestWOSUId = wosuID;
    wosuProcessDocument.firstPassWOSU = "Y";
    wosuProcessDocument.lineItemId = inputLineItem.id;

    var wosuPID = Process.startProcess("processSTC.sendWOSUToCRM", wosuProcessDocument);
  ]]></script>
</script>