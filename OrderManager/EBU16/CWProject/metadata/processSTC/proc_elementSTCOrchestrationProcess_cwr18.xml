<?xml version="1.0" encoding="UTF-8" ?>
<process name="processSTC.elementSTCOrchestrationProcess_cwr18">
  <activity name="start" type="seqActivity">
    <label>Start</label>
    <x>22.0</x>
    <y>31.0</y>
    <childList>
      <child name="setProcessIdInOrchestrationTable" type="scriptActivity">
        <label>Set Process Id In Orchestration Table</label>
        <x>118.0</x>
        <y>16.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              var recordInOrchestrationTable = processSTC.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);
              recordInOrchestrationTable.orchestrationProcessId = this.process.id;
              recordInOrchestrationTable.save();
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="isActionDeleteOrSuspend" type="switchActivity">
        <label>Is Action = &quot;Delete&quot; or &quot;Suspend&quot;?</label>
        <x>123.0</x>
        <y>179.0</y>
        <childList>
          <child name="deleteOrSuspend" type="caseActivity">
            <label>Delete or Suspend Action</label>
            <x>35.0</x>
            <y>342.0</y>
            <childList>
              <child name="startDelete_Suspend" type="seqActivity">
                <label>Start Workflow for Delete or Suspend</label>
                <x>120.0</x>
                <y>523.0</y>
                <childList>
                  <child name="hasChildElements" type="switchActivity">
                    <label>Has Child Elements?</label>
                    <x>285.0</x>
                    <y>517.0</y>
                    <childList>
                      <child name="yes" type="caseActivity">
                        <label>Yes</label>
                        <x>120.0</x>
                        <y>608.0</y>
                        <childList>
                          <child name="start" type="seqActivity">
                            <label>Start</label>
                            <x>291.0</x>
                            <y>667.0</y>
                            <childList>
                              <child name="performProvisioningOfAllChildElements_Delete" type="subflowActivity">
                                <element>proc_processSTC.performProvisioningOfAllChildElements_Delete</element>
                                <label>Perform Provisioning Of All Child Elements - Delete_Suspend</label>
                                <x>596.0</x>
                                <y>630.0</y>
                                <methodList>
                                  <method name="cwOnProcActBefore" type="action">
                                    <category>before</category>
                                    <system>true</system>
                                    <script><![CDATA[
                                      var elementTypeInOrderTree = this.process.processOrderItem.elementTypeInOrderTree;
                                      if(elementTypeInOrderTree == "B") {
                                          this.process.processDocument.elementTypeInOrderTree = "C";
                                      }
                                      else if(elementTypeInOrderTree == "C") {
                                          this.process.processDocument.elementTypeInOrderTree = "S";
                                      }
                                      else if(elementTypeInOrderTree == "S") {
                                          this.process.processDocument.elementTypeInOrderTree = "T";
                                      }

                                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - starting OrchestrationWorkflowForChildElement with ElementType = " + this.process.processDocument.elementTypeInOrderTree);
                                    ]]></script>
                                  </method>
                                </methodList>
                              </child>
                            </childList>
                          </child>
                        </childList>
                        <methodList>
                          <method name="cwOnProcActCond" type="action">
                            <category>cond</category>
                            <system>true</system>
                            <script><![CDATA[
                              var childElementsList = processSTC.findRecordsInOrchTabByOrderId_ParentId(this.process.processOrder.id, this.process.processOrderItem.id);

                              debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - childElementsList.length= " + childElementsList.length);

                              return (childElementsList != null && childElementsList.length > 0);
                            ]]></script>
                          </method>
                        </methodList>
                      </child>
                      <child name="no" type="caseActivity">
                        <label>No</label>
                        <x>446.0</x>
                        <y>531.0</y>
                      </child>
                    </childList>
                  </child>
                  <child name="isElementProvisionable" type="switchActivity">
                    <label>isElementProvisionable</label>
                    <x>566.0</x>
                    <y>531.0</y>
                    <childList>
                      <child name="yes" type="caseActivity">
                        <label>Yes</label>
                        <x>253.0</x>
                        <y>361.0</y>
                        <childList>
                          <child name="start" type="seqActivity">
                            <label>Start</label>
                            <x>738.0</x>
                            <y>531.0</y>
                            <childList>
                              <child name="existProcessKOInOrchestration" type="switchActivity">
                                <label>Is There Process KO In Orchestration?</label>
                                <x>851.0</x>
                                <y>508.0</y>
                                <childList>
                                  <child name="yes" type="caseActivity">
                                    <label>Yes</label>
                                    <x>777.0</x>
                                    <y>733.0</y>
                                    <childList>
                                      <child name="skipParentDueToProcessKO" type="scriptActivity">
                                        <label>Skip Parent Due To Process KO</label>
                                        <x>1129.0</x>
                                        <y>508.0</y>
                                        <methodList>
                                          <method name="cwOnProcActBefore" type="action">
                                            <category>before</category>
                                            <system>true</system>
                                            <script><![CDATA[
                                              debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - startingProvisioningProcessForElement: Found at least one process completed with KO, so skipping children");
                                            ]]></script>
                                          </method>
                                        </methodList>
                                      </child>
                                    </childList>
                                    <methodList>
                                      <method name="cwOnProcActCond" type="action">
                                        <category>cond</category>
                                        <system>true</system>
                                        <script><![CDATA[
                                          return processSTC.checkIfExistProcessKOInOrchestrationTable(this.process.processOrder.id);
                                        ]]></script>
                                      </method>
                                    </methodList>
                                  </child>
                                  <child name="no" type="caseActivity">
                                    <label>No</label>
                                    <x>777.0</x>
                                    <y>733.0</y>
                                    <childList>
                                      <child name="start" type="seqActivity">
                                        <label>Start</label>
                                        <x>868.0</x>
                                        <y>683.0</y>
                                        <childList>
                                          <child name="startProvisioningProcessForElement" type="scriptActivity">
                                            <label>Start Provisioning Process For Element</label>
                                            <x>1034.0</x>
                                            <y>645.0</y>
                                            <methodList>
                                              <method name="cwOnProcActBefore" type="action">
                                                <category>before</category>
                                                <system>true</system>
                                                <script><![CDATA[
                                                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - startingProvisioningProcessForElement: " + this.process.processOrderItem.id);

                                                  var pid = Process.startProcess("processSTC:mainSTCProvisiongProcess", this.process.processOrder.id, this.process.processOrderItem.id);
                                                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - startedProvisioningProcess: " + pid + "; element: " + this.process.processOrderItem.id);

                                                  var recordInOrchestrationTable = processSTC.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);
                                                  recordInOrchestrationTable.provisioningProcessId = pid;
                                                  recordInOrchestrationTable.save();


                                                  // Process.sendSignal("processSTC:notifyProvisioningIsCompleted", this.process.id);
                                                ]]></script>
                                              </method>
                                            </methodList>
                                          </child>
                                          <child name="waitForProvisioningCompleted" type="syncActivity">
                                            <element>signal_processSTC.notifyProvisioningIsCompleted</element>
                                            <label>Wait For Provisioning Completed</label>
                                            <x>1223.0</x>
                                            <y>662.0</y>
                                            <methodList>
                                              <method name="cwOnProcActAfter" type="action">
                                                <category>script</category>
                                                <system>true</system>
                                                <script><![CDATA[
                                                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - provisioningProcessForElement " + this.process.processOrderItem.id + " - Completed!");
                                                ]]></script>
                                              </method>
                                            </methodList>
                                          </child>
                                        </childList>
                                      </child>
                                    </childList>
                                  </child>
                                </childList>
                              </child>
                            </childList>
                          </child>
                        </childList>
                        <methodList>
                          <method name="cwOnProcActCond" type="action">
                            <category>cond</category>
                            <system>true</system>
                            <script><![CDATA[
                              var recordInOrchestrationTable = processSTC.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);

                              return (recordInOrchestrationTable.provisionable);
                            ]]></script>
                          </method>
                        </methodList>
                      </child>
                      <child name="no" type="caseActivity">
                        <label>No</label>
                        <x>1103.0</x>
                        <y>403.0</y>
                      </child>
                    </childList>
                  </child>
                </childList>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActCond" type="action">
                <category>cond</category>
                <system>true</system>
                <script><![CDATA[
                  var element = this.process.processOrderItem;
                  var order = this.process.processOrder;
                  var isDeleteOrSuspend = null;
                  var scanMode = order.bundles[0].bundle.scanMode;

                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - ScanMode for isDeleteOrSuspend: " + scanMode);

                  // Remove = D; Suspend = S
                  if(element.action == "D" || element.action == "A"){
                      isDeleteOrSuspend = (element.action == "D" || element.action == "S");
                  }
                  else {
                      if(scanMode == "default" || scanMode == null){
                          isDeleteOrSuspend = (element.action == "D" || element.action == "S");
                      }
                      else {
                          if(scanMode == "TopDown") {
                              isDeleteOrSuspend = false;
                          }
                          else if(scanMode == "BottomUp") {
                                  isDeleteOrSuspend = true;
                               }

                      }
                  }

                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - isDeleteOrSuspend " + isDeleteOrSuspend);

                  return isDeleteOrSuspend;
                ]]></script>
              </method>
            </methodList>
          </child>
          <child name="notDeleteOrSuspend" type="caseActivity">
            <label>Not Delete Or Suspend Action</label>
            <x>231.0</x>
            <y>77.0</y>
            <childList>
              <child name="startNormalProcessing" type="seqActivity">
                <label>Start Normal Processing</label>
                <x>253.0</x>
                <y>186.0</y>
                <childList>
                  <child name="isElementProvisionable" type="switchActivity">
                    <label>isElementProvisionable</label>
                    <x>353.0</x>
                    <y>185.0</y>
                    <childList>
                      <child name="yes" type="caseActivity">
                        <label>Yes</label>
                        <x>253.0</x>
                        <y>361.0</y>
                        <childList>
                          <child name="start" type="seqActivity">
                            <label>Start</label>
                            <x>393.0</x>
                            <y>28.0</y>
                            <childList>
                              <child name="startProvisioningProcessForElement" type="scriptActivity">
                                <label>Start Provisioning Process For Element</label>
                                <x>517.0</x>
                                <y>3.0</y>
                                <methodList>
                                  <method name="cwOnProcActBefore" type="action">
                                    <category>before</category>
                                    <system>true</system>
                                    <script><![CDATA[
                                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - startingProvisioningProcessForElement: " + this.process.processOrderItem.id);

                                      var pid = Process.startProcess("processSTC:mainSTCProvisiongProcess", this.process.processOrder.id, this.process.processOrderItem.id);
                                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - startedProvisioningProcess: " + pid + "; element: " + this.process.processOrderItem.id);

                                      var recordInOrchestrationTable = processSTC.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);
                                      recordInOrchestrationTable.provisioningProcessId = pid;
                                      recordInOrchestrationTable.save();


                                      // Process.sendSignal("processSTC:notifyProvisioningIsCompleted", this.process.id);
                                    ]]></script>
                                  </method>
                                </methodList>
                              </child>
                              <child name="waitForProvisioningCompleted" type="syncActivity">
                                <element>signal_processSTC.notifyProvisioningIsCompleted</element>
                                <label>Wait For Provisioning Completed</label>
                                <x>706.0</x>
                                <y>10.0</y>
                                <methodList>
                                  <method name="cwOnProcActAfter" type="action">
                                    <category>script</category>
                                    <system>true</system>
                                    <script><![CDATA[
                                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - provisioningProcessForElement " + this.process.processOrderItem.id + " - Completed!");
                                    ]]></script>
                                  </method>
                                </methodList>
                              </child>
                            </childList>
                          </child>
                        </childList>
                        <methodList>
                          <method name="cwOnProcActCond" type="action">
                            <category>cond</category>
                            <system>true</system>
                            <script><![CDATA[
                              var recordInOrchestrationTable = processSTC.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);

                              return (recordInOrchestrationTable.provisionable);
                            ]]></script>
                          </method>
                        </methodList>
                      </child>
                      <child name="no" type="caseActivity">
                        <label>No</label>
                        <x>550.0</x>
                        <y>185.0</y>
                      </child>
                    </childList>
                  </child>
                  <child name="existProcessKOInOrchestration" type="switchActivity">
                    <label>Is There Process KO In Orchestration?</label>
                    <x>714.0</x>
                    <y>175.0</y>
                    <childList>
                      <child name="yes" type="caseActivity">
                        <label>Yes</label>
                        <x>253.0</x>
                        <y>386.0</y>
                        <childList>
                          <child name="skipChildrenDueToProcessKO" type="scriptActivity">
                            <label>Skip Children Due To Process KO</label>
                            <x>907.0</x>
                            <y>7.0</y>
                            <methodList>
                              <method name="cwOnProcActBefore" type="action">
                                <category>before</category>
                                <system>true</system>
                                <script><![CDATA[
                                  debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - startingProvisioningProcessForElement: Found at least one process completed with KO, so skipping children");
                                ]]></script>
                              </method>
                            </methodList>
                          </child>
                        </childList>
                        <methodList>
                          <method name="cwOnProcActCond" type="action">
                            <category>cond</category>
                            <system>true</system>
                            <script><![CDATA[
                              return processSTC.checkIfExistProcessKOInOrchestrationTable(this.process.processOrder.id);
                            ]]></script>
                          </method>
                        </methodList>
                      </child>
                      <child name="no" type="caseActivity">
                        <label>No</label>
                        <x>253.0</x>
                        <y>386.0</y>
                        <childList>
                          <child name="hasChildElements" type="switchActivity">
                            <label>Has Child Elements?</label>
                            <x>876.0</x>
                            <y>178.0</y>
                            <childList>
                              <child name="yes" type="caseActivity">
                                <label>Yes</label>
                                <x>253.0</x>
                                <y>386.0</y>
                                <childList>
                                  <child name="start" type="seqActivity">
                                    <label>Start</label>
                                    <x>882.0</x>
                                    <y>346.0</y>
                                    <childList>
                                      <child name="performProvisioningOfAllChildElements_NoDelete" type="subflowActivity">
                                        <element>proc_processSTC.performProvisioningOfAllChildElements_NotDelete</element>
                                        <label>Perform Provisioning Of All Child Elements - No Delete_Suspend</label>
                                        <x>1009.0</x>
                                        <y>314.0</y>
                                        <methodList>
                                          <method name="cwOnProcActBefore" type="action">
                                            <category>before</category>
                                            <system>true</system>
                                            <script><![CDATA[
                                              var elementTypeInOrderTree = this.process.processOrderItem.elementTypeInOrderTree;
                                              if(elementTypeInOrderTree == "B") {
                                                  this.process.processDocument.elementTypeInOrderTree = "C";
                                              }
                                              else if(elementTypeInOrderTree == "C") {
                                                  this.process.processDocument.elementTypeInOrderTree = "S";
                                              }
                                              else if(elementTypeInOrderTree == "S") {
                                                  this.process.processDocument.elementTypeInOrderTree = "T";
                                              }

                                              debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - starting OrchestrationWorkflowForChildElement with ElementType = " + this.process.processDocument.elementTypeInOrderTree);
                                            ]]></script>
                                          </method>
                                        </methodList>
                                      </child>
                                    </childList>
                                  </child>
                                </childList>
                                <methodList>
                                  <method name="cwOnProcActCond" type="action">
                                    <category>cond</category>
                                    <system>true</system>
                                    <script><![CDATA[
                                      var childElementsList = processSTC.findRecordsInOrchTabByOrderId_ParentId(this.process.processOrder.id, this.process.processOrderItem.id);

                                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - childElementsList.length= " + childElementsList.length);

                                      return (childElementsList != null && childElementsList.length > 0);
                                    ]]></script>
                                  </method>
                                </methodList>
                              </child>
                              <child name="no" type="caseActivity">
                                <label>No</label>
                                <x>1019.0</x>
                                <y>183.0</y>
                              </child>
                            </childList>
                          </child>
                        </childList>
                      </child>
                    </childList>
                  </child>
                </childList>
              </child>
            </childList>
          </child>
        </childList>
      </child>
      <child name="sendWakeUpToParentProcess" type="scriptActivity">
        <label>Send WakeUp To Parent Process</label>
        <x>1122.0</x>
        <y>159.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              // it has to return the id of the parent process
              var recordInOrchestrationTable = processSTC.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);
              var recordForParentElementInOrchestrationTable = processSTC.getRecordInOrchestrationTableByLineItemId(recordInOrchestrationTable.cwParentObjectId);

              debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - SendWakeUp; parentProcessId " + recordForParentElementInOrchestrationTable.orchestrationProcessId);

              Process.sendSignal("processSTC:wakeUpParentInOrchestration", recordForParentElementInOrchestrationTable.orchestrationProcessId);
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="end" type="completeActivity">
        <label>End</label>
        <x>1260.0</x>
        <y>185.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Completed OrchestrationWorkflow for element " + this.process.processOrderItem.id);
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="stopProcess" type="onExceptionActivity">
        <element>excp_cwf.stop</element>
        <label>Stop Process</label>
        <x>49.0</x>
        <y>264.0</y>
        <childList>
          <child name="start" type="seqActivity">
            <label>Start</label>
            <x>22.0</x>
            <y>191.0</y>
            <childList>
              <child name="stopOrchestrationProcess" type="completeActivity">
                <label>Stop Orchestration Process</label>
                <x>8.0</x>
                <y>306.0</y>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[
                      debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Received Stop for this Orchestration process");
                    ]]></script>
                  </method>
                </methodList>
              </child>
            </childList>
          </child>
        </childList>
      </child>
    </childList>
    <methodList>
      <method name="cwOnProcActBefore" type="action">
        <category>before</category>
        <system>true</system>
        <script><![CDATA[
          debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - Starting OrchestrationWorkflow for element " + this.process.processOrderItem.id);
        ]]></script>
      </method>
    </methodList>
  </activity>
  <curRevision>true</curRevision>
  <description><![CDATA[
    <p style="margin-top: 0">
      Responsible of single element orchestration and its child elements;
      processOrderItem = element to be provisioned!!!
    </p>
    <p style="margin-top: 0">
      It uses the 2 following sub-flows to orchestrate the provisioning of the
      child elements:
    </p>
    <p style="margin-top: 0">
      - performProvisioningOfAllChildElements_NotDelete
    </p>
    <p style="margin-top: 0">
      - performProvisioningOfAllChildElements_Delete
    </p>
  ]]></description>
  <document>doc_processSTC.stcOrchestrationProcessDocument</document>
  <label>STC Element Orchestration Process</label>
  <metaVersion>23</metaVersion>
  <priority>8</priority>
  <revision>18</revision>
  <subflowReferenceList>
    <subflowReference type="sref">
      <revision>1</revision>
      <subflow>proc_processSTC.performProvisioningOfAllChildElements_Delete</subflow>
    </subflowReference>
    <subflowReference type="sref">
      <revision>1</revision>
      <subflow>proc_processSTC.performProvisioningOfAllChildElements_NotDelete</subflow>
    </subflowReference>
  </subflowReferenceList>
  <type>User</type>
</process>