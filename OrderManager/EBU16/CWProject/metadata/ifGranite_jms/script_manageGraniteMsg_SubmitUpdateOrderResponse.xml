<?xml version="1.0" encoding="UTF-8" ?>
<script name="ifGranite_jms.manageGraniteMsg_SubmitUpdateOrderResponse">
  <label>Manage Granite Message: Submit/Update Order Response [JMS]</label>
  <metaVersion>3</metaVersion>
  <parameterList>
    <parameter name="input" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var debug = "[MANAGE GRANITE MESSAGE VIA 'JMS': SUBMIT/UPDATE ORDER RESPONSE] ";

    debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "Received: " + (input != null ? input.toXML() : "'NULL'") + "...");

    var logDoc = UserProfile.getMsgLogDoc();

    if (input != null) {
        if(input.workOrderNumber != null && input.crmOrderNumber != null) {

            var lineItem = ds_ws.searchLineItemByCRMOrderNumberAndWONumber(input.crmOrderNumber, input.workOrderNumber);

            if(lineItem != null) {
                var orchestrationRecord = processSTC.getRecordInOrchestrationTableByLineItemId(lineItem.id);
                if(orchestrationRecord != null) {
                    var provisioningProcessId = orchestrationRecord.provisioningProcessId;
                    var sendMessage = true;

                    var processInstance = Process.getProcessInfo(provisioningProcessId);
                    if(processInstance != null) {
                        if(processInstance.metadataTypeName == "processSTC.mainSTCProvisiongProcess_NoParticipant" ||
                           processInstance.metadataTypeName == "processSTC.mainSTCProvisiongProcess_NoParticipant_2" ||
                           processInstance.metadataTypeName == "processSTC.mainSTCProvisiongProcess_NoParticipant_3" ||
                           processInstance.metadataTypeName == "processSTC.mainSTCProvisiongProcess_NoParticipant_4") {
                            sendMessage = false;
                        }
                    }

                    var processDocument = Process.getProcessDocument(provisioningProcessId);
                    if(processDocument != null) {
                        if(processDocument.isSubmit == "Y") {
                            debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + (sendMessage ? "Sending Message" : "Writing Event") + " SubmitOrderResponse for <" + input.crmOrderNumber + "," + input.workOrderNumber + "> to process " + provisioningProcessId);
                            if(sendMessage) {
                                Process.sendMessageToProcess(provisioningProcessId, null, "ifGranite_jms.XngServicesNotificationToProcesses/SubmitOrder", input);
                            }
                            else {
                                processSTC.writeGraniteResponseIntoDB(provisioningProcessId, input);
                            }
                        }
                        else {
                            debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + (sendMessage ? "Sending Message" : "Writing Event") + " UpdateOrderResponse for <" + input.crmOrderNumber + "," + input.workOrderNumber + "> to process " + provisioningProcessId);
                            if(sendMessage) {
                                Process.sendMessageToProcess(provisioningProcessId, null, "ifGranite_jms.XngServicesNotificationToProcesses/UpdateOrder", input);
                            }
                            else {
                                processSTC.writeGraniteResponseIntoDB(provisioningProcessId, input);
                            }
                        }
                    }
                    else {
                        debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "WARNING - Unable to get processDocument of process <" + provisioningProcessId + "> for <" + input.crmOrderNumber + "," + input.workOrderNumber + ">");
                    }
                }
                else {
                    debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "WARNING - Unable to find process for <" + input.crmOrderNumber + "," + input.workOrderNumber + ">");
                }
            }
            else {
                debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "WARNING - Unable to find LineItem for received granite OrderResponse for <" + input.crmOrderNumber + "," + input.workOrderNumber + ">");
            }
        }
        else {
            debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "WARNING - Received granite OrderResponse with crmOrderNumber NULL or workOrderNumber NULL!!!");
        }

        if(logDoc != null) {
            logDoc.userData1 = input.crmOrderNumber;
            logDoc.userData2 = input.workOrderNumber;
            logDoc.save();
        }
    }
    else{
        debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "WARNING - Interface invoked with input NULL...");
    }
  ]]></script>
</script>