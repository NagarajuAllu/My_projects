<?xml version="1.0" encoding="UTF-8" ?>
<script name="ds_ws.checkIfItemsInActiveOrderWereReceived">
  <label>Check If Items In ActiveOrder Were Received</label>
  <metaVersion>4</metaVersion>
  <parameterList>
    <parameter name="cwActiveOrderId" type="rifp">
      <type>dtype_cwf.docId</type>
    </parameter>
    <parameter name="orderNumber" type="rifp">
      <type>dtype_com.conceptwave.system.String</type>
    </parameter>
    <parameter name="parentElementDocIdInActiveOrder" type="rifp">
      <type>dtype_com.conceptwave.system.String</type>
    </parameter>
    <parameter name="containerInCurrentOrder" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
    <parameter name="elementTypeInOrderTree" type="rifp">
      <type>dtype_com.conceptwave.system.String</type>
    </parameter>
    <parameter name="failureArray" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var validationErrors = null;
    var debugMsg = "checkIfItemsInActiveOrderWereReceived (" + orderNumber + ")";

    var activeOrder = Order.getOrderById(cwActiveOrderId);

    var orchestrationRecordsForChildren = processSTC.findRecordsInOrchTabByOrderId_ParentId(cwActiveOrderId, parentElementDocIdInActiveOrder);
    if(orchestrationRecordsForChildren != null && orchestrationRecordsForChildren.length > 0) {
        for(var i=0; i<orchestrationRecordsForChildren.length; i++) {
            var childIdentifierForActiveOrder = orchestrationRecordsForChildren[i].lineItemIdentifier;
            var childDocIdForActiveOrder = orchestrationRecordsForChildren[i].cwDocId;
    //////////////////////
    // STCSUP-1133: removed this check because wrong
    //        if(orchestrationRecordsForChildren[i].provisionable) {
                var childDocInActiveOrder = Document.readDoc("ds_ws.lineItemDocument", childDocIdForActiveOrder);
                if(childDocInActiveOrder != null) {
                    if(childDocInActiveOrder.action != 'D') {
                        // search this childElement in the corresponding elements of the received order
                        var found = false;

                        if(elementTypeInOrderTree == "C") {
                            if(containerInCurrentOrder.circuits != null) {
                                for(var j=0; j<containerInCurrentOrder.circuits.length && !found; j++) {
                                    found = (containerInCurrentOrder.circuits[j].circuit.lineItemIdentifier == childIdentifierForActiveOrder);

                                    if(found) {
                                        failureArray = ds_ws.checkIfItemsInActiveOrderWereReceived(cwActiveOrderId, orderNumber, childDocIdForActiveOrder, containerInCurrentOrder.circuits[j], "S", failureArray);
                                    }
                                }

                                if(!found) {
                                    if(activeOrder.orderHeader.orderType == "F" && (childDocInActiveOrder.onHeld || !childDocInActiveOrder.feasible)) {
                                        // the lineItem is on held or not feasible so it's not reported in the new order
                                    }
                                    else {
                                        if((activeOrder.orderHeader.orderType == "I" || childDocInActiveOrder.requestedActionIsA == true) && childDocInActiveOrder.lineItemStatus.toUpperCase() == "CANCELLED") {
                                            // the lineItem is cancelled and the ACTIVE order was an INSTALL or the action was "A" so it's not reported in the new order
                                        }
                                        else {
                                            // Generate error for missing circuit
                                            validationErrors = ds_ws.appendToValidationErrors("AE0053", Global.translateText("AE0053", null, ["Service", childIdentifierForActiveOrder]), validationErrors, debugMsg);
                                        }
                                    }
                                }
                            }
                            else {
                                // according to the script i'm here because the activeOrder has some element but in the new order they are missing
                                validationErrors = ds_ws.appendToValidationErrors("AE0053", Global.translateText("AE0053", null, ["Service", childIdentifierForActiveOrder]), validationErrors, debugMsg);
                            }
                        }
                        else if(elementTypeInOrderTree == "S") {
                            if(containerInCurrentOrder.services != null) {
                                for(var j=0; j<containerInCurrentOrder.services.length && !found; j++) {
                                    found = (containerInCurrentOrder.services[j].service.lineItemIdentifier == childIdentifierForActiveOrder);

                                    if(found) {
                                        failureArray = ds_ws.checkIfItemsInActiveOrderWereReceived(cwActiveOrderId, orderNumber, childDocIdForActiveOrder, containerInCurrentOrder.services[j], "T", failureArray);
                                    }
                                }

                                if(!found) {
                                    if(activeOrder.orderHeader.orderType == "F" && (childDocInActiveOrder.onHeld || !childDocInActiveOrder.feasible)) {
                                        // the lineItem is on held or not feasible so it's not reported in the new order
                                    }
                                    else {
                                        if((activeOrder.orderHeader.orderType == "I" || childDocInActiveOrder.requestedActionIsA == true) && childDocInActiveOrder.lineItemStatus.toUpperCase() == "CANCELLED") {
                                            // the lineItem is cancelled and the ACTIVE order was an INSTALL or the action was "A" so it's not reported in the new order
                                        }
                                        else {
                                            // Generate error for missing service
                                            validationErrors = ds_ws.appendToValidationErrors("AE0053", Global.translateText("AE0053", null, ["SubService", childIdentifierForActiveOrder]), validationErrors, debugMsg);
                                        }
                                    }
                                }
                            }
                            else {
                                // according to the script i'm here because the activeOrder has some element but in the new order they are missing
                                validationErrors = ds_ws.appendToValidationErrors("AE0053", Global.translateText("AE0053", null, ["SubService", childIdentifierForActiveOrder]), validationErrors, debugMsg);
                            }
                        }
                        else if(elementTypeInOrderTree == "T") {
                            if(containerInCurrentOrder.subServices != null) {
                                for(var j=0; j<containerInCurrentOrder.subServices.length && !found; j++) {
                                    found = (containerInCurrentOrder.subServices[j].subService.lineItemIdentifier == childIdentifierForActiveOrder);
                                }

                                if(!found) {
                                    if(activeOrder.orderHeader.orderType == "F" && (childDocInActiveOrder.onHeld || !childDocInActiveOrder.feasible)) {
                                        // the lineItem is on held or not feasible so it's not reported in the new order
                                    }
                                    else {
                                        if((activeOrder.orderHeader.orderType == "I" || childDocInActiveOrder.requestedActionIsA == true) && childDocInActiveOrder.lineItemStatus.toUpperCase() == "CANCELLED") {
                                            // the lineItem is cancelled and the ACTIVE order was an INSTALL or the action was "A" so it's not reported in the new order
                                        }
                                        else {
                                            // Generate error for missing subService
                                            validationErrors = ds_ws.appendToValidationErrors("AE0053", Global.translateText("AE0053", null, ["Sub-SubService", childIdentifierForActiveOrder]), validationErrors, debugMsg);
                                        }
                                    }
                                }
                            }
                            else {
                                // according to the script i'm here because the activeOrder has some element but in the new order they are missing
                                validationErrors = ds_ws.appendToValidationErrors("AE0053", Global.translateText("AE0053", null, ["Sub-SubService", childIdentifierForActiveOrder]), validationErrors, debugMsg);
                            }
                        } // end else (elementTypeInOrderTree)
                    }
                    else {
                        // checking that the disconnected lineItem is not in the received order
                        var found = false;

                        if(elementTypeInOrderTree == "C") {
                            if(containerInCurrentOrder.circuits != null) {
                                for(var j=0; j<containerInCurrentOrder.circuits.length && !found; j++) {
                                    found = (containerInCurrentOrder.circuits[j].circuit.lineItemIdentifier == childIdentifierForActiveOrder);
                                }

                                if(found) {
                                    // Generate error because there is a circuit previously disconnected
                                    validationErrors = ds_ws.appendToValidationErrors("AE0073", Global.translateText("AE0073", null, ["Service", childIdentifierForActiveOrder]), validationErrors, debugMsg);
                                }
                            }
                        }
                        else if(elementTypeInOrderTree == "S") {
                            if(containerInCurrentOrder.services != null) {
                                for(var j=0; j<containerInCurrentOrder.services.length && !found; j++) {
                                    found = (containerInCurrentOrder.services[j].service.lineItemIdentifier == childIdentifierForActiveOrder);
                                }

                                if(found) {
                                    // Generate error because there is a service previously disconnected
                                    validationErrors = ds_ws.appendToValidationErrors("AE0073", Global.translateText("AE0073", null, ["SubService", childIdentifierForActiveOrder]), validationErrors, debugMsg);
                                }
                            }
                        }
                        else if(elementTypeInOrderTree == "T") {
                            if(containerInCurrentOrder.subServices != null) {
                                for(var j=0; j<containerInCurrentOrder.subServices.length && !found; j++) {
                                    found = (containerInCurrentOrder.subServices[j].subService.lineItemIdentifier == childIdentifierForActiveOrder);
                                }

                                if(found) {
                                    // Generate error because there is a subService previously disconnected
                                    validationErrors = ds_ws.appendToValidationErrors("AE0073", Global.translateText("AE0073", null, ["Sub-SubService", childIdentifierForActiveOrder]), validationErrors, debugMsg);
                                }
                            }
                        } // end else (elementTypeInOrderTree)
                    }
                } // end if(childDocInActiveOrder != null)
    //
    //        }
    //        else {
    //            // element is not provisionable
    //        }
    //
    //  END STCSUP-1133
    ///////////////////////
        } // end for(orchestrationRecordsForChildren_
    }


    if(validationErrors != null) {
        failureArray = ds_ws.addValidationErrorsToFailureArrayForSub_UpdInWD(validationErrors, orderNumber, failureArray, true);
    }
    return failureArray;
  ]]></script>
</script>