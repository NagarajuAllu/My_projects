<?xml version="1.0" encoding="UTF-8" ?>
<script name="ds_ws.addICMSSONumberToInProcessList">
  <label>Add ICMSSONumber To InProcess List</label>
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="icmsSONumber" type="rifp">
      <type>dtype_com.conceptwave.system.String</type>
    </parameter>
    <parameter name="orderNumberInProcess" type="rifp">
      <type>dtype_com.conceptwave.system.String</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var searchDoc = new Document("ds_ws.icmsSONumberInProcessDoc");
    searchDoc.icmsSalesOrderNumber = icmsSONumber;
    searchDoc.orderNumber = null;

    var resultList = Finder.runFinder("ds_ws.findICMSSONumberInProcess", "select", searchDoc);

    if(resultList != null) {
        var foundRecord = false;
        for(var i=0; i<resultList.length; i++) {
            if(resultList[i].orderNumber != orderNumberInProcess) {
                Global.throwException("AE0018", icmsSONumber);
            }
            else {
                foundRecord = true;
            }
        }
    }

    if(!foundRecord) {
        searchDoc.orderNumber = orderNumberInProcess;
        searchDoc.save();
    }
  ]]></script>
</script>