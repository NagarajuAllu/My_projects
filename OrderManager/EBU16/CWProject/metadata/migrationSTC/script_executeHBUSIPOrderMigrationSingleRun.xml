<?xml version="1.0" encoding="UTF-8" ?>
<script filenameHash="dcdb5f92fccb03be80d3c1109d7b3dc" versionHash="a87ff679a2f3e71d9181a67b7542122c" name="migrationSTC.executeHBUSIPOrderMigrationSingleRun">
  <label>Execute HBUSIPOrder Migration Single Run</label>
  <metaVersion>4</metaVersion>
  <script><![CDATA[
    var found = 0;
    var loadedSuccessfully = 0;
    var migratedWithValidationErrors = 0;
    var processedSuccessfully = 0;

    var searchDoc = new Document("migrationSTC.search_STC_OM_HOME_SIP_Migrated");
    searchDoc.migratedToBundle = false;

    var ordersSIPFound = Finder.runFinder("migrationSTC.find_STC_OM_HOME_SIP_ByMigratedToBundle", "select", searchDoc);

    if(ordersSIPFound != null) {
        found = ordersSIPFound.length;


        var bundleSIPProductTypes  = ds_ws.getAllCRMProductTypesForOMInternalProductType("Bundle SIP");
        if(bundleSIPProductTypes == null || bundleSIPProductTypes.length == 0) {
            Global.throwException("AE0083", "Bundle SIP");
        }

        var primarySIPServiceTypeName = ds_ws.getCRMServiceTypeForOMInternalServiceType("SIP/Primary SIP");
        if(primarySIPServiceTypeName == null) {
            Global.throwException("AE0084", "SIP/Primary SIP");
        }

        for(var i=0; i<ordersSIPFound.length; i++) {
            try {
                loadedSuccessfully++;
                var bundleOrderMigrated = migrationSTC.migrateExistingHBUSIPOrderToBundleOrder(ordersSIPFound[i], bundleSIPProductTypes[0], primarySIPServiceTypeName);
                if(bundleOrderMigrated != null) {
                    bundleOrderMigrated.save();
                    ordersSIPFound[i].MIGRATEDTOBUNDLE = true;
                    ordersSIPFound[i].save();

                    var validationErrors = bundleOrderMigrated.validate(1000, true);
                    if(validationErrors != null) {
                        migratedWithValidationErrors++

                        // migrated order is not valid
                        debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "] executeHBUSIPOrderMigrationSingleRun[" + i + "] - Order.id: " + ordersSIPFound[i].cwDocId + " - ValidationErrors: ");
                        for(var k=0; k<validationErrors.length; k=k+2) {
                            debugPrintln(("" + k/2).leftPad(4, " ") + ". - " + validationErrors[k] + " = " + validationErrors[k+1]);
                        }
                    }

                    if(bundleOrderMigrated.orderHeader.orderStatus == "COMPLETED" || validationErrors == null) {
                        var orchestrationError = processSTC.writeSequenceForOrder(bundleOrderMigrated);
                        if(orchestrationError != null) {
                             migratedWithValidationErrors++
                            for(var k=0; k<orchestrationError.length; k++) {
    debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "] executeHBUSIPOrderMigrationSingleRun[" + i + "] - Order.id: " + ordersSIPFound[i].cwDocId + " - Error in creating orchestration record: " +
                 "<" + orchestrationError[k].ErrorCode + "," + orchestrationError[k].ErrorDescription + ">");
                            }
                        }
                        else {
                            processedSuccessfully++;
                        }
                    }

                }
            }
            catch(exc) {
    debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "] executeHBUSIPOrderMigrationSingleRun[" + i + "] - Order.id: " + ordersSIPFound[i].cwDocId + " - Exc: " + exc.message);
            }
        }
    }

    var result = new Array();
    result[0] = found;
    result[1] = loadedSuccessfully;
    result[2] = migratedWithValidationErrors;
    result[3] = processedSuccessfully;


    return result;
  ]]></script>
</script>