<?xml version="1.0" encoding="UTF-8" ?>
<process filenameHash="b7253621967e307a75c6ae0643f2968" versionHash="eccbc87e4b5ce2fe28308fd9f2a7baf3" name="ds_ws.resubmitInHoldOrderProcess_1_0">
  <activity name="start" type="seqActivity">
    <guid>{04d21682-bac9-0d73-6532-e4de12eb698f}</guid>
    <label>Start</label>
    <schedule type="sched">
      <instance>Daily</instance>
      <time>02:00:00</time>
    </schedule>
    <x>35.682617</x>
    <y>30.0</y>
    <childList>
      <child name="resubmitInHoldOrderProcedure_HOME" type="scriptActivity">
        <guid>{03f9265b-aadd-0eb1-1d42-70fd77ab010f}</guid>
        <label>Re-submit &quot;In Hold&quot; Order Procedure [HOME]</label>
        <x>31.0</x>
        <y>121.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <guid>{03231efe-4a9f-b622-a0e7-7c12f1157094}</guid>
            <system>true</system>
            <script><![CDATA[
              var debug = "[PROCESS:" + process.id + "] ";
              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "RE-SUBMIT 'IN HOLD' ORDER PROCEDURE HOME...");

                    var good = 0;
                    var bad = 0;
                    var failure_response = 0;
                    var generic_error = 0;

                    // Procedure to re-submit all the 'In Hold' order that failed:
                    // - retrieving all the records from the STC_ORDER_MESSAGE table where:
                    //      a. In Hold = true;
                    //      b. Internal Order Status is "Order Rejected By Granite"
                    var orderMessages = ds_ws.searchAllOrderMessageHomeForResubmitInHoldOrder();
                    // - analyzing the content of the extraction
                    if (orderMessages != null && orderMessages.length > 0) {
              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "RETRIEVED # " + orderMessages.length + " RECORDS FROM THE STC_ORDER_MESSAGE_HOME TABLE...");
                          for (var z = 0; z < orderMessages.length; z++) {
                                try {
                                      var orderMessage = orderMessages[z];
                                      var order = Order.getOrderById(orderMessage.orderId);

                                      var pid = Process.startProcess("processSTC:mainSTCProcess", order.id);
              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "Started Process with pid " + pid);

                                      Global.commitTransaction("ORDER");

                                      var countSleeping = 0;

                                      var processCompleted = false;
                                      while(!processCompleted) {
                                            // sleeps 5 seconds and checks the status of the process ...
              //debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "Sleeping before checking the status of Process " + pid);
                                            processSTC.timeDelay("GRANITE_RESPONSE_DELAY_TIME");

                                            processCompleted = processSTC.checkIfProcessIsCompleted(pid);
                                            countSleeping++;
                                      }

                                      // reload the order because modified by the process
                                      var cworderId = order.id;
                                      order = Order.getOrderById(cworderId);

                                      if (order.orderACK.Status == "SUCCESS") {
              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + "<RE-SUBMIT 'IN HOLD' ORDER HOME> WITH 'ORDER #': '" + order.orderMessage.orderNumber + "', 'ORDER STATUS': '" + order.orderMessage.orderStatus + "' WORKED CORRECTLY!");
                                            Global.logDebug("<RE-SUBMIT 'IN HOLD' ORDER HOME> WITH 'ORDER #': '" + order.orderMessage.orderNumber + "', 'ORDER STATUS': '" + order.orderMessage.orderStatus + "' WORKED CORRECTLY!");
                                            order.orderMessage.internalOrderStatus = "Granite Call SUCCESSFUL";
                                            order.save();
                                            good++;
                                      }
                                      else {
              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + "<RE-SUBMIT 'IN HOLD' ORDER HOME> WITH 'ORDER #': '" + order.orderMessage.orderNumber + "' NOT ARCHIVED... Order Rejected By Granite [" + order.orderACK.ErrorDescription + "]...");
                                            Global.logDebug("<RE-SUBMIT 'IN HOLD' ORDER HOME> WITH 'ORDER #': '" + order.orderMessage.orderNumber + "' NOT ACCEPTED... Order Rejected By Granite [" + order.orderACK.ErrorDescription + "]...");
                                            order.orderMessage.internalOrderStatus = "Order Rejected By Granite";
                                            order.save();
                                            bad++;
                                            failure_response++;
                                      }
                                }
                                catch(exc) {
              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + " [ERROR] 'IN HOLD' ORDER <" + j + "> NOT MANAGED FOR ORDER #: " + order.orderMessage.orderNumber + " REASON '" + exc.message + "'...");
                                      generic_error++;
                                }
                          } // end for on order on hold
                    }
                    else{
              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "RETRIEVED NO RECORDS FROM THE STC_ORDER_MESSAGE_HOME TABLE...");
                    }

                    var msg = "[INFORMATION] RE-SUBMIT 'IN HOLD' ORDER HOME PROCESS COMPLETED AT '" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "'" +
                                  "\n 'IN HOLD' ORDERS HOME RETRIEVED TO BE RE-SUBMITTED # '" + (orderMessages != null ? orderMessages.length : "0") + "';" +
                                  "\n  - ORDERS ACCEPTED BY GRANITE # '" + good + "';" +
                                  "\n  - ORDERS NOT ACCEPTED BY GRANITE # '" + bad + "';" +
                                "\n     - BECAUSE OF FAILURE RESPONSE # '" + failure_response + "';" +
                                  "\n  - ORDERS NOT ACCEPTED BECAUSE OF GENERIC EXCEPTION # '" + generic_error + "';";
              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + msg);
                    Global.logDebug(msg);
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="end" type="completeActivity">
        <guid>{07fae1e2-a155-13c9-b2a6-6394a1f437a8}</guid>
        <label>End</label>
        <x>41.682617</x>
        <y>277.50586</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <guid>{08733f33-d9c0-d6ac-1101-406bd2d92201}</guid>
            <system>true</system>
            <script><![CDATA[
              var debug = "[PROCESS:" + process.id + "] ";
              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "END...");
            ]]></script>
          </method>
        </methodList>
      </child>
    </childList>
    <methodList>
      <method name="cwOnProcActBefore" type="action">
        <category>before</category>
        <guid>{016b90b3-77f3-31bc-ef5f-32d5693ce574}</guid>
        <system>true</system>
        <script><![CDATA[
          var debug = "[PROCESS:" + process.id + "] ";
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "START...");
        ]]></script>
      </method>
    </methodList>
  </activity>
  <curRevision>true</curRevision>
  <guid>{01cce51c-61c9-fe33-cf1b-d070497f4df0}</guid>
  <label>Re-submit &quot;In Hold&quot; Order Process v. 1.0</label>
  <metaVersion>3</metaVersion>
  <priority>8</priority>
  <revision>2</revision>
  <type>Global</type>
</process>