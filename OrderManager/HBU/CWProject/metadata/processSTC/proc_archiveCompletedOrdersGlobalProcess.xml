<?xml version="1.0" encoding="UTF-8" ?>
<process filenameHash="922aee04fc11dd716f524018b1981dcf" versionHash="a87ff679a2f3e71d9181a67b7542122c" name="processSTC.archiveCompletedOrdersGlobalProcess">
  <activity name="start" type="seqActivity">
    <guid>{814d574b-4ecb-4ca2-b4c6-ebed931ac187}</guid>
    <label>Start</label>
    <schedule type="sched">
      <duration type="dur">
        <methodList>
          <method name="cwOnDuration" type="action">
            <system>true</system>
            <script><![CDATA[
              var sleepTime = Global.getConfigVariable("ARCHIVE_COMPLETED_ORDER_SLEEP_TIME", 120);
              var sleepTimeNumber = new Number(sleepTime);
              if(sleepTimeNumber != Number.NAN) {
                 sleepTimeNumber = sleepTimeNumber*60;
              }

              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.id + "] archiveCompletedOrdersGlobalProcess - SleepTime = " + sleepTimeNumber);
              return sleepTimeNumber;
            ]]></script>
          </method>
        </methodList>
      </duration>
    </schedule>
    <x>31.0</x>
    <y>32.0</y>
    <childList>
      <child name="executeArchive" type="switchActivity">
        <guid>{246c1172-ee29-4095-ad75-0f8e4484a5d0}</guid>
        <label>Execute Archive</label>
        <x>129.0</x>
        <y>27.0</y>
        <childList>
          <child name="yes" type="caseActivity">
            <guid>{0c1bd2fc-fe41-4046-96d2-9398a551c3a7}</guid>
            <label>Yes</label>
            <x>81.0</x>
            <y>355.0</y>
            <childList>
              <child name="startArchiving" type="seqActivity">
                <guid>{3ee23db9-5518-49e5-9808-2948c8aa84e5}</guid>
                <label>Start Archiving</label>
                <x>123.000015</x>
                <y>244.0</y>
                <childList>
                  <child name="existAnotherParentOrderToBeProcessed" type="switchActivity">
                    <guid>{0d639f21-ce5f-4d66-857f-38fa7f19d0eb}</guid>
                    <label>Exist Another ParentOrder To Be Processed</label>
                    <x>338.0</x>
                    <y>217.0</y>
                    <childList>
                      <child name="yes" type="caseActivity">
                        <guid>{e4070597-9131-415e-8937-dd1c3769d240}</guid>
                        <label>Yes</label>
                        <x>539.0</x>
                        <y>155.0</y>
                        <childList>
                          <child name="startProcessingSingleOrder" type="seqActivity">
                            <guid>{c20d002c-41d4-484b-b686-6905ad136826}</guid>
                            <label>Start Processing Single Order</label>
                            <x>485.0</x>
                            <y>238.99998</y>
                            <childList>
                              <child name="checkChildOrdersInGranite" type="scriptActivity">
                                <guid>{c7eef013-25e8-4e3e-a89a-2df1fa8d01ac}</guid>
                                <label>Check Child Orders In Granite</label>
                                <x>703.0</x>
                                <y>208.0</y>
                                <methodList>
                                  <method name="cwOnProcActBefore" type="action">
                                    <category>before</category>
                                    <system>true</system>
                                    <script><![CDATA[
                                      var parentOrderNumber = this.process.processDocument.parentOrderNumberUnderMgmt;
                                      // getting all child orders
                                      var childOrders = ds_ws.searchOrderMessageHomeByParentOrderNumber(parentOrderNumber);

                                      var allChildrenOK = true;

                                      if(childOrders != null) {
                                         for(var i=0; i<childOrders.length && allChildrenOK; i++) {
                                            // for each child orders, check the status of the WO in Granite
                                            var woStatus = granite.getStatusInGraniteForWO(childOrders[i].orderNumber);

                                      debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - WO " +
                                                   childOrders[i].orderNumber + "; status: " + woStatus);

                                            allChildrenOK = (woStatus == '7' || woStatus == '8');
                                         }
                                      }

                                      this.process.processDocument.proceedWithArchive = allChildrenOK;

                                      debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - " +
                                                   parentOrderNumber + " proceedWithArchive: " + this.process.processDocument.proceedWithArchive);
                                    ]]></script>
                                  </method>
                                </methodList>
                              </child>
                              <child name="canProceedWithArchive" type="switchActivity">
                                <guid>{8e339992-fee6-4736-a9df-9df6eaf25998}</guid>
                                <label>Can Proceed With Archive</label>
                                <x>706.0</x>
                                <y>365.0</y>
                                <childList>
                                  <child name="no" type="caseActivity">
                                    <guid>{cafbab8b-e450-4dd9-a5fb-603175c600c0}</guid>
                                    <label>No</label>
                                    <x>616.0</x>
                                    <y>376.0</y>
                                  </child>
                                  <child name="yes" type="caseActivity">
                                    <guid>{40a40394-0e7f-42e6-8f28-40dbae3cbabb}</guid>
                                    <label>Yes</label>
                                    <x>539.0</x>
                                    <y>534.0</y>
                                    <childList>
                                      <child name="startArchivingParentAndChildOrder" type="seqActivity">
                                        <guid>{a540e225-6e1d-4d4c-9581-eac7e45d3944}</guid>
                                        <label>Start Archiving Parent And ChildOrder</label>
                                        <x>700.99994</x>
                                        <y>544.0</y>
                                        <childList>
                                          <child name="archiveParentOrderAndAllItsChildren" type="scriptActivity">
                                            <guid>{0814a991-c9b7-43cf-96c7-12410038133f}</guid>
                                            <label>Archive Parent Order And All Its ChildOrders</label>
                                            <x>487.0</x>
                                            <y>517.0</y>
                                            <methodList>
                                              <method name="cwOnProcActBefore" type="action">
                                                <category>before</category>
                                                <system>true</system>
                                                <script><![CDATA[
                                                  var parentOrderNumber = this.process.processDocument.parentOrderNumberUnderMgmt;

                                                  // to avoid to commit in case of error
                                                  Global.beginTransaction("ORDER");

                                                  // flag to understand if the entire transaction can be commited or not. Default = false for safety!!!
                                                  var archivingOK = false;

                                                  try {
                                                     // searching parentOrder
                                                     var parentOrderHeaderDocument = ds_ws.searchOrderMessageHomeByOrderNumber(parentOrderNumber);
                                                     if(parentOrderHeaderDocument != null) {
                                                        var parentOrder = Order.getOrderById(parentOrderHeaderDocument.cwOrderId);
                                                        if(parentOrder != null) {
                                                           // archiving parent order
                                                           var resultArchive = processSTC.archiveHomeOrder(parentOrderNumber);
                                                           if(resultArchive != null && resultArchive == "OK") {
                                                              // delete parent order
                                                              parentOrder.deleteOrder();

                                                              // processing child orders
                                                              var childOrders = ds_ws.searchOrderMessageHomeByParentOrderNumber(parentOrderNumber);
                                                              var allChildrenOK = true;
                                                              if(childOrders != null) {
                                                                 for(var i=0; i<childOrders.length && allChildrenOK; i++) {
                                                                    var childOrder = Order.getOrderById(childOrders[i].cwOrderId);
                                                                    if(childOrder != null) {
                                                                       // archiving child order
                                                                       resultArchive = processSTC.archiveHomeOrder(childOrders[i].orderNumber);
                                                                       if(resultArchive != null && resultArchive == "OK") {
                                                                          // delete child order
                                                                          childOrder.deleteOrder();
                                                                          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Child order " + childOrders[i].orderNumber + " archived");
                                                                       }
                                                                       else {
                                                                          // log error archive child order
                                                                          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - ERROR IN ARCHIVING CHILD ORDER " + childOrders[i].orderNumber);
                                                                          allChildrenOK = false;
                                                                       }
                                                                    }
                                                                    else {
                                                                       // log error childOrder = null
                                                                       debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - ERROR IN LOADING ORDER FOR CHILD ORDER " + childOrders[i].orderNumber);
                                                                       allChildrenOK = false;
                                                                    }
                                                                 }
                                                              }
                                                              else {
                                                                 // (childOrder == null)
                                                                 debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - No child order found for " + parentOrderNumber);
                                                                 allChildrenOK = true;
                                                              }

                                                              // the flag for commiting is driven by the archiving resulkt of all the child Orders (at this point parentOrder has been archived successfully!)
                                                              archivingOK = allChildrenOK;
                                                           }
                                                           else {
                                                              // log error archive parent order
                                                              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - ERROR IN ARCHIVING PARENT ORDER " + parentOrderNumber);
                                                           }
                                                        }
                                                        else {
                                                           // log error parentOrder = null
                                                           debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - ERROR IN LOADING ORDER FOR PARENT ORDER " + parentOrderNumber);
                                                        }
                                                     }
                                                     else {
                                                        debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - ERROR IN LOADING ORDER HEADER FOR PARENT ORDER " + parentOrderNumber);
                                                     }
                                                  }
                                                  catch(exc) {
                                                     debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Error in processing parent order " + parentOrderNumber + ": " + exc.message);
                                                  }

                                                  if(archivingOK) {
                                                     debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - COMMIT ARCHIVING FOR PARENT ORDER " + parentOrderNumber);
                                                     Global.commitTransaction("ORDER");
                                                  }
                                                  else {
                                                     debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - ROLLBACK ARCHIVING FOR PARENT ORDER " + parentOrderNumber + "; see previous logs");
                                                     Global.rollbackTransaction("ORDER");
                                                  }
                                                ]]></script>
                                              </method>
                                            </methodList>
                                          </child>
                                        </childList>
                                      </child>
                                    </childList>
                                    <methodList>
                                      <method name="cwOnProcActCond" type="action">
                                        <category>cond</category>
                                        <system>true</system>
                                        <script>return this.process.processDocument.proceedWithArchive;</script>
                                      </method>
                                    </methodList>
                                  </child>
                                </childList>
                              </child>
                              <child name="deleteRecordInArchivableOrders" type="scriptActivity">
                                <guid>{27273853-6452-4720-a86f-969447ba0d70}</guid>
                                <label>Delete Record In ArchivableOrders</label>
                                <x>473.0</x>
                                <y>359.0</y>
                                <methodList>
                                  <method name="cwOnProcActBefore" type="action">
                                    <category>before</category>
                                    <system>true</system>
                                    <script><![CDATA[
                                      var inputDocument = new Document("cwt_common:docID");
                                      inputDocument.cwDocID = this.process.processDocument.cwDocId_archivableOrders;
                                      var output = Finder.runFinder("ds_ws:archivableOrdersByCwDocIdFinder", "select", inputDocument);

                                      if (output != null && output.size > 0) {
                                         var archivableOrders = output[0];
                                         archivableOrders.deleteFromDB(false);

                                      debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Deleted processed archivableOrders: " + archivableOrders.toXML());
                                      }
                                      else {
                                      debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Unable to find archivableOrders with cwdocid=" + this.process.processDocument.cwDocId_archivableOrders);
                                      }
                                    ]]></script>
                                  </method>
                                </methodList>
                              </child>
                              <child name="repeat" type="repeatActivity">
                                <element>proc_processSTC.archiveCompletedOrdersGlobalProcess/seqActivity_start/switchActivity_executeArchive/caseActivity_yes/seqActivity_startArchiving/switchActivity_existAnotherParentOrderToBeProcessed</element>
                                <guid>{9c1666e9-bba9-44da-9608-8af4bfef78f7}</guid>
                                <label>Repeat</label>
                                <x>352.0</x>
                                <y>379.0</y>
                                <methodList>
                                  <method name="cwOnProcActBefore" type="action">
                                    <category>before</category>
                                    <system>true</system>
                                    <script>return;</script>
                                  </method>
                                </methodList>
                              </child>
                            </childList>
                            <methodList>
                              <method name="cwOnProcActBefore" type="action">
                                <category>before</category>
                                <system>true</system>
                                <script><![CDATA[
                                  debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Processing order " + this.process.processDocument.parentOrderNumberUnderMgmt);
                                ]]></script>
                              </method>
                            </methodList>
                          </child>
                        </childList>
                        <methodList>
                          <method name="cwOnProcActCond" type="action">
                            <category>cond</category>
                            <system>true</system>
                            <script><![CDATA[
                              var output = Finder.runFinder("ds_ws:archivableOrdersFinder", "select", null);

                              var anotherOrderToProcess = false;
                              if (output != null && output.size > 0) {
                                 anotherOrderToProcess = true;
                                 this.process.processDocument.cwDocId_archivableOrders   = output[0].cwDocId;
                                 this.process.processDocument.parentOrderNumberUnderMgmt = output[0].parentOrderNumber;
                              }
                              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Another order to be archived? " + anotherOrderToProcess);

                              return (anotherOrderToProcess);
                            ]]></script>
                          </method>
                        </methodList>
                      </child>
                      <child name="no" type="caseActivity">
                        <guid>{cbe532e4-833c-4517-878c-d18aea11efed}</guid>
                        <label>No</label>
                        <x>355.0</x>
                        <y>121.0</y>
                      </child>
                    </childList>
                  </child>
                </childList>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActCond" type="action">
                <category>cond</category>
                <system>true</system>
                <script><![CDATA[
                  var executeArchiving = Global.getConfigVariable("EXECUTE_ARCHIVING_COMPLETED_ORDER", "NO");

                  debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Execute Archiving: " + (executeArchiving == "YES"));
                  return (executeArchiving == "YES");
                ]]></script>
              </method>
            </methodList>
          </child>
          <child name="no" type="caseActivity">
            <guid>{7a1d76ef-7dbc-4266-80b4-bf40a9ac72d5}</guid>
            <label>No</label>
            <x>245.0</x>
            <y>36.0</y>
          </child>
        </childList>
      </child>
      <child name="end" type="completeActivity">
        <guid>{85452ff4-c82c-4411-9364-0412a48e1c89}</guid>
        <label>End</label>
        <x>355.0</x>
        <y>36.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Completed!!!");
            ]]></script>
          </method>
        </methodList>
      </child>
    </childList>
    <methodList>
      <method name="cwOnProcActBefore" type="action">
        <category>before</category>
        <system>true</system>
        <script><![CDATA[
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Start ...");
        ]]></script>
      </method>
    </methodList>
  </activity>
  <curRevision>true</curRevision>
  <document>doc_processSTC.procDocumentToArchiveOrders</document>
  <guid>{5291d275-36d7-448c-9ea7-a71b9174ad4b}</guid>
  <label>Archive Completed Orders Global Process</label>
  <metaVersion>4</metaVersion>
  <priority>8</priority>
  <revision>2</revision>
  <type>Global</type>
</process>