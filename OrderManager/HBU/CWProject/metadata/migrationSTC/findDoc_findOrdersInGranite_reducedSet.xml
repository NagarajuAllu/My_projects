<?xml version="1.0" encoding="UTF-8" ?>
<findDoc filenameHash="ad17d6aae354ee99ac1dbfd0fbd65fd" versionHash="a87ff679a2f3e71d9181a67b7542122c" name="migrationSTC.findOrdersInGranite_reducedSet">
  <extends>find_com.conceptwave.system.Finder</extends>
  <input>doc_migrationSTC.searchOrdersInGraniteDoc</input>
  <label>Find Orders In Granite - Reduced Set</label>
  <maxRowsLimit>5000</maxRowsLimit>
  <metaVersion>4</metaVersion>
  <output>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU</output>
  <type>document</type>
  <uiQueryTimeout>0</uiQueryTimeout>
  <volatility>1</volatility>
  <searchList>
    <search type="sitem">
      <document>doc_migrationSTC.searchOrdersInGraniteDoc</document>
      <mappedDocument>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU</mappedDocument>
      <mappedPath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_CIRCUIT_STATUS</mappedPath>
      <operation>equal</operation>
      <path>doc_migrationSTC.searchOrdersInGraniteDoc/leaf_CIRCUIT_STATUS</path>
    </search>
    <search type="sitem">
      <document>doc_migrationSTC.searchOrdersInGraniteDoc</document>
      <mappedDocument>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU</mappedDocument>
      <mappedPath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_ORDER_NUMBER</mappedPath>
      <operation>like</operation>
      <path>doc_migrationSTC.searchOrdersInGraniteDoc/leaf_ORDER_NUMBER</path>
    </search>
    <search type="sitem">
      <document>doc_migrationSTC.searchOrdersInGraniteDoc</document>
      <mappedDocument>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU</mappedDocument>
      <mappedPath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_ORDER_TYPE</mappedPath>
      <operation>equal</operation>
      <path>doc_migrationSTC.searchOrdersInGraniteDoc/leaf_ORDER_TYPE</path>
    </search>
    <search type="sitem">
      <document>doc_migrationSTC.searchOrdersInGraniteDoc</document>
      <mappedDocument>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU</mappedDocument>
      <mappedPath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_PARENT_ORDER_NUMBER</mappedPath>
      <operation>like</operation>
      <path>doc_migrationSTC.searchOrdersInGraniteDoc/leaf_PARENT_ORDER_NUMBER</path>
    </search>
    <search type="sitem">
      <document>doc_migrationSTC.searchOrdersInGraniteDoc</document>
      <mappedDocument>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU</mappedDocument>
      <mappedPath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_SUBMITTED_DATE_YEAR</mappedPath>
      <operation>equal</operation>
      <path>doc_migrationSTC.searchOrdersInGraniteDoc/leaf_SUBMITTED_DATE_YEAR</path>
    </search>
  </searchList>
  <UserInterface name="UserInterface" type="ui">
    <extends>ui_com.conceptwave.system.FinderUserInterface</extends>
    <variableList>
      <variable name="finder" type="uivar">
        <valueType>ui_com.conceptwave.system.FinderUserInterface</valueType>
      </variable>
      <variable name="model" type="uivar">
        <valueType>findDoc_migrationSTC.findOrdersInGranite_reducedSet</valueType>
      </variable>
      <variable name="search" type="uivar">
        <valueType>doc_migrationSTC.searchOrdersInGraniteDoc/ui_UserInterface</valueType>
      </variable>
      <variable name="result" type="uivar">
        <flags enum-type="metadataFlag">ARRAY</flags>
        <valueType>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU</valueType>
      </variable>
      <variable name="detail" type="uivar">
        <flags enum-type="metadataFlag">VALIDATE</flags>
        <valueType>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/ui_UserInterface</valueType>
      </variable>
    </variableList>
    <vformList>
      <vform name="Forms" type="frmui">
        <extends>ui_com.conceptwave.system.FinderUserInterface/frmui_Forms</extends>
        <overlayList>
          <overlay name="Default" type="exov">
            <base>ui_com.conceptwave.system.FinderUserInterface/frmui_Forms/exov_Default</base>
            <extends>ui_com.conceptwave.system.FinderUserInterface/frmui_Forms/exov_Default</extends>
            <label>Default</label>
            <overrideList>
              <override name="detailSection" type="elsect">
                <formReference type="varPath">
                  <variablePathList>
                    <variablePath>ui_com.conceptwave.system.MasterDetailUserInterface/uivar_detailForm</variablePath>
                  </variablePathList>
                </formReference>
                <variable type="varPath">
                  <variablePathList>
                    <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_detail</variablePath>
                  </variablePathList>
                </variable>
                <visible type="varPath">
                  <variablePathList>
                    <variablePath>ui_com.conceptwave.system.MasterDetailUserInterface/permMethod_detailVisible</variablePath>
                  </variablePathList>
                </visible>
              </override>
              <override name="finderHeader" type="elext">
                <style>CwFIT</style>
              </override>
              <override name="Iterator" type="elext">
                <visible type="varPath">
                  <variablePathList>
                    <variablePath>ui_com.conceptwave.system.FinderUserInterface/permMethod_showView</variablePath>
                  </variablePathList>
                </visible>
              </override>
              <override name="searchFormSection" type="elsect">
                <formReference type="varPath">
                  <variablePathList>
                    <variablePath>ui_com.conceptwave.system.BaseFinderUserInterface/uivar_searchForm</variablePath>
                  </variablePathList>
                </formReference>
                <variable type="varPath">
                  <variablePathList>
                    <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_search</variablePath>
                  </variablePathList>
                </variable>
                <visible type="varPath">
                  <variablePathList>
                    <variablePath>ui_com.conceptwave.system.FinderUserInterface/permMethod_showSearchForm</variablePath>
                  </variablePathList>
                </visible>
              </override>
            </overrideList>
          </overlay>
          <overlay name="Menu" type="exov">
            <base>ui_com.conceptwave.system.BaseFinderUserInterface/frmui_Forms/exov_Menu</base>
            <extends>ui_com.conceptwave.system.BaseFinderUserInterface/frmui_Forms/exov_Menu</extends>
            <label>Menu</label>
            <overrideList>
              <override name="cwfAdd" type="eldel"/>
              <override name="cwfCopy" type="eldel"/>
              <override name="cwfDelete" type="eldel"/>
              <override name="cwfUpdate" type="elmnu">
                <menuAccel type="mAccelP"/>
                <clickMethod type="varPath">
                  <variablePathList>
                    <variablePath>ui_com.conceptwave.system.BaseFinderUserInterface/action_updateAction</variablePath>
                  </variablePathList>
                </clickMethod>
                <icon>/cwf/MenuIconEdit.gif</icon>
                <tooltip>Edit</tooltip>
                <visible type="varPath">
                  <variablePathList>
                    <variablePath>ui_com.conceptwave.system.BaseFinderUserInterface/permMethod_cwfUpdateView</variablePath>
                  </variablePathList>
                </visible>
              </override>
              <override name="detailMenu" type="eldel"/>
              <override name="finderMenuLayout" type="elext">
                <elementList>
                  <element name="synchronizeSelected" type="elmnu">
                    <clickMethod type="varPath">
                      <variablePathList>
                        <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/usrActionMethod_synchronizeSelected_menu</variablePath>
                      </variablePathList>
                    </clickMethod>
                    <label>Synchronize [Selected]</label>
                    <menuType>5</menuType>
                    <showDown>true</showDown>
                    <showRollOver>true</showRollOver>
                  </element>
                  <element name="synchronizeAll" type="elmnu">
                    <clickMethod type="varPath">
                      <variablePathList>
                        <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/usrActionMethod_synchronizeAll_menu</variablePath>
                      </variablePathList>
                    </clickMethod>
                    <label>Synchronize [All]</label>
                    <menuType>5</menuType>
                    <showDown>true</showDown>
                    <showRollOver>true</showRollOver>
                  </element>
                  <element name="detailMenuEx" type="elovf">
                    <formReference type="varPath">
                      <variablePathList>
                        <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_detail</variablePath>
                        <variablePath>doc_migrationSTC.STC_GRANITE_DATA_FOR_HBU/ui_UserInterface/frmui_Forms</variablePath>
                        <variablePath>doc_com.conceptwave.system.Document/ui_UserInterface/frmui_Forms/exov_Menu</variablePath>
                      </variablePathList>
                    </formReference>
                    <overflow>visible</overflow>
                    <variable type="varPath">
                      <variablePathList>
                        <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_detail</variablePath>
                      </variablePathList>
                    </variable>
                    <width>1px</width>
                  </element>
                </elementList>
              </override>
            </overrideList>
          </overlay>
          <overlay name="Result" type="exov">
            <base>ui_com.conceptwave.system.FinderUserInterface/frmui_Forms/vform_Result</base>
            <extends>ui_com.conceptwave.system.FinderUserInterface/frmui_Forms/vform_Result</extends>
            <label>Result</label>
            <overrideList>
              <override name="table" type="elvlt">
                <height>100%</height>
                <width>100%</width>
                <elementList>
                  <element name="findOrdersInGranite_reducedSetResultTable" type="eltabl">
                    <onSelectChange type="varPath">
                      <variablePathList>
                        <variablePath>ui_com.conceptwave.system.MasterDetailUserInterface/action_OnSelChanged</variablePath>
                      </variablePathList>
                    </onSelectChange>
                    <variable type="varPath">
                      <variablePathList>
                        <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                      </variablePathList>
                    </variable>
                    <elementList>
                      <element name="CIRC_PATH_INST_ID" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_CIRC_PATH_INST_ID</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="CIRCUIT_NUMBER" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_CIRCUIT_NUMBER</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="CIRCUIT_STATUS" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_CIRCUIT_STATUS</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="CUSTOMER" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_CUSTOMER</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="CUSTOMER_NAME" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_CUSTOMER_NAME</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="CUSTOMER_NUMBER" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_CUSTOMER_NUMBER</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="ACCOUNT_NUMBER" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_ACCOUNT_NUMBER</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="ICMS_SO_NUMBER" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_ICMS_SO_NUMBER</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="ORDER_DOMAIN" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_ORDER_DOMAIN</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="ORDER_NUMBER" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_ORDER_NUMBER</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="ORDER_TYPE" type="elslct">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_ORDER_TYPE</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="ORDER_STATUS" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_ORDER_STATUS</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="NBR_TASKS" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_NBR_TASKS</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="PROJECT_ID" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_PROJECT_ID</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="CCT_TYPE" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_CCT_TYPE</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="SERVICE_DATE" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_SERVICE_DATE</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="PLATE_ID" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_PLATE_ID</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="CREATED_BY" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_CREATED_BY</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="DOMAIN_NAME" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_DOMAIN_NAME</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="ORDER_ROW_ITEM_ID" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_ORDER_ROW_ITEM_ID</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="PARENT_ORDER_NUMBER" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_PARENT_ORDER_NUMBER</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                      <element name="SUBMITTED_DATE_YEAR" type="elfld">
                        <variable type="varPath">
                          <variablePathList>
                            <variablePath>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/uivar_result</variablePath>
                            <variablePath>doc_migrationSTC.STC_GRANITE_REDUCED_DATA_FOR_HBU/leaf_SUBMITTED_DATE_YEAR</variablePath>
                          </variablePathList>
                        </variable>
                      </element>
                    </elementList>
                  </element>
                </elementList>
              </override>
            </overrideList>
          </overlay>
        </overlayList>
      </vform>
    </vformList>
    <methodList>
      <method name="synchronizeSelected" type="usrActionMethod">
        <autosave>true</autosave>
        <confirmation>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/action_synchronizeSelected_confirm</confirmation>
        <script><![CDATA[
          var selectList = this.result.selected;

                var debug = "[MENU ITEM: SYNCHRONIZE] ";

                // Check how many orders have been selected:
                // - if zero then a warning is sent to the user
                var n = selectList != null ? selectList.length : 0;
                if (n > 0) {

          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "RETRIEVED # " + n + " RECORDS FROM THE EXPEDITER VIEW...");

                      var good = 0;
                      var good_existing = 0;
                      var good_created = 0;
                      var bad = 0;
                      var skipped = 0;
                      var validation_exception = 0;
                      var messages_EAI_sent = 0;

                      for (var j = 0; j < n; j++) {
                            var orderMissing = selectList[j];
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "Processing selected ORDER " + orderMissing.toXML());


                            try {
                                  if(orderMissing.DOMAIN_NAME != null && orderMissing.DOMAIN_NAME != "hbu__domain") {
                                        continue;
                                  }


                                  if(orderMissing.ORDER_STATUS == "COMPLETED") {
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "ORDER " + orderMissing.ORDER_NUMBER + " IS COMPLETED; CHECKING PARENT_ORDER " + orderMissing.PARENT_ORDER_NUMBER);

                                        var countChildren = migrationSTC.countOrdersInGraniteByParentOrderNumber(orderMissing.PARENT_ORDER_NUMBER);
                                        if(countChildren > 1) {
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "SKIP ORDER " + orderMissing.ORDER_NUMBER + "; IT'S COMPLETED AND THE PARENT_ORDER " +
                             orderMissing.PARENT_ORDER_NUMBER + " HAS MORE THAN ONE CHILD ORDER <" + countChildren + ">");
                                              skipped++;
                                              continue;
                                        }
                                  }
                                  else if(orderMissing.ORDER_STATUS == "CANCELLED") {
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "SKIP ORDER " + orderMissing.ORDER_NUMBER + "; IT'S CANCELLED");
                                        skipped++;
                                        continue;
                                  }


                                  var expediterOrder = null;

                                  // [0]. Check if the order is already stored into Exepditer environment
                                  var orderMessage = ds_ws.searchOrderMessageHomeByOrderNumber(orderMissing.ORDER_NUMBER);
                                  if (orderMessage != null) {
                                        expediterOrder = Order.getOrderById(orderMessage.orderId);
                                        good_existing++;
                                  }
                                  else{
                                        expediterOrder = new Order("ds_ws:default_orderSTC_HOME");
                                        good_created++;
                                  }

                                  // [2]. Mapping the data found on the Child order
                                  migrationSTC.fillOrderWithMissingOrderFound(orderMissing, expediterOrder, true, orderMessage == null);

                                  // [3]. Validation of the order before make it persistent on the DB
                                  var validation = expediterOrder.validate(10, true);
                                  if (validation != null) {

                                        for (var k = 0; k < validation.length; k = k + 2) {
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "VALIDATION ERROR[" + k + "]: CODE '" + validation[k] + "' MESSAGE '" + validation[k + 1] + "'...");
                                        }

                                        validation_exception++;

                                        var errorMessage = "";
                                        if(validation.length > 1) {
                                              errorMessage = (validation[1] == null ? validation[0] : validation[1]);
                                        }
                                        else if(validation.length > 0) {
                                              errorMessage = validation[0];
                                        }
                                        // Customized exception AE0003:
                                        // - Validation errors found while processing "{0}" with id. "{1}": {2}!
                                        Global.throwException(Global.translateText("AE0003", null, ["Order STC", orderMissing.ORDER_NUMBER, errorMessage]));
                                  }
                                  expediterOrder.save();

                                  // [4]. Searching and Updating parent order
                                  var expediterParentOrder = null;

                                  var parentOrderMessage = ds_ws.searchOrderMessageHomeByOrderNumber(orderMissing.PARENT_ORDER_NUMBER);
                                  if (parentOrderMessage != null) {
                                        expediterParentOrder = Order.getOrderById(parentOrderMessage.orderId);
                                  }
                                  else{
                                        expediterParentOrder = new Order("ds_ws:default_orderSTC_HOME");
                                  }

                                  // [5]. Mapping the data found on the Parent order
                                  migrationSTC.fillOrderWithMissingOrderFound(orderMissing, expediterParentOrder, false, parentOrderMessage == null);
                                  expediterParentOrder.save();

                                  // [6]. Check if we need to send a Work Order Status Update message to EAI:
                                  // - in this.model case the script invoked updates the Order Status, Circuit Status and Service Date
                                  var input = new DataStructure("ds_jms:workOrderStatusUpdate_el");

                                  // [a]. create message for EAI...
                                  input.businessUnit                         = "Home";
                                  input.circuitStatus                        = orderMissing.CIRCUIT_STATUS;
                                  input.circuitNumber                        = orderMissing.CIRCUIT_NUMBER;
                                  input.orderNumber                          = orderMissing.ORDER_NUMBER;
                                  input.orderType                            = orderMissing.ORDER_TYPE;
                                  input.workOrderDescription                 = "";
                                  input.workOrder                            = orderMissing.ORDER_NUMBER;
                                  input.workOrderCircuitPathCompletionStatus = orderMissing.CIRCUIT_STATUS;
                                  input.workOrderLastModifiedBy              = orderMissing.CREATED_BY;
                                  input.workOrderLastModifiedTimestamp       =
                                        (orderMissing.SERVICE_DATE != null ?
                                         (orderMissing.SERVICE_DATE.indexOf(":") != -1 ? orderMissing.SERVICE_DATE : orderMissing.SERVICE_DATE + " 00:00:00") : null);
                                  input.workOrderName                        = orderMissing.ORDER_NUMBER;
                                  input.workOrderRemarks                     = "";
                                  input.workOrderStatus                      = orderMissing.ORDER_STATUS;
                                  input.workOrderTotalTime                   = "";
                                  input.circuitNumber                        = orderMissing.CIRCUIT_NUMBER;
                                  input.taskServiceType                      = orderMissing.SERVICE_TYPE;
                                  input.icmsSONumber                         = orderMissing.ICMS_SO_NUMBER;
                                  input.taskName                             = orderMissing.TASK_NAME;

                                  if(migrationSTC.hasCircuitIDToBeSentInWOSU(orderMissing.SERVICE_TYPE, orderMissing.ORDER_TYPE)) {
                                        input.parameters[0]                        = new DataStructure("ds_jms:nameValue");
                                        input.parameters[0].name                   = ifEAI_WOSU_17122008.getElementNameForSIPCircuitID();
                                        input.parameters[0].value                  = orderMissing.CIRCUIT_NUMBER;
                                  }

                                  // [b]. save message in queue for EAI...
                                  ifGranite_jms.manageGraniteMsg_WorkOrderStatusUpdate(input);
                                  messages_EAI_sent++;
                                  good++;
                            }
                            catch(exc) {
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "EXPEDITER RAISED EXCEPTION FOR ORDER #: " + orderMissing.ORDER_NUMBER + "; REASON '" + exc.message + "'...");
          Global.logDebug(debug + "EXPEDITER RAISED EXCEPTION FOR ORDER #: " + orderMissing.ORDER_NUMBER + "; REASON '" + exc.message + "'...");
                                  bad++;
                            }
                      }

                      var msg = "[INFORMATION] Synchronization COMPLETED AT '" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "'" +
                                    "\n XNG ORDERS SELECTED # '" + n + "';" +
                                  "\n     - ORDER ADDED INTO EXPEDITER # '" + good_created + "';" +
                                    "\n     - ORDER FOUND INTO EXPEDITER # '" + good_existing + "';" +
                                    "\n     - ORDER SKIPPED BECAUSE CANCELLED OR COMPLETED IN ORDER WITH MULTIPLE SERVICES # '" + skipped + "';" +
                                    "\n  - EXPEDITER ORDERS WORKED PROPERLY # '" + good + "';" +
                                    "\n     - 'WORK ORDER STATUS UPDATE' MESSAGES SENT TO EAI # '" + messages_EAI_sent + "';" +
                                    "\n  - EXPEDITER ORDERS WORKED WITH EXCEPTION # '" + bad + "';" +
                                    "\n     - ORDER VALIDATION EXCEPTION INTO EXPEDITER # '" + validation_exception + "' (ORDERS NOT UPDATED ON EXPEDITER);";
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + msg);
                      Global.logDebug(msg);
                      Global.showUserMessage(msg);
                }
                else{
                      Global.showUserMessage("[WARNING] NO ORDERS SELECTED!");
                }
        ]]></script>
      </method>
      <method name="synchronizeSelected_confirm" type="action">
        <script><![CDATA[return "AW0003";]]></script>
      </method>
      <method name="synchronizeSelected_menu" type="usrActionMethod">
        <allowInvalidObject>true</allowInvalidObject>
        <validate>true</validate>
        <script><![CDATA[
          if (!this.isValid) {
            var messages = this.validationErrors == null ? null : this.validationErrors.getErrorsAsString(10);
            if (messages == null)
              Global.throwException("UU0129", this);
            else
              Global.throwException("UU0147", "<br>" + messages);
          }
          var result = this.synchronizeSelected();
          if(result instanceof Finder) {
            Global.runContentDisplayScript(result.searchDocument, "displayScript");
          } else {
            Global.runContentDisplayScript(this, "displayScript");
          }

          return result;
        ]]></script>
      </method>
      <method name="synchronizeAll" type="usrActionMethod">
        <allowInvalidObject>true</allowInvalidObject>
        <autosave>true</autosave>
        <confirmation>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/action_synchronizeAll_confirm</confirmation>
        <script><![CDATA[
          var finder = this.model;

                var debug = "[MENU ITEM: SYNCHRONIZE ALL] ";

                // Check how many orders have been retrieved:
                // - if zero then a warning is sent to the user
                var output = finder.list;
                var orders = null;
                var n = -1;
                if (output != null) {

                      orders = new Array();

          //            var ratio = output.totalSize / output.size;
          //            for (var j = 0; j < ratio; j++) {
                            // [A]. Increase the page load
                            output.loadPage(0);
                            // [B]. Fetch the current page
                            for (var i=0; i < output.size; i++){
                                  orders = orders.concat(output[i]);
                            }
          //            }

                      n = orders.length;
                }

                if (n > 0) {

          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "RETRIEVED # " + n + " RECORDS FROM THE EXPEDITER VIEW...");

                      var good = 0;
                      var good_existing = 0;
                      var good_created = 0;
                      var bad = 0;
                      var skipped = 0;
                      var validation_exception = 0;
                      var messages_EAI_sent = 0;

                      for (var j = 0; j < n; j++) {
                            var orderMissing = orders[j];
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "Processing selected ORDER " + orderMissing.toXML());

                            try {
                                  if(orderMissing.DOMAIN_NAME != null && orderMissing.DOMAIN_NAME != "hbu__domain") {
                                        continue;
                                  }

                                  if(orderMissing.ORDER_STATUS == "COMPLETED") {
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "ORDER " + orderMissing.ORDER_NUMBER + " IS COMPLETED; CHECKING PARENT_ORDER " + orderMissing.PARENT_ORDER_NUMBER);

                                        var countChildren = migrationSTC.countOrdersInGraniteByParentOrderNumber(orderMissing.PARENT_ORDER_NUMBER);
                                        if(countChildren > 1) {
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "SKIP ORDER " + orderMissing.ORDER_NUMBER + "; IT'S COMPLETED AND THE PARENT_ORDER " +
                             orderMissing.PARENT_ORDER_NUMBER + " HAS MORE THAN ONE CHILD ORDER <" + countChildren + ">");
                                               skipped++;
                                              continue;
                                        }
                                  }
                                  else if(orderMissing.ORDER_STATUS == "CANCELLED") {
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "SKIP ORDER " + orderMissing.ORDER_NUMBER + "; IT'S CANCELLED");
                                        skipped++;
                                        continue;
                                  }

                                  var expediterOrder = null;

                                  // [0]. Check if the order is already stored into Exepditer environment
                                  var orderMessage = ds_ws.searchOrderMessageHomeByOrderNumber(orderMissing.ORDER_NUMBER);
                                  if (orderMessage != null) {
                                        expediterOrder = Order.getOrderById(orderMessage.orderId);
                                        good_existing++;
                                  }
                                  else{
                                        expediterOrder = new Order("ds_ws:default_orderSTC_HOME");
                                        good_created++;
                                  }

                                  // [2]. Mapping the data found on the Child order
                                  migrationSTC.fillOrderWithMissingOrderFound(orderMissing, expediterOrder, true, orderMessage == null);

                                  // [3]. Validation of the order before make it persistent on the DB
                                  var validation = expediterOrder.validate(10, true);
                                  if (validation != null) {

                                        for (var k = 0; k < validation.length; k = k + 2) {
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "VALIDATION ERROR[" + k + "]: CODE '" + validation[k] + "' MESSAGE '" + validation[k + 1] + "'...");
                                        }
                                        validation_exception++;

                                        var errorMessage = "";
                                        if(validation.length > 1) {
                                              errorMessage = (validation[1] == null ? validation[0] : validation[1]);
                                        }
                                        else if(validation.length > 0) {
                                              errorMessage = validation[0];
                                        }
                                        // Customized exception AE0003:
                                        // - Validation errors found while processing "{0}" with id. "{1}": {2}!
                                        Global.throwException(Global.translateText("AE0003", null, ["Order STC", orderMissing.ORDER_NUMBER, errorMessage]));
                                  }
                                  expediterOrder.save();

                                  // [4]. Searching and Updating parent order
                                  var expediterParentOrder = null;

                                  var parentOrderMessage = ds_ws.searchOrderMessageHomeByOrderNumber(orderMissing.PARENT_ORDER_NUMBER);
                                  if (parentOrderMessage != null) {
                                        expediterParentOrder = Order.getOrderById(parentOrderMessage.orderId);
                                  }
                                  else{
                                        expediterParentOrder = new Order("ds_ws:default_orderSTC_HOME");
                                  }

                                  // [5]. Mapping the data found on the Parent order
                                  migrationSTC.fillOrderWithMissingOrderFound(orderMissing, expediterParentOrder, false, parentOrderMessage == null);
                                  expediterParentOrder.save();

                                  // [6]. Check if we need to send a Work Order Status Update message to EAI:
                                  // - in this.model case the script invoked updates the Order Status, Circuit Status and Service Date
                                  var input = new DataStructure("ds_jms:workOrderStatusUpdate_el");

                                  // [a]. create message for EAI...
                                  input.businessUnit                         = "Home";
                                  input.circuitStatus                        = orderMissing.CIRCUIT_STATUS;
                                  input.circuitNumber                        = orderMissing.CIRCUIT_NUMBER;
                                  input.orderNumber                          = orderMissing.ORDER_NUMBER;
                                  input.orderType                            = orderMissing.ORDER_TYPE;
                                  input.workOrderDescription                 = "";
                                  input.workOrder                            = orderMissing.ORDER_NUMBER;
                                  input.workOrderCircuitPathCompletionStatus = orderMissing.CIRCUIT_STATUS;
                                  input.workOrderLastModifiedBy              = orderMissing.CREATED_BY;
                                  input.workOrderLastModifiedTimestamp       =
                                              (orderMissing.SERVICE_DATE != null ?
                                               (orderMissing.SERVICE_DATE.indexOf(":") != -1 ? orderMissing.SERVICE_DATE : orderMissing.SERVICE_DATE + " 00:00:00") : null);
                                  input.workOrderName                        = orderMissing.ORDER_NUMBER;
                                  input.workOrderRemarks                     = "";
                                  input.workOrderStatus                      = orderMissing.ORDER_STATUS;
                                  input.workOrderTotalTime                   = "";
                                  input.circuitNumber                        = orderMissing.CIRCUIT_NUMBER;
                                  input.taskServiceType                      = orderMissing.SERVICE_TYPE;
                                  input.icmsSONumber                         = orderMissing.ICMS_SO_NUMBER;
                                  input.taskName                             = orderMissing.TASK_NAME;

                                  if(migrationSTC.hasCircuitIDToBeSentInWOSU(orderMissing.SERVICE_TYPE, orderMissing.ORDER_TYPE)) {
                                        input.parameters[0]                        = new DataStructure("ds_jms:nameValue");
                                        input.parameters[0].name                   = ifEAI_WOSU_17122008.getElementNameForSIPCircuitID();
                                        input.parameters[0].value                  = orderMissing.CIRCUIT_NUMBER;
                                  }

                                  // [b]. save message in queue for EAI...
                                  ifGranite_jms.manageGraniteMsg_WorkOrderStatusUpdate(input);
                                  messages_EAI_sent++;
                                  good++;
                            }
                            catch(exc) {
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + debug + "EXPEDITER RAISED EXCEPTION FOR ORDER #: " + orderMissing.ORDER_NUMBER + "; REASON '" + exc.message + "'...");
                                  bad++;
                            }
                      }

                      var msg = "[INFORMATION] Synchronization COMPLETED AT '" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "'" +
                                    "\n XNG ORDERS RETRIEVED # '" + n + "';" +
                                  "\n     - ORDER ADDED INTO EXPEDITER # '" + good_created + "';" +
                                    "\n     - ORDER FOUND INTO EXPEDITER # '" + good_existing + "';" +
                                    "\n     - ORDER SKIPPED BECAUSE CANCELLED OR COMPLETED IN ORDER WITH MULTIPLE SERVICES # '" + skipped + "';" +
                                    "\n  - EXPEDITER ORDERS WORKED PROPERLY # '" + good + "';" +
                                    "\n     - 'WORK ORDER STATUS UPDATE' MESSAGES SENT TO EAI # '" + messages_EAI_sent + "';" +
                                    "\n  - EXPEDITER ORDERS WORKED WITH EXCEPTION # '" + bad + "';" +
                                    "\n     - ORDER VALIDATION EXCEPTION INTO EXPEDITER # '" + validation_exception + "' (ORDERS NOT UPDATED ON EXPEDITER);";
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "]" + msg);
                      Global.logDebug(msg);
                      Global.showUserMessage(msg);
                }
                else{
                      Global.showUserMessage("[WARNING] NO ORDERS SELECTED!");
                }
        ]]></script>
      </method>
      <method name="synchronizeAll_confirm" type="action">
        <script><![CDATA[return "AW0002";]]></script>
      </method>
      <method name="synchronizeAll_menu" type="usrActionMethod">
        <allowInvalidObject>true</allowInvalidObject>
        <confirmation>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/action_cwAutosaveConfirmation</confirmation>
        <validate>true</validate>
        <script><![CDATA[
          var result = this.synchronizeAll();
          if(result instanceof Finder) {
            Global.runContentDisplayScript(result.searchDocument, "displayScript");
          } else {
            Global.runContentDisplayScript(this, "displayScript");
          }

          return result;
        ]]></script>
      </method>
      <method name="cwAutosaveConfirmation" type="action">
        <valueType>dtype_com.conceptwave.system.String</valueType>
        <script><![CDATA[
          if (!this.isValid && Global.isAutosaveEnabled()) {
            return "UU0256:YN";
          }
          return null;
        ]]></script>
      </method>
    </methodList>
  </UserInterface>
  <viewList>
    <view name="findOrdersInGranite_reducedSet" type="findVView">
      <inputOverlay>doc_migrationSTC.searchOrdersInGraniteDoc/ui_UserInterface/frmui_Forms/exov_Default</inputOverlay>
      <label>Find Orders In Granite - ReducedSet</label>
      <outputOverlay>findDoc_migrationSTC.findOrdersInGranite_reducedSet/ui_UserInterface/frmui_Forms/exov_Result</outputOverlay>
      <showSearchForm>true</showSearchForm>
    </view>
  </viewList>
</findDoc>