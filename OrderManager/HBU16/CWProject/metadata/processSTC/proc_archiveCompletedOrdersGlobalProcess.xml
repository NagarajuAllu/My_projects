<?xml version="1.0" encoding="UTF-8" ?>
<process name="processSTC.archiveCompletedOrdersGlobalProcess">
  <activity name="start" type="seqActivity">
    <label>Start</label>
    <schedule type="sched">
      <duration type="dur">
        <methodList>
          <method name="cwOnDuration" type="action">
            <system>true</system>
            <script><![CDATA[
              var sleepTime = Global.getConfigVariable("ARCHIVE_COMPLETED_ORDER_SLEEP_TIME", 120);
              var sleepTimeNumber = new Number(sleepTime);
              if(sleepTimeNumber != Number.NAN) {
                 sleepTimeNumber = sleepTimeNumber*60;
              }

              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.id + "] archiveCompletedOrdersGlobalProcess - SleepTime = " + sleepTimeNumber);
              return sleepTimeNumber;
            ]]></script>
          </method>
        </methodList>
      </duration>
    </schedule>
    <x>48.0</x>
    <y>55.80841</y>
    <childList>
      <child name="executeArchive" type="switchActivity">
        <label>Execute Archive</label>
        <x>271.15668</x>
        <y>43.210754</y>
        <childList>
          <child name="yes" type="caseActivity">
            <label>Yes</label>
            <x>81.0</x>
            <y>355.0</y>
            <childList>
              <child name="startArchiving" type="seqActivity">
                <label>Start Archiving</label>
                <x>425.63245</x>
                <y>50.31427</y>
                <childList>
                  <child name="existAnotherParentOrderToBeProcessed" type="switchActivity">
                    <label>Exist Another ParentOrder To Be Processed</label>
                    <x>587.0024</x>
                    <y>34.664917</y>
                    <childList>
                      <child name="yes" type="caseActivity">
                        <label>Yes</label>
                        <x>539.0</x>
                        <y>155.0</y>
                        <childList>
                          <child name="startProcessingSingleOrder" type="seqActivity">
                            <label>Start Processing Single Order</label>
                            <x>979.12866</x>
                            <y>53.14087</y>
                            <childList>
                              <child name="checkChildOrdersInGranite" type="scriptActivity">
                                <label>Check Child Orders In Granite</label>
                                <x>1300.005</x>
                                <y>30.871826</y>
                                <methodList>
                                  <method name="cwOnProcActBefore" type="action">
                                    <category>before</category>
                                    <system>true</system>
                                    <script><![CDATA[
                                      this.process.processDocument.toBeMaintained = false;
                                      this.process.processDocument.proceedWithArchive = false;


                                      var parentOrderNumber = this.process.processDocument.parentOrderNumberUnderMgmt;
                                      // getting all child orders
                                      var childOrders = ds_ws.searchOrderMessageHomeByParentOrderNumber(parentOrderNumber);

                                      var allChildrenOK = true;

                                      if(childOrders != null) {
                                          for(var i=0; i<childOrders.length && allChildrenOK; i++) {
                                              //Search for process associated to this work order, check if it's active or not
                                              var inputDocForQuery = new Document("cwf_pm:ProcessSearch");
                                              inputDocForQuery.ORDER_ID = childOrders[i].cwOrderId;
                                              inputDocForQuery.STATUS = 1;
                                              var processesFound = Finder.runFinder("cwf_pm:ProcessFinder", "select",  inputDocForQuery);
                                              if(processesFound != null && processesFound.length > 0){
                                                  allChildrenOK = false;
                                                  this.process.processDocument.toBeMaintained = true;
                                                  debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - WO " +
                                                               childOrders[i].orderNumber + " Process Is Executed For This Order: Prepare to Backup ");
                                              }
                                              else {
                                                  // for each child orders, check the status of the WO in Granite
                                                  var woStatus = granite.getStatusInGraniteForWO(childOrders[i].orderNumber);

                                                  debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - WO " +
                                                               childOrders[i].orderNumber + "; status: " + woStatus);

                                                  allChildrenOK = (woStatus == '7' || woStatus == '8') && !this.process.processDocument.toBeMaintained;
                                              }
                                          }
                                      }

                                      this.process.processDocument.proceedWithArchive = allChildrenOK;

                                      debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - " +
                                                   parentOrderNumber + " proceedWithArchive: " + this.process.processDocument.proceedWithArchive);
                                    ]]></script>
                                  </method>
                                </methodList>
                              </child>
                              <child name="canProceedWithArchive" type="switchActivity">
                                <label>Can Proceed With Archive</label>
                                <x>1303.0023</x>
                                <y>324.0</y>
                                <childList>
                                  <child name="yes" type="caseActivity">
                                    <label>Yes</label>
                                    <x>1298.4795</x>
                                    <y>513.8047</y>
                                    <childList>
                                      <child name="archiveParentOrderAndAllItsChildren" type="scriptActivity">
                                        <label>Archive Parent Order And All Its ChildOrders</label>
                                        <x>1131.4795</x>
                                        <y>473.8047</y>
                                        <methodList>
                                          <method name="cwOnProcActBefore" type="action">
                                            <category>before</category>
                                            <system>true</system>
                                            <script><![CDATA[
                                              var parentOrderNumber = this.process.processDocument.parentOrderNumberUnderMgmt;

                                              // to avoid to commit in case of error
                                              Global.beginTransaction("ORDER");

                                              // flag to understand if the entire transaction can be commited or not. Default = false for safety!!!
                                              var archivingOK = false;

                                              try {
                                                 // searching parentOrder
                                                 var parentOrderHeaderDocument = ds_ws.searchOrderMessageHomeByOrderNumber(parentOrderNumber);
                                                 if(parentOrderHeaderDocument != null) {
                                                    var parentOrder = Order.getOrderById(parentOrderHeaderDocument.cwOrderId);
                                                    if(parentOrder != null) {
                                                       // archiving parent order
                                                       var resultArchive = processSTC.archiveHomeOrder(parentOrderNumber);
                                                       if(resultArchive != null && resultArchive == "OK") {
                                                          // delete parent order
                                                          parentOrder.deleteOrder();

                                                          // processing child orders
                                                          var childOrders = ds_ws.searchOrderMessageHomeByParentOrderNumber(parentOrderNumber);
                                                          var allChildrenOK = true;
                                                          if(childOrders != null) {
                                                             for(var i=0; i<childOrders.length && allChildrenOK; i++) {
                                                                var childOrder = Order.getOrderById(childOrders[i].cwOrderId);
                                                                if(childOrder != null) {
                                                                   // archiving child order
                                                                   resultArchive = processSTC.archiveHomeOrder(childOrders[i].orderNumber);
                                                                   if(resultArchive != null && resultArchive == "OK") {
                                                                      // delete child order
                                                                      childOrder.deleteOrder();
                                                                      debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Child order " + childOrders[i].orderNumber + " archived");
                                                                   }
                                                                   else {
                                                                      // log error archive child order
                                                                      debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - ERROR IN ARCHIVING CHILD ORDER " + childOrders[i].orderNumber);
                                                                      allChildrenOK = false;
                                                                   }
                                                                }
                                                                else {
                                                                   // log error childOrder = null
                                                                   debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - ERROR IN LOADING ORDER FOR CHILD ORDER " + childOrders[i].orderNumber);
                                                                   allChildrenOK = false;
                                                                }
                                                             }
                                                          }
                                                          else {
                                                             // (childOrder == null)
                                                             debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - No child order found for " + parentOrderNumber);
                                                             allChildrenOK = true;
                                                          }

                                                          // the flag for commiting is driven by the archiving resulkt of all the child Orders (at this point parentOrder has been archived successfully!)
                                                          archivingOK = allChildrenOK;
                                                       }
                                                       else {
                                                          // log error archive parent order
                                                          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - ERROR IN ARCHIVING PARENT ORDER " + parentOrderNumber);
                                                       }
                                                    }
                                                    else {
                                                       // log error parentOrder = null
                                                       debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - ERROR IN LOADING ORDER FOR PARENT ORDER " + parentOrderNumber);
                                                    }
                                                 }
                                                 else {
                                                    debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - ERROR IN LOADING ORDER HEADER FOR PARENT ORDER " + parentOrderNumber);
                                                 }
                                              }
                                              catch(exc) {
                                                 debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Error in processing parent order " + parentOrderNumber + ": " + exc.message);
                                              }

                                              if(archivingOK) {
                                                 debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - COMMIT ARCHIVING FOR PARENT ORDER " + parentOrderNumber);
                                                 Global.commitTransaction("ORDER");
                                              }
                                              else {
                                                 debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - ROLLBACK ARCHIVING FOR PARENT ORDER " + parentOrderNumber + "; see previous logs");
                                                 Global.rollbackTransaction("ORDER");
                                              }
                                            ]]></script>
                                          </method>
                                        </methodList>
                                      </child>
                                    </childList>
                                    <methodList>
                                      <method name="cwOnProcActCond" type="action">
                                        <category>cond</category>
                                        <system>true</system>
                                        <script><![CDATA[
                                          //debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "] proceed with archive? - archiveCompletedOrdersGlobalProcess : " + this.process.processDocument.proceedWithArchive);
                                          return this.process.processDocument.proceedWithArchive;
                                        ]]></script>
                                      </method>
                                    </methodList>
                                  </child>
                                  <child name="no" type="caseActivity">
                                    <label>No</label>
                                    <x>1139.6736</x>
                                    <y>359.8484</y>
                                  </child>
                                </childList>
                              </child>
                              <child name="maintainRecordForNextIteration" type="switchActivity">
                                <label>Maintain Record For Next Iteration</label>
                                <x>957.5132</x>
                                <y>335.9519</y>
                                <childList>
                                  <child name="yes" type="caseActivity">
                                    <label>Yes</label>
                                    <x>490.0</x>
                                    <y>941.8047</y>
                                    <childList>
                                      <child name="addToTempList" type="scriptActivity">
                                        <label>Add To Temporary  List</label>
                                        <x>787.0</x>
                                        <y>492.7566</y>
                                        <methodList>
                                          <method name="cwOnProcActBefore" type="action">
                                            <category>before</category>
                                            <system>true</system>
                                            <script><![CDATA[
                                              var inputDocument = new Document("cwt_common.docID");
                                              inputDocument.cwDocID = this.process.processDocument.cwDocId_archivableOrders;
                                              var recToPark = Finder.runFinder("ds_ws.archivableOrdersByCwDocIdFinder", "select", inputDocument);

                                              if(recToPark == null || recToPark.length < 1){
                                                  debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Nothing found to move to temptable for "+ this.process.processDocument.cwDocId_archivableOrders);
                                                  return;
                                              }
                                              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Park :"+recToPark[0].orderNumber);

                                              var tempArcMsg = new Document("ds_ws.tempArchivableOrders");
                                              recToPark[0].mapTo(tempArcMsg, "ds_ws.archiveOrderToTempOrder", true, false, false, false);
                                              tempArcMsg.save();


                                              /**End parking order*/
                                            ]]></script>
                                          </method>
                                        </methodList>
                                      </child>
                                    </childList>
                                    <methodList>
                                      <method name="cwOnProcActCond" type="action">
                                        <category>cond</category>
                                        <system>true</system>
                                        <script><![CDATA[
                                          //debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - MAINTAIN?: " +this.process.processDocument.toBeMaintained);
                                          return this.process.processDocument.toBeMaintained;
                                        ]]></script>
                                      </method>
                                    </methodList>
                                  </child>
                                  <child name="no" type="caseActivity">
                                    <label>No</label>
                                    <x>804.0293</x>
                                    <y>356.45776</y>
                                  </child>
                                </childList>
                              </child>
                              <child name="deleteRecordInArchivableOrders" type="scriptActivity">
                                <label>Delete Record In ArchivableOrders</label>
                                <x>625.1636</x>
                                <y>340.8601</y>
                                <methodList>
                                  <method name="cwOnProcActBefore" type="action">
                                    <category>before</category>
                                    <system>true</system>
                                    <script><![CDATA[
                                      var inputDocument = new Document("cwt_common.docID");
                                      inputDocument.cwDocID = this.process.processDocument.cwDocId_archivableOrders;
                                      var output = Finder.runFinder("ds_ws.archivableOrdersByCwDocIdFinder", "select", inputDocument);

                                      if (output != null && output.size > 0) {
                                         var archivableOrders = output[0];
                                         archivableOrders.deleteFromDB(false);

                                      debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Deleted processed archivableOrders: " + archivableOrders.toXML());
                                      }
                                      else {
                                      debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Unable to find archivableOrders with cwdocid=" + this.process.processDocument.cwDocId_archivableOrders);
                                      }
                                    ]]></script>
                                  </method>
                                </methodList>
                              </child>
                              <child name="repeat" type="repeatActivity">
                                <element>proc_processSTC.archiveCompletedOrdersGlobalProcess/seqActivity_start/switchActivity_executeArchive/caseActivity_yes/seqActivity_startArchiving/switchActivity_existAnotherParentOrderToBeProcessed</element>
                                <label>Repeat</label>
                                <x>652.1743</x>
                                <y>227.96362</y>
                                <methodList>
                                  <method name="cwOnProcActBefore" type="action">
                                    <category>before</category>
                                    <system>true</system>
                                    <script>return;</script>
                                  </method>
                                </methodList>
                              </child>
                            </childList>
                            <methodList>
                              <method name="cwOnProcActBefore" type="action">
                                <category>before</category>
                                <system>true</system>
                                <script><![CDATA[
                                  debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Processing order " + this.process.processDocument.parentOrderNumberUnderMgmt);
                                ]]></script>
                              </method>
                            </methodList>
                          </child>
                        </childList>
                        <methodList>
                          <method name="cwOnProcActCond" type="action">
                            <category>cond</category>
                            <system>true</system>
                            <script><![CDATA[
                              var output = Finder.runFinder("ds_ws:archivableOrdersFinder", "select", null);

                              var anotherOrderToProcess = false;
                              if (output != null && output.size > 0) {
                                 anotherOrderToProcess = true;
                                 this.process.processDocument.cwDocId_archivableOrders   = output[0].cwDocId;
                                 this.process.processDocument.parentOrderNumberUnderMgmt = output[0].parentOrderNumber;
                              }
                              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Another order to be archived? " + anotherOrderToProcess);

                              return (anotherOrderToProcess);
                            ]]></script>
                          </method>
                        </methodList>
                      </child>
                      <child name="no" type="caseActivity">
                        <label>No</label>
                        <x>173.68402</x>
                        <y>1142.1707</y>
                        <childList>
                          <child name="start" type="seqActivity">
                            <label>Start</label>
                            <x>443.68402</x>
                            <y>223.17065</y>
                            <childList>
                              <child name="restoreRecordParkedInTempList" type="scriptActivity">
                                <label>Restore Record Parked In Temp List</label>
                                <x>438.68402</x>
                                <y>329.17065</y>
                                <methodList>
                                  <method name="cwOnProcActBefore" type="action">
                                    <category>before</category>
                                    <system>true</system>
                                    <script><![CDATA[
                                      /*Unpark and restore archivable orders*/
                                      var records = Finder.runFinder("ds_ws.tempArchivableOrdersFinder", "select", null);

                                      if(records == null || records.length < 1){
                                          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Archiver: Nothing to restore");
                                      }
                                      else {
                                          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - " + records.length + " archivable records to be restored");

                                          var recNumber = records.length;
                                          for( var ordN = 0; ordN < recNumber; ordN++){
                                              var arcMsg = new Document("ds_ws.archivableOrders");
                                              records[ordN].mapTo(arcMsg, "ds_ws.tempOrderToArchiveOrder",true, false, false, false);
                                              arcMsg.save();
                                              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - restored parked record # " + ordN);
                                          }

                                          for( var ordN = 0; ordN < recNumber; ordN++){
                                              records[0].deleteFromDB(false);
                                              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - deleted parked record # " + ordN);
                                          }
                                      }
                                    ]]></script>
                                  </method>
                                </methodList>
                              </child>
                            </childList>
                          </child>
                        </childList>
                      </child>
                    </childList>
                  </child>
                </childList>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActCond" type="action">
                <category>cond</category>
                <system>true</system>
                <script><![CDATA[
                  var executeArchiving = Global.getConfigVariable("EXECUTE_ARCHIVING_COMPLETED_ORDER", "NO");

                  debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Execute Archiving: " + (executeArchiving == "YES"));
                  return (executeArchiving == "YES");
                ]]></script>
              </method>
            </methodList>
          </child>
          <child name="no" type="caseActivity">
            <label>No</label>
            <x>276.00238</x>
            <y>187.06714</y>
          </child>
        </childList>
      </child>
      <child name="end" type="completeActivity">
        <label>End</label>
        <x>276.99933</x>
        <y>359.92358</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Completed!!!");
            ]]></script>
          </method>
        </methodList>
      </child>
    </childList>
    <methodList>
      <method name="cwOnProcActBefore" type="action">
        <category>before</category>
        <system>true</system>
        <script><![CDATA[
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] archiveCompletedOrdersGlobalProcess - Start ...");
        ]]></script>
      </method>
    </methodList>
  </activity>
  <curRevision>true</curRevision>
  <document>doc_processSTC.procDocumentToArchiveOrders</document>
  <label>Archive Completed Orders Global Process</label>
  <metaVersion>22</metaVersion>
  <priority>8</priority>
  <revision>2</revision>
  <type>Global</type>
</process>