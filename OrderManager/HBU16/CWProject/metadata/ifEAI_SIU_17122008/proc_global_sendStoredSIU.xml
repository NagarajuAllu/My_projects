<?xml version="1.0" encoding="UTF-8" ?>
<process name="ifEAI_SIU_17122008.global_sendStoredSIU">
  <activity name="start" type="seqActivity">
    <label>Start</label>
    <schedule type="sched">
      <duration type="dur">
        <length>P0Y0M0DT0H3M0S</length>
      </duration>
    </schedule>
    <x>50.0</x>
    <y>199.0</y>
    <childList>
      <child name="anotherRecordToBeSent" type="switchActivity">
        <label>Exist Another Record Must Be Send?</label>
        <x>233.0</x>
        <y>175.0</y>
        <childList>
          <child name="no" type="caseActivity">
            <label>No</label>
            <x>239.0</x>
            <y>40.0</y>
          </child>
          <child name="yes" type="caseActivity">
            <label>Yes</label>
            <x>0.0</x>
            <y>0.0</y>
            <childList>
              <child name="startManagingEvent" type="seqActivity">
                <label>Start Managing Event</label>
                <x>433.00003</x>
                <y>194.0</y>
                <childList>
                  <child name="sendEventToEAI" type="scriptActivity">
                    <label>Send Event To EAI</label>
                    <x>430.00003</x>
                    <y>349.0</y>
                    <methodList>
                      <method name="cwOnProcActBefore" type="action">
                        <category>before</category>
                        <system>true</system>
                        <script><![CDATA[
                          var debug      = " - SIU Global Process [Send Event To EAI] - ";
                          var resultType = "OK";

                          var receivedEvent = ds_ws.readStoredEventData(this.process.processDocument.eventDocId, "ds_jms:siteInformationUpdate_el");
                          if(receivedEvent != null) {
                                var inputSOAP = new DataStructure("ifEAI_SIU_17122008:receiveRequest_el");
                                var outputSOAP = null;

                                // - mapping the input JMS message vs. input SOAP message
                                inputSOAP.SiteInformationUpdate.BusinessUnit = "Home";
                                inputSOAP.SiteInformationUpdate.PlateID = receivedEvent.ccliCode;
                                inputSOAP.SiteInformationUpdate.City = receivedEvent.city;
                                inputSOAP.SiteInformationUpdate.Country = receivedEvent.country;
                                inputSOAP.SiteInformationUpdate.District = receivedEvent.district;
                                inputSOAP.SiteInformationUpdate.Region = receivedEvent.region;
                                inputSOAP.SiteInformationUpdate.SiteID = receivedEvent.siteID;
                                inputSOAP.SiteInformationUpdate.SiteName = receivedEvent.siteName;
                                inputSOAP.SiteInformationUpdate.SiteType = receivedEvent.siteType;
                                inputSOAP.SiteInformationUpdate.Status = receivedEvent.status;
                                inputSOAP.SiteInformationUpdate.POBox = "";                                                // TO BE MAPPED....
                                // Modified on 24.02.2009:
                                // - added three new fields: CityCode, DistrictCode, ExchangeCode
                                inputSOAP.SiteInformationUpdate.CityCode = receivedEvent.cityCode;
                                inputSOAP.SiteInformationUpdate.DistrictCode = receivedEvent.districtCode;
                                inputSOAP.SiteInformationUpdate.ExchangeCode = receivedEvent.exchangeCode;

                                if (receivedEvent.unitNumber != null && receivedEvent.unitNumber.length > 0) {
                                      for (var j = 0; j < receivedEvent.unitNumber.length; j++) {
                                            inputSOAP.SiteInformationUpdate.UnitNumbers.ArrayOfstringItem[j] = receivedEvent.unitNumber[j];
                                      }
                                }

                                try {
                          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "]" + debug + "INVOKING INTERFACE WITH DATA " + inputSOAP.toXML());
                          //  MR 2014/06/13 - changed operation name to make the data sent out compliant with CW 4.2.2
                          //                  outputSOAP = Global.invokeInterface("ifEAI_SIU_17122008:SIU", "SiteInformationUpdate", inputSOAP);
                                            outputSOAP = Global.invokeInterface("ifEAI_SIU_17122008:SIU", "receiveRequest", inputSOAP);

                                            if(outputSOAP != null && outputSOAP.length == 1) {
                          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "]" + debug + "RESULT: " + outputSOAP[0].toXML() + "...");

                                                  resultType = "OK";
                                            }
                                            else {
                                                  if(outputSOAP == null) {
                          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "]" + debug + "outputSoap is null....");
                                                        resultType = "NOT_SUCCESS_EAI";
                                                  }
                                                  else {
                          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "]" + debug + "Received " + outputSOAP.length + " items from EAI");
                                                        for(var i=0; i<outputSOAP.length; i++) {
                          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "]" + debug + "Received[" + i + "]: " + outputSOAP[i].toXML());
                                                        }
                                                        resultType = "OK";

                                                        // ignoring the result of the invocation ...
                                                        // resultType = "NOT_SUCCESS_EAI";
                                                  }
                                            }
                                      }
                                      catch (exc){
                          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "]" + debug + "EXCEPTION: " + exc.message);

                                            if(exc.message.indexOf("XE0023") >= 0) {
                          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "]" + debug + "I/F getDelay = " + Global.getInterfaceDelay(this.process.processDocument.interfaceName));
                                                  resultType = "NOT_AVAILABLE_EXPD";
                                            }
                                            else {
                                                  resultType = "NOT_AVAILABLE_EAI";
                                            }
                                      }


                                      var configEnableReport = Global.getConfigVariable("SIU_ENABLE_REPORT", "N");

                                      if(configEnableReport == "Y") {
                                          var resultMsg = (resultType == "OK" ? "SUCCESS" : "FAILURE");
                                          var errorType = resultType;
                                          var errorDescription = null;
                                          if(resultType == "OK" && outputSOAP != null) {
                                              resultMsg = outputSOAP[0].Status;
                                              errorType = outputSOAP[0].ErrorType;
                                              errorDescription = outputSOAP[0].ErrorDescription;
                                          }

                                          // saving siuInfoForReport
                                          graniteReport.storeSIUInfoForReport(this.process.processDocument.eventDocId,
                                                                              new Date(),
                                                                              inputSOAP.SiteInformationUpdate.PlateID,
                                                                              inputSOAP.SiteInformationUpdate.SiteID,
                                                                              resultMsg,
                                                                              errorType,
                                                                              errorDescription);
                                      }
                                }

                          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "]" + debug + "resultInvoke: " + resultType + "...");


                                if(resultType == "OK") {
                                      ds_ws.deleteStoredEvent(this.process.processDocument.eventDocId);
                                }
                                else {
                                      ds_ws.updateLastSentDateInStoredEvent(this.process.processDocument.eventDocId);
                                }

                                this.process.processDocument.resultType = resultType;
                        ]]></script>
                      </method>
                    </methodList>
                  </child>
                  <child name="wait" type="scriptActivity">
                    <label>Wait</label>
                    <schedule type="sched">
                      <duration type="dur">
                        <methodList>
                          <method name="cwOnDuration" type="action">
                            <system>true</system>
                            <script>return ds_ws.computeDelayForEAIGlobalProcesses(this.processDocument, this.id);</script>
                          </method>
                        </methodList>
                      </duration>
                    </schedule>
                    <x>339.00003</x>
                    <y>359.0</y>
                    <methodList>
                      <method name="cwOnProcActBefore" type="action">
                        <category>before</category>
                        <system>true</system>
                        <script>return;</script>
                      </method>
                    </methodList>
                  </child>
                  <child name="repeat" type="repeatActivity">
                    <element>proc_ifEAI_SIU_17122008.global_sendStoredSIU/seqActivity_start/switchActivity_anotherRecordToBeSent</element>
                    <label>Repeat</label>
                    <x>236.00003</x>
                    <y>359.0</y>
                  </child>
                </childList>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActCond" type="action">
                <category>cond</category>
                <system>true</system>
                <script><![CDATA[
                  var found = false;
                  var result = ds_ws.searchFirstStoredGraniteEventByType(this.process.processDocument.eventType);
                  if(result != null) {
                        this.process.processDocument.eventDocId = result.cwDocId;
                        found = true;

                  debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] - SIU Global Process - Found new event with id " + this.process.processDocument.eventDocId);

                        }

                        return (found);
                ]]></script>
              </method>
            </methodList>
          </child>
        </childList>
      </child>
      <child name="end" type="completeActivity">
        <label>End</label>
        <x>443.0</x>
        <y>40.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] End Global for SIU...");
            ]]></script>
          </method>
        </methodList>
      </child>
    </childList>
    <methodList>
      <method name="cwOnProcActBefore" type="action">
        <category>before</category>
        <system>true</system>
        <script><![CDATA[
          debugPrintln("[" + ds_ws.common_currentDateAsStringDDMMYYYYHH24MISS() + "][" + this.process.id + "] Start Global for SIU...");


                this.process.processDocument.eventType  = "SIU";
                this.process.processDocument.interfaceName = "ifEAI_SIU_17122008:SIU";
                this.process.processDocument.eventDocId = null;
                this.process.processDocument.resultType = null;
        ]]></script>
      </method>
    </methodList>
  </activity>
  <curRevision>true</curRevision>
  <document>doc_ds_ws.eaiGlobalProcessDocument</document>
  <highlight>10</highlight>
  <label>Global - Send Stored SIU Events</label>
  <metaVersion>22</metaVersion>
  <priority>8</priority>
  <revision>2</revision>
  <type>Global</type>
</process>