<?xml version="1.0" encoding="UTF-8" ?>
<script name="wgws.processReceivedLoadSubOrders">
  <label>Process Received LoadSubOrders</label>
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="input" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var debug = "[Process Received 'LoadSubOrders'] ";

    var parentOrderNumber = input.parentOrderNumber;
    var workOrderNumber = input.orderNumber;

    var lineItem = stcw.getLineItemByCOMOrderNumberAndWONumber(parentOrderNumber, workOrderNumber);

    if(lineItem != null) {
        var orchestrationRecord = stcw.getRecordInOrchestrationTableByLineItemId(lineItem.id);
        if(orchestrationRecord != null) {
            var provisioningProcessId = orchestrationRecord.provisioningProcessId;
            if(provisioningProcessId != null) {

                var processInstance = Process.getProcessInfo(provisioningProcessId);
                if(processInstance != null) {
                    if(processInstance.processStatus == 8) {
                        // the process is in status 8, so STALE; resume it
                        debugPrintln(stcc.getSysdateForLog() + debug + "Resuming Stale process " + provisioningProcessId);
                        Process.resumeAllStaleProcesses(provisioningProcessId);
                    }
                }

                var loadSubOrdersNotificationDS = new DataStructure("stcw.loadSubOrdersNotificationDS");
                loadSubOrdersNotificationDS.comOrderNumber = parentOrderNumber;
                loadSubOrdersNotificationDS.workOrderNumber = workOrderNumber;
                loadSubOrdersNotificationDS.workOrderRemarks = input.comments;

                debugPrintln(stcc.getSysdateForLog() + debug + "Sending 'LoadSubOrders' Notification for <" + parentOrderNumber + "," + workOrderNumber + "> to process " + provisioningProcessId);
                Process.sendMessageToProcess(provisioningProcessId, null, "stcw.xngServicesNotificationToProcesses/loadSubOrdersNotification", loadSubOrdersNotificationDS);
            }
            else {
                debugPrintln(stcc.getSysdateForLog() + debug + "WARNING - Unable to find Provisioning Process for received granite 'LoadSubOrders' Notification for <" + parentOrderNumber + "," + workOrderNumber + ">; ignoring it");
            }
        }
        else {
            debugPrintln(stcc.getSysdateForLog() + debug + "WARNING - Unable to find process for <" + parentOrderNumber + "," + workOrderNumber + ">");
        }
    }
    else {
        debugPrintln(stcc.getSysdateForLog() + debug + "WARNING - Unable to find LineItem for received granite 'LoadSubOrders' Notification for <" + parentOrderNumber + "," + workOrderNumber + ">; ignoring it");
    }
  ]]></script>
</script>