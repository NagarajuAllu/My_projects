<?xml version="1.0" encoding="UTF-8" ?>
<script name="crmToSOMMigration.migrateCRMInstallQuotes">
  <label>Migrate CRM Install Quotes</label>
  <metaVersion>25</metaVersion>
  <script><![CDATA[
    var debug = " migrateCRMInstallQuotes - ";
    var quoteType = "I";
    var countFound = 0;
    var countTotalMigrated = 0;
    var countMigratedWithValidationError = 0;
    var countMigratedSuccessfully = 0;
    var countMigratedFailed = 0;

    var allORBOrderHeaders = crmToSOMMigration.getAllORBOrderHeaderByQuoteType(quoteType);

    if(allORBOrderHeaders != null) {
    debugPrintln(stcc.getSysdateForLog() + debug + "Install quotes to be migrated: " + allORBOrderHeaders.length);
        countFound = allORBOrderHeaders.length;

        for(var i=0; i<allORBOrderHeaders.length; i++) {
    debugPrintln(stcc.getSysdateForLog() + debug + "Started quote #" + i + "; docid = " + allORBOrderHeaders[i].id + "; orderId = " + allORBOrderHeaders[i].orderId + "; orderNumber = " + allORBOrderHeaders[i].orderNumber);

            var crmQuote = null;
            try {
                crmQuote = Order.getOrderById(allORBOrderHeaders[i].orderId, false);
            }
            catch(exc) {
                var errMsg = Global.translateText("AE0052", null, allORBOrderHeaders[i].orderId) + "; Exc message = " + exc.message;
    debugPrintln(stcc.getSysdateForLog() + debug + "Failed Migration quote #" + i + "; docid = " + allORBOrderHeaders[i].id + "; orderId = " + allORBOrderHeaders[i].orderId + "; Unexpected error: " + errMsg);

                crmQuote = null;
            }

            if(crmQuote != null) {
                var versionsInSequence = crmToSOMMigration.getVersionIDsInSequence(allORBOrderHeaders[i].orderId);

                var previousOrder = null;
                var currentOrder = null;
                var versionHeader = null;

                var quantity = ((crmQuote.header.quantity != null &&  crmQuote.header.quantity > 0) ? crmQuote.header.quantity : 1);
                var currentOrderArray = null;
                var previousOrderArray = null;
                var parentLineItemArray = null;
                var parentLineItemProvFlagArray = null;

                for(var j=0; j<versionsInSequence.length; j++) {
                    versionHeader = Document.readDoc("stcw.versionHeader", versionsInSequence[j].cwDocID);
                    if(j > 0) {
                        previousOrder = currentOrder;

                        previousOrderArray = currentOrderArray;
                    }

                    currentOrder = crmToSOMMigration.migrateVersionForQuote(crmQuote, versionHeader.versionName, j);

                    if(currentOrder != null) {
                        if(currentOrder.orderHeader.orderNumber != crmQuote.header.quoteNumber) {
                            var errMsg = Global.translateText("AE0162", null, [crmQuote.header.quoteNumber, currentOrder.orderHeader.orderNumber]);
    debugPrintln(stcc.getSysdateForLog() + debug + "Failed Migration quote #" + i + "; docid = " + allORBOrderHeaders[i].id + "; orderId = " + allORBOrderHeaders[i].orderId + "; Unexpected error: " + errMsg);

    crmToSOMMigration.logMigrationRecord(false, allORBOrderHeaders[i].id, crmQuote.header.quoteNumber, quoteType, 2, errMsg);
                            countMigratedFailed++;

                            // discarding migrated order
                            currentOrder = null;
                        }
                        else if(currentOrder.orderHeader.feasibilityFor != "INSTALL") {
                            var errMsg = Global.translateText("AE0164", null, ["INSTALL", currentOrder.orderHeader.feasibilityFor]);
    debugPrintln(stcc.getSysdateForLog() + debug + "Failed Migration quote #" + i + "; docid = " + allORBOrderHeaders[i].id + "; orderId = " + allORBOrderHeaders[i].orderId + "; Unexpected error: " + errMsg);

    crmToSOMMigration.logMigrationRecord(false, allORBOrderHeaders[i].id, crmQuote.header.quoteNumber, quoteType, 2, errMsg);
                            countMigratedFailed++;

                            // discarding migrated order
                            currentOrder = null;
                        }
                        else {
                            var searchDoc = new Document("stcw.search_bundleOrder");
                            searchDoc.orderNumber = currentOrder.orderHeader.orderNumber;
                            searchDoc.isMigrated  = true;
                            var orderListFound = Finder.runFinder("stcw.findAllSTCBundleOrders_Script", "select", searchDoc);
                            if(orderListFound != null && orderListFound.length > 0) {
                                if(orderListFound[0].id != currentOrder.id) {
                                    if(previousOrder == null || previousOrder.id != orderListFound[0].id) {
                                        var errMsg = "Unexpected error: Already exists an order with orderNumber " + currentOrder.orderHeader.orderNumber + " - id: " + orderListFound[0].id;
    debugPrintln(stcc.getSysdateForLog() + debug + "Failed Migration quote #" + i + "; docid = " + allORBOrderHeaders[i].id + "; orderId = " + allORBOrderHeaders[i].orderId + "; " + errMsg);

    crmToSOMMigration.logMigrationRecord(false, allORBOrderHeaders[i].id, crmQuote.header.quoteNumber, quoteType, 2, errMsg);
                                        countMigratedFailed++;

                                        currentOrder = null;
                                    }
                                }
                            }
                        }
                    }
                    else {
    debugPrintln(stcc.getSysdateForLog() + debug + "Failed Migration quote #" + i + "; docid = " + allORBOrderHeaders[i].id + "; orderId = " + allORBOrderHeaders[i].orderId + "; Returned NULL object in migration of version " + versionHeader.versionName);
    crmToSOMMigration.logMigrationRecord(false, allORBOrderHeaders[i].id, crmQuote.header.quoteNumber, quoteType, 2, "Returned NULL object in migration of version " + versionHeader.versionName);
                        countMigratedFailed++;
                    }

                    if(currentOrder != null) {
                        var validationErrors = currentOrder.validate(1000, true);
                        if(validationErrors != null) {
                            countMigratedWithValidationError++

                            // migrated order is not valid
    debugPrintln(stcc.getSysdateForLog() + debug + "Quote #" + i + "; Migrated Order.id: " + currentOrder.orderHeader.orderNumber + " - ValidationErrors: ");
                            for(var k=0; k<validationErrors.length; k=k+2) {
                                debugPrintln(("" + k/2).leftPad(4, " ") + ". - " + validationErrors[k] + " = " + validationErrors[k+1]);
                            }
                        }

                        currentOrderArray = new Array();

                        // managing case in which the quantity is greater than 1
                        if(quantity > 1) {
                            // in such case, change the orderNumber and the lineItemIdentifer before adding to the array
                            // updateOrderForQuantity_(currentOrder, 0);
                            // currentOrderArray.push(currentOrder);
                            for(var x=0; x<quantity; x++) {
                                var clonedOrder = currentOrder.copyOrder(false);
                                updateOrderForQuantity_(clonedOrder, x);
                                currentOrderArray.push(clonedOrder);
                            }
                        }
                        else {
                            // in such case, NO NEED TO change the orderNumber and the lineItemIdentifer before adding to the array
                            currentOrderArray.push(currentOrder);
                        }

                        if(j==0) {
                            // searching the order with the same reservationNumber
                            var lineItems = stcw.getAllLineItemIdsPendingOrActiveByReservNumber(currentOrderArray[0].parentLineItems[0].parentLineItem.reservationNumber);
                            if(lineItems != null) {
                                for(var x=0; x<lineItems.length; x++) {
                                    if(parentLineItemArray == null) {
                                        parentLineItemArray = new Array();
                                        parentLineItemProvFlagArray = new Array()
                                    }
                                    parentLineItemArray.push(lineItems[x].result);

                                    var lineItemsActive = stcw.getAllLineItemsByIdentifierAndProvisioningFlag(lineItems[x].result, "B", "ACTIVE");
                                    if(lineItemsActive != null && lineItemsActive.length > 0) {
                                        parentLineItemProvFlagArray.push("ACTIVE");
                                    }
                                    else {
                                        parentLineItemProvFlagArray.push("PROVISIONING");
                                    }
                                }
                            }
                        }

                        if(parentLineItemArray != null) {
                            // changing the parentLineItemId using the found one
                            for(var x=0; x<parentLineItemArray.length; x++) {
                                if(currentOrderArray.length > x) {
                                    currentOrderArray[x].parentLineItems[0].parentLineItem.lineItemIdentifier = parentLineItemArray[x];
                                    if(parentLineItemProvFlagArray[x] == "ACTIVE") {
                                        // the order linked to the reservation is active, so the provisioning flag for the reservation is "OLD" for sure
                                        currentOrderArray[x].parentLineItems[0].parentLineItem.provisioningFlag = "OLD";
                                    }
                                    else {
                                        // there is an order linked to the reservation but still in provisioning so the provisioning flag for the reservation is "ACTIVE" for sure
                                        currentOrderArray[x].parentLineItems[0].parentLineItem.provisioningFlag = "ACTIVE";
                                    }
                                }
                                else {
    debugPrintln(stcc.getSysdateForLog() + debug + "Quote #" + i + "; Migrated Order.id: " + currentOrder.id + " - WARNING!!! Found more parentLineItems [" + parentLineItemArray.length + "] that quantity [" + currentOrderArray.length + "]");
                                }
                            }
                        }
                        countTotalMigrated += quantity;

                        for(var x=0; x<currentOrderArray.length; x++) {
                            var orchestrationError = stcw.writeSequenceForOrder(currentOrderArray[x]);
                            if(orchestrationError != null) {
                                for(var k=0; k<orchestrationError.length; k++) {
    debugPrintln(stcc.getSysdateForLog() + debug + "Quote #" + i + "; Migrated Order.id: " + currentOrderArray[x].id + " - Error in creating orchestration records: " +
                 "<" + orchestrationError[k].ErrorCode + "," + orchestrationError[k].ErrorDescription + ">");
                                }
                            }
                            else {
                                countMigratedSuccessfully++;
                            }

                            if(previousOrderArray != null) {
                                // archiving old version of the order
                                previousOrderArray[x].orderHeader.orderNumber = previousOrderArray[x].orderHeader.orderNumber +
                                                                                (versionHeader.versionName == "CANCEL" ? "_CANC_" : "_REVI_") +
                                                                                Calendar.formatDate(versionHeader.cwCreated, "yyyyMMddHHmmss");
                                previousOrderArray[x].parentLineItems[0].parentLineItem.provisioningFlag = "OLD";
                                previousOrderArray[x].save();

                                stcw.updateOrchestrationRecordsForNewOrderNumber(previousOrderArray[x], previousOrderArray[x].orderHeader.orderNumber);
                            }
                            currentOrderArray[x].save();
                        }
                    }
                }

                if(currentOrderArray != null) {
                    for(var x=0; x<currentOrderArray.length; x++) {
                        currentOrderArray[x].parentLineItems[0].parentLineItem.lineItemStatus = crmQuote.header.quoteStatus;
                        if(crmQuote.header.completedDate != null) {
                            currentOrderArray[x].parentLineItems[0].parentLineItem.completionDate = crmQuote.header.completedDate;
                            if(currentOrderArray[x].parentLineItems[0].parentLineItem.provisioningFlag == "PROVISIONING") {
                                currentOrderArray[x].parentLineItems[0].parentLineItem.provisioningFlag = (versionHeader.versionName == "CANCEL" ? "CANCELLED" : "ACTIVE");
                            }

                            currentOrderArray[x].orderHeader.completionDate = crmQuote.header.completedDate;
                            currentOrderArray[x].orderHeader.orderStatus = (versionHeader.versionName == "CANCEL" ? "CANCELLED" : "COMPLETED");
                        }
                        currentOrderArray[x].save();
                    }

                    crmQuote.header.migrated = 1;
    crmToSOMMigration.logMigrationRecord(false, allORBOrderHeaders[i].id, crmQuote.header.quoteNumber, quoteType, 1, null);
                }
                else {
                    crmQuote.header.migrated = 2;
                }
                crmQuote.save();
            }
            else {
    debugPrintln(stcc.getSysdateForLog() + debug + "Unable to load quote #" + i + "; docid = " + allORBOrderHeaders[i].id + "; orderId = " + allORBOrderHeaders[i].orderId);
    crmToSOMMigration.logMigrationRecord(false, allORBOrderHeaders[i].id, allORBOrderHeaders[i].orderNumber, quoteType, 3, "Unable to load quote #" + i + "; docid = " + allORBOrderHeaders[i].id + "; orderId = " + allORBOrderHeaders[i].orderId);
                countMigratedFailed++;

                // search CRM QuoteHeader and set migrated = 3
                var crmQuoteHeader = Document.readDoc("stcw.quoteHeader", allORBOrderHeaders[i].id);
                if(crmQuoteHeader != null) {
                    crmQuoteHeader.migrated = 3;
                    crmQuoteHeader.save();
                }
            }
        }
    }

    var result = new Array();
    result[0] = countFound;
    result[1] = countTotalMigrated;
    result[2] = countMigratedWithValidationError;
    result[3] = countMigratedSuccessfully;
    result[4] = countMigratedFailed;

    return result;


    function updateOrderForQuantity_(order, index) {
        order.orderHeader.orderNumber = order.orderHeader.orderNumber + "#" + index;
        order.parentLineItems[0].parentLineItem.lineItemIdentifier = order.parentLineItems[0].parentLineItem.lineItemIdentifier + "#" + index;
    }
  ]]></script>
</script>