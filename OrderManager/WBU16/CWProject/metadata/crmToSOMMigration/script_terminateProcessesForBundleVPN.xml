<?xml version="1.0" encoding="UTF-8" ?>
<script name="crmToSOMMigration.terminateProcessesForBundleVPN">
  <label>Terminate Processes For Bundle VPN</label>
  <metaVersion>25</metaVersion>
  <script><![CDATA[
    var debug = " terminateProcessesForBundleVPN - ";

    var totalProcessTerminated = 0;

    // searching the distinct cwOrderId of all the Bundle orders that have processes running
    var foundVPNOrdersToMigrateList = Finder.runFinder("crmToSOMMigration.getAllDistinctOrderDataForBundleRunning", "select", null);
    if(foundVPNOrdersToMigrateList != null && foundVPNOrdersToMigrateList.length > 0) {
        for (var i=0; i<foundVPNOrdersToMigrateList.length; i++) {
    debugPrintln(stcc.getSysdateForLog() + debug + "Found VPN Order <" + foundVPNOrdersToMigrateList[i].orderNumber + "," + foundVPNOrdersToMigrateList[i].cwOrderId + "> with processes still running: " + foundVPNOrdersToMigrateList[i].countProcessRunning);

            var inputDocForQuery = new Document("cwf_pm:ProcessSearch");
            inputDocForQuery.ORDER_ID = foundVPNOrdersToMigrateList[i].cwOrderId;

            var processFinder = Finder.runFinder("cwf_pm:ProcessFinder", "select",  inputDocForQuery);
            if (processFinder != null && processFinder.length > 0) {
                for(var p=0; p<processFinder.length; p++) {
    debugPrintln(stcc.getSysdateForLog() + debug + "Found " + processFinder.length + " processes for VPN Order <" + foundVPNOrdersToMigrateList[i].orderNumber + "," + foundVPNOrdersToMigrateList[i].cwOrderId + ">");
                    if(processFinder[p].STATUS != 3 && processFinder[p].STATUS != 6) {
    debugPrintln(stcc.getSysdateForLog() + debug + "Terminating process " + processFinder[p].PROCESS_ID + " VPN Order <" + foundVPNOrdersToMigrateList[i].orderNumber + "," + foundVPNOrdersToMigrateList[i].cwOrderId + ">");
                        Process.stopProcess(processFinder[p].PROCESS_ID);
                        Process.terminateProcess(processFinder[p].PROCESS_ID);

                        totalProcessTerminated++;
    debugPrintln(stcc.getSysdateForLog() + debug + "Terminated process " + processFinder[p].PROCESS_ID + " VPN Order <" + foundVPNOrdersToMigrateList[i].orderNumber + "," + foundVPNOrdersToMigrateList[i].cwOrderId + ">");
                    }
                    else {
                        // do nothing
                    }
                }
            }
            else {
    debugPrintln(stcc.getSysdateForLog() + debug + "No processes found for VPN Order <" + foundVPNOrdersToMigrateList[i].orderNumber + "," + foundVPNOrdersToMigrateList[i].cwOrderId + ">");
            }
        }
    }
    else {
    debugPrintln(stcc.getSysdateForLog() + debug + "No orders found with processes running");
    }

    return totalProcessTerminated;
  ]]></script>
</script>