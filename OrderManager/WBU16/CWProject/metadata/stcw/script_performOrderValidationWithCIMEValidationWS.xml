<?xml version="1.0" encoding="UTF-8" ?>
<script name="stcw.performOrderValidationWithCIMEValidationWS">
  <label>Perform Order Validation With CIM-E Validation WebService</label>
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="bundleOrder" type="rifp">
      <type>order_stcw.wholesaleBundleOrderSTC</type>
    </parameter>
    <parameter name="isSubmit" type="rifp">
      <type>dtype_com.conceptwave.system.Boolean</type>
    </parameter>
    <parameter name="failureArray" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var validationItemArray = stcw.generateInputDataForCIMEValidationWS(bundleOrder);

    if(validationItemArray != null && validationItemArray.length > 0) {

        var inputDS = new DataStructure("cimeValidationWS.validate");
        for(var i=0; i<validationItemArray.length; i++) {
            inputDS.arg0.validationItem[i] = validationItemArray[i];
        }
        var resultDS =  null;

        try {
            resultDS = stcc.sendDataToInterfaceWithLogging(inputDS, "cimeValidationWS.ValidationService", "validate", true, null, "InvokeValidationWSInGranite", bundleOrder.orderHeader.orderNumber, null);
        }
        catch(exc) {
            var errorType = "Application";

            if(exc.message.indexOf("XE0023") >= 0 || exc.message.indexOf("XE0002")) {
    debugPrintln(stcc.getSysdateForLog() + " performOrderValidationInGranite (" + bundleOrder.orderHeader.orderNumber + "): Interface Error while invoking Granite WS: " + exc.message);
                errorType = "Interface";
            }
            else {
    debugPrintln(stcc.getSysdateForLog() + " performOrderValidationInGranite (" + bundleOrder.orderHeader.orderNumber + "): Application Error while invoking Granite WS: " + exc.message);
                errorType = "Application";
            }

            var validationErrors = ["AE0054", Global.translateText("AE0054", null, [errorType, bundleOrder.orderHeader.orderNumber, exc.message])];
            failureArray = stcw.addValidationErrorsToFailureArray(validationErrors, bundleOrder.orderHeader.orderNumber, failureArray, "VALIDATION ERROR IN GRANITE", (isSubmit ? "SUBMIT ORDER" : "UPDATE ORDER"), "EOC_XNG");
        }

        if(resultDS != null) {
            for(var i=0; i<resultDS.return.validationResponseItem.length; i++) {
                if(resultDS.return.validationResponseItem[i].result == "Rejected") {
                    var validationErrors = new Array();
                    var counter = 0;
                    for(var j=0; j<resultDS.return.validationResponseItem[i].failure.length; j++) {
                        validationErrors[counter++] = resultDS.return.validationResponseItem[i].failure[j].errorCode;
                        validationErrors[counter++] = resultDS.return.validationResponseItem[i].failure[j].errorDescription;
                    }

    debugPrintln(stcc.getSysdateForLog() + " performOrderValidationInGranite (" + resultDS.return.validationResponseItem[i].lineItemIdentifier + "): Granite WS Rejection reasons: [" + validationErrors + "]");
                    failureArray = stcw.addValidationErrorsToFailureArray(validationErrors, resultDS.return.validationResponseItem[i].lineItemIdentifier, failureArray, "VALIDATION ERROR IN GRANITE", (isSubmit ? "SUBMIT ORDER" : "UPDATE ORDER"), "EOC_XNG");
                }
            }
        }
    }

    return failureArray;
  ]]></script>
</script>