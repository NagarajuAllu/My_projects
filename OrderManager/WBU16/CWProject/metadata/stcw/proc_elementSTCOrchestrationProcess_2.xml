<?xml version="1.0" encoding="UTF-8" ?>
<process name="stcw.elementSTCOrchestrationProcess_2">
  <activity name="start" type="seqActivity">
    <label>Start</label>
    <x>20.0</x>
    <y>34.0</y>
    <childList>
      <child name="setProcessIdInOrchestrationTable" type="scriptActivity">
        <label>Set Process Id In Orchestration Table</label>
        <x>123.0</x>
        <y>10.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              var recordInOrchestrationTable = stcw.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);
              recordInOrchestrationTable.orchestrationProcessId = this.process.id;
              recordInOrchestrationTable.save();
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="isActionDeleteOrSuspend" type="switchActivity">
        <label>Is Action = &quot;Delete&quot; or &quot;Suspend&quot;?</label>
        <x>128.0</x>
        <y>180.0</y>
        <childList>
          <child name="deleteOrSuspend" type="caseActivity">
            <label>Delete or Suspend Action</label>
            <x>135.0</x>
            <y>324.0</y>
            <childList>
              <child name="startDelete_Suspend" type="seqActivity">
                <label>Start Workflow for Delete or Suspend</label>
                <x>125.0</x>
                <y>552.0</y>
                <childList>
                  <child name="hasChildElements" type="switchActivity">
                    <label>Has Child Elements?</label>
                    <x>317.0</x>
                    <y>548.0</y>
                    <childList>
                      <child name="yes" type="caseActivity">
                        <label>Yes</label>
                        <x>310.0</x>
                        <y>567.0</y>
                        <childList>
                          <child name="start" type="seqActivity">
                            <label>Start</label>
                            <x>323.0</x>
                            <y>692.0</y>
                            <childList>
                              <child name="performProvisioningOfAllChildElements_Delete" type="subflowActivity">
                                <element>proc_stcw.performProvisioningOfAllChildElements_Delete</element>
                                <label>Perform Provisioning Of All Child Elements - Delete_Suspend</label>
                                <x>773.0</x>
                                <y>644.0</y>
                                <methodList>
                                  <method name="cwOnProcActBefore" type="action">
                                    <category>before</category>
                                    <system>true</system>
                                    <script><![CDATA[
                                      var elementTypeInOrderTree = this.process.processOrderItem.elementTypeInOrderTree;
                                      if(elementTypeInOrderTree == "B") {
                                          this.process.processDocument.elementTypeInOrderTree = "C";
                                      }
                                      else if(elementTypeInOrderTree == "C") {
                                          this.process.processDocument.elementTypeInOrderTree = "S";
                                      }
                                      else if(elementTypeInOrderTree == "S") {
                                          this.process.processDocument.elementTypeInOrderTree = "T";
                                      }

                                      debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - starting OrchestrationWorkflowForChildElement with ElementType = " + this.process.processDocument.elementTypeInOrderTree);
                                    ]]></script>
                                  </method>
                                </methodList>
                              </child>
                            </childList>
                          </child>
                        </childList>
                        <methodList>
                          <method name="cwOnProcActCond" type="action">
                            <category>cond</category>
                            <system>true</system>
                            <script><![CDATA[
                              var childElementsList = stcw.findRecordsInOrchTabByOrderId_ParentId(this.process.processOrder.id, this.process.processOrderItem.id);

                              debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - childElementsList.length= " + childElementsList.length);

                              return (childElementsList != null && childElementsList.length > 0);
                            ]]></script>
                          </method>
                        </methodList>
                      </child>
                      <child name="no" type="caseActivity">
                        <label>No</label>
                        <x>497.0</x>
                        <y>552.0</y>
                      </child>
                    </childList>
                  </child>
                  <child name="isElementProvisionable" type="switchActivity">
                    <label>isElementProvisionable</label>
                    <x>743.0</x>
                    <y>551.0</y>
                    <childList>
                      <child name="yes" type="caseActivity">
                        <label>Yes</label>
                        <x>596.0</x>
                        <y>553.0</y>
                        <childList>
                          <child name="start" type="seqActivity">
                            <label>Start</label>
                            <x>941.0</x>
                            <y>551.0</y>
                            <childList>
                              <child name="existProcessKOInOrchestration" type="switchActivity">
                                <label>Is There Process KO In Orchestration?</label>
                                <x>1045.0</x>
                                <y>529.0</y>
                                <childList>
                                  <child name="yes" type="caseActivity">
                                    <label>Yes</label>
                                    <x>1045.0</x>
                                    <y>629.0</y>
                                    <childList>
                                      <child name="skipParentDueToProcessKO" type="scriptActivity">
                                        <label>Skip Parent Due To Process KO</label>
                                        <x>1290.0</x>
                                        <y>529.0</y>
                                        <methodList>
                                          <method name="cwOnProcActBefore" type="action">
                                            <category>before</category>
                                            <system>true</system>
                                            <script><![CDATA[
                                              debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - startingProvisioningProcessForElement: Found at least one process completed with KO, so skipping children");
                                            ]]></script>
                                          </method>
                                        </methodList>
                                      </child>
                                    </childList>
                                    <methodList>
                                      <method name="cwOnProcActCond" type="action">
                                        <category>cond</category>
                                        <system>true</system>
                                        <script><![CDATA[
                                          var existKO = stcw.checkIfExistProcessKOInOrchestrationTable(this.process.processOrder.id);

                                          if(!existKO) {
                                              debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Don't exist KO for order; checking if quoteLineItem is failed");
                                              existKO = stcw.checkIfLineItemIsNotFeasibleForQuote(this.process.processOrderItem.lineItemStatus.toUpperCase(), this.process.processOrder.orderHeader.orderType);
                                          }

                                          debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - breaking execution because exists KO or quoteItem is failed");

                                          return existKO;
                                        ]]></script>
                                      </method>
                                    </methodList>
                                  </child>
                                  <child name="no" type="caseActivity">
                                    <label>No</label>
                                    <x>1045.0</x>
                                    <y>629.0</y>
                                    <childList>
                                      <child name="start" type="seqActivity">
                                        <label>Start</label>
                                        <x>1062.0</x>
                                        <y>692.0</y>
                                        <childList>
                                          <child name="startProvisioningProcessForElement" type="scriptActivity">
                                            <label>Start Provisioning Process For Element</label>
                                            <x>1189.0</x>
                                            <y>655.0</y>
                                            <methodList>
                                              <method name="cwOnProcActBefore" type="action">
                                                <category>before</category>
                                                <system>true</system>
                                                <script><![CDATA[
                                                  debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - startingProvisioningProcessForElement: " + this.process.processOrderItem.id);

                                                  var processName = "stcw.mainSTCWProvisiongProcess_5";
                                                  if(this.process.processOrderItem.provisioningBU == "W" && this.process.processOrder.orderHeader.orderType == "F" && this.process.processOrderItem.action != "D") {
                                                      processName = "stcw.mainSTCWQuoteProvisioningProcess_4";
                                                  }

                                                  else if(this.process.processOrderItem.provisioningBU == "M") {
                                                      processName = "stcw.mobileSTCWProvisioningProcess";
                                                  }

                                                  var pid = Process.startProcess(processName, this.process.processOrder.id, this.process.processOrderItem.id);
                                                  debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - startedProvisioningProcess: " + pid + "; type: " + processName + "; element: " + this.process.processOrderItem.id);


                                                  var recordInOrchestrationTable = stcw.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);
                                                  recordInOrchestrationTable.provisioningProcessId = pid;
                                                  recordInOrchestrationTable.save();
                                                ]]></script>
                                              </method>
                                            </methodList>
                                          </child>
                                          <child name="waitForProvisioningCompleted" type="syncActivity">
                                            <element>signal_stcw.notifyProvisioningIsCompleted</element>
                                            <label>Wait For Provisioning Completed</label>
                                            <x>1365.0</x>
                                            <y>656.0</y>
                                            <methodList>
                                              <method name="cwOnProcActAfter" type="action">
                                                <category>script</category>
                                                <system>true</system>
                                                <script><![CDATA[
                                                  debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - provisioningProcessForElement " + this.process.processOrderItem.id + " - Completed!");
                                                ]]></script>
                                              </method>
                                            </methodList>
                                          </child>
                                        </childList>
                                      </child>
                                    </childList>
                                  </child>
                                </childList>
                              </child>
                            </childList>
                          </child>
                        </childList>
                        <methodList>
                          <method name="cwOnProcActCond" type="action">
                            <category>cond</category>
                            <system>true</system>
                            <script><![CDATA[
                              var recordInOrchestrationTable = stcw.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);

                              return (recordInOrchestrationTable.provisionable && recordInOrchestrationTable.provisioningProcessId == null);
                            ]]></script>
                          </method>
                        </methodList>
                      </child>
                      <child name="no" type="caseActivity">
                        <label>No</label>
                        <x>1223.0</x>
                        <y>335.0</y>
                      </child>
                    </childList>
                  </child>
                </childList>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActCond" type="action">
                <category>cond</category>
                <system>true</system>
                <script><![CDATA[
                  var element = this.process.processOrderItem;
                  var orderType = this.process.processOrder.orderHeader.orderType;
                  var isDeleteOrSuspend = false;

                  var isReviseForSuspendOrDisconnect = (element.action == "M" && (orderType == "D" || orderType == "O"));

                  if(element.action != "M"){
                      // it considers only the action of the element
                      isDeleteOrSuspend = (element.action == "D" || element.action == "S");
                  }
                  else {
                      // action of the element is "M", so checking the orderType
                      isDeleteOrSuspend = (orderType == "D" || orderType == "O");
                  }

                  debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - isDeleteOrSuspend " + isDeleteOrSuspend);

                  return isDeleteOrSuspend;
                ]]></script>
              </method>
            </methodList>
          </child>
          <child name="notDeleteOrSuspend" type="caseActivity">
            <label>Not Delete Or Suspend Action</label>
            <x>128.0</x>
            <y>280.0</y>
            <childList>
              <child name="startNormalProcessing" type="seqActivity">
                <label>Start Normal Processing</label>
                <x>298.0</x>
                <y>187.0</y>
                <childList>
                  <child name="isElementProvisionable" type="switchActivity">
                    <label>Is Element Provisionable?</label>
                    <x>430.0</x>
                    <y>185.0</y>
                    <childList>
                      <child name="yes" type="caseActivity">
                        <label>Yes</label>
                        <x>462.0</x>
                        <y>43.0</y>
                        <childList>
                          <child name="start" type="seqActivity">
                            <label>Start</label>
                            <x>447.0</x>
                            <y>43.0</y>
                            <childList>
                              <child name="startProvisioningProcessForElement" type="scriptActivity">
                                <label>Start Provisioning Process For Element</label>
                                <x>566.0</x>
                                <y>10.0</y>
                                <methodList>
                                  <method name="cwOnProcActBefore" type="action">
                                    <category>before</category>
                                    <system>true</system>
                                    <script><![CDATA[
                                      debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - startingProvisioningProcessForElement: " + this.process.processOrderItem.id);

                                      var processName = "stcw.mainSTCWProvisiongProcess_5";
                                      if(this.process.processOrderItem.provisioningBU == "W" && this.process.processOrder.orderHeader.orderType == "F") {
                                          processName = "stcw.mainSTCWQuoteProvisioningProcess_4";
                                      }
                                      else if(this.process.processOrderItem.provisioningBU == "M") {
                                          processName = "stcw.mobileSTCWProvisioningProcess";
                                      }

                                      var pid = Process.startProcess(processName, this.process.processOrder.id, this.process.processOrderItem.id);
                                      debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - startedProvisioningProcess: " + pid + "; type: " + processName + "; element: " + this.process.processOrderItem.id);

                                      var recordInOrchestrationTable = stcw.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);
                                      recordInOrchestrationTable.provisioningProcessId = pid;
                                      recordInOrchestrationTable.save();
                                    ]]></script>
                                  </method>
                                </methodList>
                              </child>
                              <child name="waitForProvisioningCompleted" type="syncActivity">
                                <element>signal_stcw.notifyProvisioningIsCompleted</element>
                                <label>Wait For Provisioning Completed</label>
                                <x>729.0</x>
                                <y>21.0</y>
                                <methodList>
                                  <method name="cwOnProcActAfter" type="action">
                                    <category>script</category>
                                    <system>true</system>
                                    <script><![CDATA[
                                      debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - provisioningProcessForElement " + this.process.processOrderItem.id + " - Completed!");
                                    ]]></script>
                                  </method>
                                </methodList>
                              </child>
                            </childList>
                          </child>
                        </childList>
                        <methodList>
                          <method name="cwOnProcActCond" type="action">
                            <category>cond</category>
                            <system>true</system>
                            <script><![CDATA[
                              var recordInOrchestrationTable = stcw.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);

                              return (recordInOrchestrationTable.provisionable && recordInOrchestrationTable.provisioningProcessId == null);
                            ]]></script>
                          </method>
                        </methodList>
                      </child>
                      <child name="no" type="caseActivity">
                        <label>No</label>
                        <x>607.0</x>
                        <y>191.0</y>
                      </child>
                    </childList>
                  </child>
                  <child name="existProcessKOInOrchestration" type="switchActivity">
                    <label>Is There Process KO In Orchestration?</label>
                    <x>737.0</x>
                    <y>167.0</y>
                    <childList>
                      <child name="yes" type="caseActivity">
                        <label>Yes</label>
                        <x>898.0</x>
                        <y>176.0</y>
                        <childList>
                          <child name="skipChildrenDueToProcessKO" type="scriptActivity">
                            <label>Skip Children Due To Process KO</label>
                            <x>903.0</x>
                            <y>18.0</y>
                            <methodList>
                              <method name="cwOnProcActBefore" type="action">
                                <category>before</category>
                                <system>true</system>
                                <script><![CDATA[
                                  debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - startingProvisioningProcessForElement: Found at least one process completed with KO, so skipping children");
                                ]]></script>
                              </method>
                            </methodList>
                          </child>
                        </childList>
                        <methodList>
                          <method name="cwOnProcActCond" type="action">
                            <category>cond</category>
                            <system>true</system>
                            <script><![CDATA[
                              var existKO = stcw.checkIfExistProcessKOInOrchestrationTable(this.process.processOrder.id);

                              if(!existKO) {
                                  debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Don't exist KO for order; checking if quoteLineItem is not feasible");
                                  existKO = stcw.checkIfLineItemIsNotFeasibleForQuote(this.process.processOrderItem.lineItemStatus.toUpperCase(), this.process.processOrder.orderHeader.orderType);
                              }

                              debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - breaking execution because exists KO or quoteItem is not feasible");

                              return existKO;
                            ]]></script>
                          </method>
                        </methodList>
                      </child>
                      <child name="no" type="caseActivity">
                        <label>No</label>
                        <x>743.0</x>
                        <y>267.0</y>
                        <childList>
                          <child name="hasChildElements" type="switchActivity">
                            <label>Has Child Elements?</label>
                            <x>929.0</x>
                            <y>191.0</y>
                            <childList>
                              <child name="yes" type="caseActivity">
                                <label>Yes</label>
                                <x>945.0</x>
                                <y>298.0</y>
                                <childList>
                                  <child name="start" type="seqActivity">
                                    <label>Start</label>
                                    <x>935.0</x>
                                    <y>312.0</y>
                                    <childList>
                                      <child name="performProvisioningOfAllChildElements_NoDelete" type="subflowActivity">
                                        <element>proc_stcw.performProvisioningOfAllChildElements_NotDelete_2</element>
                                        <label>Perform Provisioning Of All Child Elements - No Delete_Suspend</label>
                                        <x>1102.0</x>
                                        <y>285.0</y>
                                        <methodList>
                                          <method name="cwOnProcActBefore" type="action">
                                            <category>before</category>
                                            <system>true</system>
                                            <script><![CDATA[
                                              var elementTypeInOrderTree = this.process.processOrderItem.elementTypeInOrderTree;
                                              if(elementTypeInOrderTree == "B") {
                                                  this.process.processDocument.elementTypeInOrderTree = "C";
                                              }
                                              else if(elementTypeInOrderTree == "C") {
                                                  this.process.processDocument.elementTypeInOrderTree = "S";
                                              }
                                              else if(elementTypeInOrderTree == "S") {
                                                  this.process.processDocument.elementTypeInOrderTree = "T";
                                              }

                                              debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - starting OrchestrationWorkflowForChildElement with ElementType = " + this.process.processDocument.elementTypeInOrderTree);
                                            ]]></script>
                                          </method>
                                        </methodList>
                                      </child>
                                    </childList>
                                  </child>
                                </childList>
                                <methodList>
                                  <method name="cwOnProcActCond" type="action">
                                    <category>cond</category>
                                    <system>true</system>
                                    <script><![CDATA[
                                      var childElementsList = stcw.findRecordsInOrchTabByOrderId_ParentId(this.process.processOrder.id, this.process.processOrderItem.id);

                                      debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - childElementsList.length= " + childElementsList.length);

                                      return (childElementsList != null && childElementsList.length > 0);
                                    ]]></script>
                                  </method>
                                </methodList>
                              </child>
                              <child name="no" type="caseActivity">
                                <label>No</label>
                                <x>1113.0</x>
                                <y>195.0</y>
                              </child>
                            </childList>
                          </child>
                        </childList>
                      </child>
                    </childList>
                  </child>
                </childList>
              </child>
            </childList>
          </child>
        </childList>
      </child>
      <child name="sendWakeUpToParentProcess" type="scriptActivity">
        <label>Send WakeUp To Parent Process</label>
        <x>1283.0</x>
        <y>164.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              // it has to return the id of the parent process
              var recordInOrchestrationTable = stcw.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);
              var recordForParentElementInOrchestrationTable = stcw.getRecordInOrchestrationTableByLineItemId(recordInOrchestrationTable.cwParentObjectId);
              var orchestrationProcessIdForParent = recordForParentElementInOrchestrationTable.orchestrationProcessId;

              if(this.process.processOrderItem.isVAS && this.process.processOrderItem.action != "N") {
                  if((this.process.processOrder.orderHeader.orderType == "I" || this.process.processOrder.orderHeader.orderType == "C") &&
                      recordForParentElementInOrchestrationTable.provisionable) {
                      // in case of VAS and orderType I or C and parent provisionable, the process to wakeup is the orchestration of the parent of the parent element

              debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - It's for VAS with orderType I or C and parent provisionable so looking for the orchestration of the parent of the parent ....");

                      var recordForParentElementOfVASInOrchestrationTable = stcw.getRecordInOrchestrationTableByLineItemId(recordForParentElementInOrchestrationTable.cwParentObjectId);
                      orchestrationProcessIdForParent = recordForParentElementOfVASInOrchestrationTable.orchestrationProcessId;
                  }
              }

              var processInstance = Process.getProcessInfo(orchestrationProcessIdForParent);
              if(processInstance != null) {
                  if(processInstance.processStatus == 8) {
                      // the process is in status 8, so STALE; resume it
                      debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Resuming Stale process " + orchestrationProcessIdForParent);
                      Process.resumeAllStaleProcesses(orchestrationProcessIdForParent);
                  }
              }


              debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - SendWakeUp; parentProcessId " + orchestrationProcessIdForParent);

              Process.sendSignal("stcw.wakeUpParentInOrchestration", orchestrationProcessIdForParent);
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="end" type="completeActivity">
        <label>End</label>
        <x>1449.0</x>
        <y>186.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Completed OrchestrationWorkflow for element " + this.process.processOrderItem.id);
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="stopProcess" type="onExceptionActivity">
        <element>excp_cwf.stop</element>
        <label>Stop Process</label>
        <x>20.0</x>
        <y>134.0</y>
        <childList>
          <child name="start" type="seqActivity">
            <label>Start</label>
            <x>20.0</x>
            <y>157.0</y>
            <childList>
              <child name="stopOrchestrationProcess" type="completeActivity">
                <label>Stop Orchestration Process</label>
                <x>6.0</x>
                <y>317.0</y>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[
                      debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Received Stop for this Orchestration process");
                    ]]></script>
                  </method>
                </methodList>
              </child>
            </childList>
          </child>
        </childList>
      </child>
    </childList>
    <methodList>
      <method name="cwOnProcActBefore" type="action">
        <category>before</category>
        <system>true</system>
        <script><![CDATA[
          debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Starting OrchestrationWorkflow for element " + this.process.processOrderItem.id);
        ]]></script>
      </method>
    </methodList>
  </activity>
  <curRevision>true</curRevision>
  <document>doc_stcw.stcwOrchestrationProcessDocument</document>
  <label>STC Element Orchestration Process - 2</label>
  <metaVersion>25</metaVersion>
  <priority>8</priority>
  <subflowReferenceList>
    <subflowReference type="sref">
      <subflow>proc_stcw.performProvisioningOfAllChildElements_NotDelete_2</subflow>
    </subflowReference>
    <subflowReference type="sref">
      <revision>1</revision>
      <subflow>proc_stcw.performProvisioningOfAllChildElements_Delete</subflow>
    </subflowReference>
  </subflowReferenceList>
  <type>User</type>
</process>