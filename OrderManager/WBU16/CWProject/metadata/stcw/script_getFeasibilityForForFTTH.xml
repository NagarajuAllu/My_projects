<?xml version="1.0" encoding="UTF-8" ?>
<script name="stcw.getFeasibilityForForFTTH">
  <label>Get FeasibilityFor For FTTH</label>
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="order" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var feasibilityFor = null;

    if(order != null) {
        if(order.orderHeader.orderType == 'F') {
            if(order.orderHeader.feasibilityFor == "INSTALL") {
                // no need to change it!
                feasibilityFor = "INSTALL";
            }
            else {
                var hsiGIServiceType = stcw.getGraniteServiceTypeForSOMInternalName("FTTH_HSI");
                var voipGIServiceType = stcw.getGraniteServiceTypeForSOMInternalName("FTTH_VOIP");
                var iptvGIServiceType = stcw.getGraniteServiceTypeForSOMInternalName("FTTH_IPTV");

                // it's a change order so using the MOPS table
                var hsiAction = null;
                var voipAction = null;
                var iptvAction = null;

                var isUpgrade = false;
                var isDowngrade = false;

                var services = order.parentLineItems[0].services;
                for(var i=0; i<services.length; i++) {
                    var serviceLineItem = services[i].serviceLineItem;
                    if(stcw.isServiceProvisionable(serviceLineItem.id)) {
                        if(serviceLineItem.serviceType == hsiGIServiceType) {
                            hsiAction = convertActionToXngOrderType_(serviceLineItem.action, serviceLineItem.changeRequestType);
                        }
                        else if(serviceLineItem.serviceType == voipGIServiceType) {
                            voipAction = convertActionToXngOrderType_(serviceLineItem.action, serviceLineItem.changeRequestType);
                        }
                        else if(serviceLineItem.serviceType == iptvGIServiceType) {
                            iptvAction = convertActionToXngOrderType_(serviceLineItem.action, serviceLineItem.changeRequestType);
                        }

                        if(serviceLineItem.changeRequestType == "UPGRADE") {
                            isUpgrade = true;
                        }
                        else if(serviceLineItem.changeRequestType == "DOWNGRADE") {
                            isDowngrade = true;
                        }
                    }
                }

                if(isUpgrade && isDowngrade) {
                    // wrong configuration, so resetting both of them
                    isUpgrade = false;
                    isDowngrade = false;
                }

                if(hsiAction == null && voipAction == null && iptvAction == null) {
                    feasibilityFor = "CHANGE";
                }
                else {
                    if((hsiAction == null || hsiAction == "T") &&
                       (voipAction == null || voipAction == "T") &&
                       (iptvAction == null || iptvAction == "T")) {
                        // in case all the actions are "T", the workOrderType has to be "T"
                        feasibilityFor = "TRANSFER";
                    }
                }

                if(feasibilityFor == null) {
                    if(isUpgrade) {
                        if((hsiAction == null || hsiAction == "I") &&
                           (voipAction == null || voipAction == "I") &&
                           (iptvAction == null || iptvAction == "I")) {
                            feasibilityFor = "CHANGE";
                        }
                        else if((hsiAction == null || hsiAction == "C") &&
                                (voipAction == null || voipAction == "C") &&
                                (iptvAction == null || iptvAction == "C")) {
                            feasibilityFor = "CHANGE";
                        }
                    }
                    else if(isDowngrade) {
                        if((hsiAction == null || hsiAction == "O") &&
                           (voipAction == null || voipAction == "O") &&
                           (iptvAction == null || iptvAction == "O")) {
                            feasibilityFor = "CHANGE";
                        }
                        else if((hsiAction == null || hsiAction == "C") &&
                                (voipAction == null || voipAction == "C") &&
                                (iptvAction == null || iptvAction == "C")) {
                            feasibilityFor = "CHANGE";
                        }
                    }
                }

                if(feasibilityFor == null) {
                    // using MOPS table
                    var inputDocument = new Document("stcconf.MOPS_ORDER_TYPE");
                    inputDocument.hsiOpType = (hsiAction != null ? hsiAction : "-");
                    inputDocument.voipOpType = (voipAction != null ? voipAction : "-");
                    inputDocument.iptvOpType = (iptvAction != null ? iptvAction : "-");

                    var mapMOPSOrderTypeList = Finder.runFinder("stcconf.findMOPS_ORDER_TYPE", "select", inputDocument);
                    if(mapMOPSOrderTypeList != null && mapMOPSOrderTypeList.length > 0) {
                        feasibilityFor = "MOPS";
                    }
                }

                if(feasibilityFor == null) {
                    // nothing found in all previous cases - using the default action, so "CHANGE"
                    feasibilityFor = "CHANGE";
                }
            }
        }
    }

    return feasibilityFor;


    function convertActionToXngOrderType_(serviceLineItemAction, changeRequestTypeReceived) {
        var xngOrderType = null;
        if(serviceLineItemAction == "A") {
            xngOrderType = "I";
        }
        else if(serviceLineItemAction == "D") {
            xngOrderType = "O";
        }
        else if(serviceLineItemAction == "M") {
            if(changeRequestTypeReceived == "RELOCATION" ||
               changeRequestTypeReceived == "RELOCATION_BW" ||
               changeRequestTypeReceived == "RELOCATION_NC") {
                xngOrderType = "T";
            }
            else {
                xngOrderType = "C";
            }
        }

        return xngOrderType;
    }
  ]]></script>
</script>