<?xml version="1.0" encoding="UTF-8" ?>
<process name="stcw.mainSTCWOrchestrationProcess">
  <activity name="start" type="seqActivity">
    <label>Start</label>
    <x>75.0</x>
    <y>95.0</y>
    <childList>
      <child name="setProcessIdInOrchestrationTable" type="scriptActivity">
        <label>Set ProcessId In Orchestration Table</label>
        <x>234.0</x>
        <y>70.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              var recordInOrchestrationTable = stcw.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);
              recordInOrchestrationTable.orchestrationProcessId = this.process.id;
              recordInOrchestrationTable.save();

              // removing ordernumber from orders under management list
              stcw.removeOrderToOrdersUnderManagement(this.process.processOrder.orderHeader.orderNumber);
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="isPermanentOrTempDisconnect" type="switchActivity">
        <label>Is Permanent Disconnect Or Temporary Disconnect?</label>
        <x>424.0</x>
        <y>64.0</y>
        <childList>
          <child name="disconnect" type="caseActivity">
            <label>Disconnect</label>
            <x>422.0</x>
            <y>106.0</y>
            <childList>
              <child name="startDisconnect" type="seqActivity">
                <label>Start Disconnect</label>
                <x>585.0</x>
                <y>95.0</y>
                <childList>
                  <child name="performProvisioningOfAllChildElements_Disconnect" type="subflowActivity">
                    <element>proc_stcw.performProvisioningOfAllChildElements_Delete</element>
                    <label>Perform Provisioning Of All Child Elements - Disconnect</label>
                    <x>786.0</x>
                    <y>48.0</y>
                    <methodList>
                      <method name="cwOnProcActBefore" type="action">
                        <category>before</category>
                        <system>true</system>
                        <script><![CDATA[this.process.processDocument.elementTypeInOrderTree = 'B';]]></script>
                      </method>
                    </methodList>
                  </child>
                </childList>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActCond" type="action">
                <category>cond</category>
                <system>true</system>
                <script><![CDATA[
                  var order = this.process.processOrder;
                  var orderType = order.orderHeader.orderType;
                  var isDisconnect = (orderType == "D" || orderType == "O");

                  debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - isDisconnect: " + isDisconnect);

                  return isDisconnect;
                ]]></script>
              </method>
            </methodList>
          </child>
          <child name="notDisconnect" type="caseActivity">
            <label>Not Disconnect</label>
            <x>422.0</x>
            <y>106.0</y>
            <childList>
              <child name="startNormalProcessing" type="seqActivity">
                <label>Start Normal Processing</label>
                <x>435.0</x>
                <y>248.99998</y>
                <childList>
                  <child name="performProvisioningOfAllChildElements_NoDisconnect" type="subflowActivity">
                    <element>proc_stcw.performProvisioningOfAllChildElements_NotDelete</element>
                    <label>Perform Provisioning Of All Child Elements - No Disconnect</label>
                    <x>597.0</x>
                    <y>213.0</y>
                    <methodList>
                      <method name="cwOnProcActBefore" type="action">
                        <category>before</category>
                        <system>true</system>
                        <script><![CDATA[this.process.processDocument.elementTypeInOrderTree = 'B';]]></script>
                      </method>
                    </methodList>
                  </child>
                </childList>
              </child>
            </childList>
          </child>
        </childList>
      </child>
      <child name="sendWOSUForOrderToEAI" type="scriptActivity">
        <label>Send WOSU For Order To EAI</label>
        <x>789.0</x>
        <y>221.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              if(! stcw.checkIfExistProcessKOInOrchestrationTable(this.process.processOrder.id)) {
                  var bundleOrder = this.process.processOrder;

                  if(bundleOrder.orderHeader.orderType == "F") {
                      stcw.updateBundleAndOrderHeaderStatusForFeasAtProcCompl(bundleOrder);
                  }
                  else {
                      // updating provisioningFlag for all the bundles
                      var bundleOrder = this.process.processOrder;
                      for(var i=0; i<bundleOrder.parentLineItems.length; i++) {
                          var parentLineItem = bundleOrder.parentLineItems[i].parentLineItem;

                          var parentLineItemStatusUpperCase = parentLineItem.lineItemStatus.toUpperCase();
                          if(parentLineItemStatusUpperCase != "CANCELLED" && parentLineItemStatusUpperCase != "COMPLETED") {
                              if(stcw.checkThatAllLineItemsInBundleHaveOneOfTheseStatus(["CANCELLED"], parentLineItem, bundleOrder, false)) {
                                  parentLineItem.lineItemStatus = "CANCELLED";
                              }
                              else {
                                  parentLineItem.lineItemStatus = "COMPLETED";
                              }
                              parentLineItem.completionDate = new Date();
                          }

                          if(parentLineItem.isCancel || parentLineItem.lineItemStatus == "CANCELLED") {
                              parentLineItem.provisioningFlag = "CANCELLED";
                          }
                          else {
                              var orderNumber = bundleOrder.orderHeader.orderNumber;
                              if((orderNumber.indexOf("_CANC_") >= 0) || (orderNumber.indexOf("_REVI_") >= 0)) {
                                  // do nothing because it's an old version of the order
                                  debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - ProvisioningFlag not changed because orderNumber (" + orderNumber + ") contains '_CANC_' or _REVI_'");
                              }
                              else {
                                  var activeLineItems = stcw.getAllLineItemsByIdentifierAndProvisioningFlag(parentLineItem.lineItemIdentifier, "B", "ACTIVE");
                                  for(var j=0; j<activeLineItems.length; j++) {
                                      activeLineItems[j].provisioningFlag = "OLD";
                                      activeLineItems[j].save();

                                      // to maintain the sequence of the active version of the orders
                                      parentLineItem.previousActiveDocId = activeLineItems[j].id;
                                  }

                                  parentLineItem.provisioningFlag = "ACTIVE";
                              }
                          }
                          parentLineItem.save();
                      }

                      var orderStatusUpperCase = bundleOrder.orderHeader.orderStatus.toUpperCase();
                      if(orderStatusUpperCase != "CANCELLED" && orderStatusUpperCase != "COMPLETED") {
                          // it happens only if there is no lineItem sent to Granite and so no WOSU received
                          if(stcw.checkThatAllLineItemsInOrderHaveOneOfTheseStatus(["CANCELLED"], bundleOrder, false)) {
                              bundleOrder.orderHeader.orderStatus = "CANCELLED";
                          }
                          else {
                              bundleOrder.orderHeader.orderStatus = "COMPLETED";
                          }
                          bundleOrder.orderHeader.completionDate = new Date();
                      }
                      bundleOrder.save();
                  }

                  if(! stcw.checkIfExistProvisionProcessInOrchestrationTable(bundleOrder.id)) {
                      // sending "closing" WOSU to EAI
                      stcw.generateLastWOSUForOrder(bundleOrder);
                  }
              }
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="end" type="completeActivity">
        <label>End</label>
        <x>970.0</x>
        <y>242.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - End");]]></script>
          </method>
        </methodList>
      </child>
      <child name="stopProcess" type="onExceptionActivity">
        <element>excp_cwf.stop</element>
        <label>Stop Process</label>
        <x>73.0</x>
        <y>137.0</y>
        <childList>
          <child name="start" type="seqActivity">
            <label>Start</label>
            <x>75.0</x>
            <y>269.0</y>
            <childList>
              <child name="stopOrchestrationProcess" type="completeActivity">
                <label>Stop Orchestration Process</label>
                <x>224.0</x>
                <y>246.0</y>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[
                      debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Received Stop for this Orchestration process");
                    ]]></script>
                  </method>
                </methodList>
              </child>
            </childList>
          </child>
        </childList>
      </child>
    </childList>
    <methodList>
      <method name="cwOnProcActBefore" type="action">
        <category>before</category>
        <system>true</system>
        <script><![CDATA[debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Start");]]></script>
      </method>
    </methodList>
  </activity>
  <curRevision>true</curRevision>
  <document>doc_stcw.stcwOrchestrationProcessDocument</document>
  <label>Main STCW Orchestration Process</label>
  <metaVersion>25</metaVersion>
  <priority>8</priority>
  <subflowReferenceList>
    <subflowReference type="sref">
      <revision>1</revision>
      <subflow>proc_stcw.performProvisioningOfAllChildElements_Delete</subflow>
    </subflowReference>
    <subflowReference type="sref">
      <revision>1</revision>
      <subflow>proc_stcw.performProvisioningOfAllChildElements_NotDelete</subflow>
    </subflowReference>
  </subflowReferenceList>
  <type>User</type>
</process>