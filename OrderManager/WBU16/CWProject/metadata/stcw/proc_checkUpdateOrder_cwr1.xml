<?xml version="1.0" encoding="UTF-8" ?>
<process name="stcw.checkUpdateOrder_cwr1">
  <activity name="start" type="seqActivity">
    <label>Start</label>
    <x>108.34766</x>
    <y>31.0</y>
    <childList>
      <child name="validateIncomingOrder" type="scriptActivity">
        <label>Validate Incoming Order</label>
        <x>244.34766</x>
        <y>14.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              rpts.updateHistoryEvent (this, "expediterValidation");

              var input = stcw.findGenericProcessMessageById (this.process.processDocument.genericProcessMsgDocId, "wsws:updateOrder");
              debugPrintln(stcc.getSysdateForLog() + "Received UpdateOrder with input = " + (input == null ? "null" : input.toXML()));

                    this.process.processDocument.orderNumber = input.orderNumber;

                    var errors = basicValidation_ (input);
                    if (errors == null) {
                          if(stcw.isCancelOrderRequest (input) || stcw.isReviseOrderRequest (input))  {
                                errors = validateUpdateOrder_ (input);
                          }
                          else {
                                errors = util.createError ("UnsupportedOperation", "operation_UpdateOrder", input.orderNumber, input.orderStatus);
                          }
                    }

                    if(errors == null) {
                          this.process.processDocument.ackResult = "SUCCESS";
                    }
                    else {
                          this.process.processDocument.ackResult = "ERROR";
                          this.process.processDocument.ErrorCode = errors.code;
                          this.process.processDocument.ErrorText = errors.text;
                    }


                    //
                    //  basicValidation_
                    //
                    function basicValidation_ (input) {

                          if (input == undefined || input == null || input.metadataType != "wsws:updateOrder")
                                return (util.createError ("InvalidInput", "wsws:updateOrder"));

                          if (input.businessUnit != "Wholesale") {
                                return (util.createError ("InvalidBusinessUnit", input.businessUnit));
                          }

                          var validationResult = input.validate(1, true);
                          if(validationResult != null) {
                                var error = new DataStructure ("util:Error");
                                error.code = validationResult[0];
                                error.text = validationResult[1];
                                return error;
                          }

                          return (null);

                    }            // b a s i c V a l i d a t i o n _

                    //
                    // validateUpdateOrder_
                    //
                    function validateUpdateOrder_ (input) {

                          // order does not exist
                          var order = stcw.findOrderByNumber (input.orderNumber);
                          if (order == null)
                                return (util.createError ("UpdOrderNotFound", input.orderNumber));

                          // order status is complete
                          if (stcw.isOrderProcessComplete (order))
                                return (util.createError ("UpdOrderComplete", input.orderNumber));

                          // order has been cancelled
                          if (stcw.isOrderCancelled (order))
                                return (util.createError ("UpdOrderCancel", input.orderNumber));

                          /******

                            Removed according to Raj request - see mail 24/06/2011

                          // quote number is specified but does not exist
                          if (stcc.stringHasValue (input.quoteNumber) && stcw.findQuoteByParentQuoteNumberAndRowId (input.quoteNumber) == null) {
                                return (util.createError ("QuoteForOrderNotFound", input.orderNumber, input.quoteNumber));
                          }

                          // According to mail sent to Maksym & Ravi 05/06/2010, we expect reservationNumber at Order level and Service level are the same
                          // so, if it's set to Order number we use this, else we try to use the Service one.
                          var reservationNumber = null;
                          if (stcc.stringHasValue (input.reservationNumber)) {
                                // default using Order level one
                                reservationNumber = input.reservationNumber;

                                if(stcc.stringHasValue(input.service.reservationNumber)) {
                                      if(input.service.reservationNumber != reservationNumber) {
                                            // Both exist but they are different, so error!
                                            return (util.createError ("DifferentReservationNumber", input.orderNumber, reservationNumber, input.service.reservationNumber));
                                      }
                                }
                          }
                          else {
                                if(stcc.stringHasValue(input.service.reservationNumber)) {
                                      // using Service level one
                                      reservationNumber = input.service.reservationNumber;
                                }
                          }

                          if(reservationNumber != null) {
                                var quote = stcw.findReservation (reservationNumber);

                                // reservation number is specified but does not exist
                                if(quote == null) {
                                      return (util.createError ("ReservationNotFound", input.orderNumber, reservationNumber));
                                }

                                var countNotCancelledOrder = stcw.countNotCancelledOrderByReservation(reservationNumber);
                                if(countNotCancelledOrder == quote.header.quantity) {
                                      return (util.createError ("AllReservationUsed", reservationNumber));
                                }
                          }

                          ****/

                          return (null);

                    }            // v a l i d a t e U p d a t e O r d e r _
            ]]></script>
          </method>
          <method name="cwOnProcActCond" type="action">
            <category>cond</category>
            <system>true</system>
            <script><![CDATA[
              rpts.createHistoryEvent (this);
              return (true);
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="isOrderValid" type="switchActivity">
        <label>Is Order Valid?</label>
        <x>357.34766</x>
        <y>17.0</y>
        <childList>
          <child name="yes" type="caseActivity">
            <label>Yes</label>
            <x>0.0</x>
            <y>0.0</y>
            <childList>
              <child name="start" type="seqActivity">
                <label>Start</label>
                <x>357.34766</x>
                <y>134.0</y>
                <childList>
                  <child name="startProcessManagement" type="scriptActivity">
                    <label>Start Process Management</label>
                    <x>344.34766</x>
                    <y>232.0</y>
                    <methodList>
                      <method name="cwOnProcActBefore" type="action">
                        <category>before</category>
                        <system>true</system>
                        <script><![CDATA[
                          rpts.updateHistoryEvent (this, "startProcessManagement");

                          var input = stcw.findGenericProcessMessageById (this.process.processDocument.genericProcessMsgDocId, "wsws:updateOrder");
                          var order = stcw.findOrderByNumber (this.process.processDocument.orderNumber);

                          if(stcw.isCancelOrderRequest (input))  {
                                stcw.addVersionToOrder (order, "CANCEL");
                          }
                          else {
                                stcw.addVersionToOrder (order, "REVISE");
                          }
                          // resetting the flag to skip send granite
                          order.header.skipSendToGranite = "N";
                          order.save ();

                          // patching all already stored events of this process with the order number
                          stcw.assignProcessEventsToOrder(this.process.id, order.header.cwOrderId);

                          var processId = Process.startProcess ("stcw:updateOrder", order.header.cwOrderId);
                          var patchResults = rpts.patchAsynchMessageLog (processId, "crmUpdateOrder");

                          Process.sendMessageToProcess (processId, null, "wsws:ifExpedtier_WHOLESALE/operation_UpdateOrder", input);
                        ]]></script>
                      </method>
                      <method name="cwOnProcActCond" type="action">
                        <category>cond</category>
                        <system>true</system>
                        <script><![CDATA[
                          rpts.createHistoryEvent (this);
                          return (true);
                        ]]></script>
                      </method>
                    </methodList>
                  </child>
                </childList>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActCond" type="action">
                <category>cond</category>
                <system>true</system>
                <script><![CDATA[return (this.process.processDocument.ackResult == "SUCCESS");]]></script>
              </method>
            </methodList>
          </child>
          <child name="no" type="caseActivity">
            <label>No</label>
            <x>127.34766</x>
            <y>237.0</y>
            <childList>
              <child name="start" type="seqActivity">
                <label>Start</label>
                <x>476.34766</x>
                <y>26.0</y>
                <childList>
                  <child name="startProcessToSendFailureAck" type="scriptActivity">
                    <label>Start Process To Send Failure Ack</label>
                    <x>599.34766</x>
                    <y>7.0</y>
                    <methodList>
                      <method name="cwOnProcActBefore" type="action">
                        <category>before</category>
                        <system>true</system>
                        <script><![CDATA[
                          rpts.updateHistoryEvent (this, "failureFromExpediter");

                          var newProcessDocument            = new Document("stcw:sendFailureAckForOrderDoc");
                          newProcessDocument.ErrorCode      = this.process.processDocument.ErrorCode;
                          newProcessDocument.ErrorText      = this.process.processDocument.ErrorText;
                          newProcessDocument.orderNumber    = this.process.processDocument.orderNumber;

                          var processId = Process.startProcess ("stcw:sendFailureOrderAckToCrm", newProcessDocument);
                          debugPrintln(stcc.getSysdateForLog() + "Start Process 'sendFailureOrderAckToCrm' <" + newProcessDocument.orderNumber + ">: processId = " + processId);

                                stcw.createRejectedOrder(this.process.processDocument.orderNumber,
                                                                     "Expediter",
                                                                     this.process.processDocument.ErrorText);
                        ]]></script>
                      </method>
                      <method name="cwOnProcActCond" type="action">
                        <category>cond</category>
                        <system>true</system>
                        <script><![CDATA[
                          rpts.createHistoryEvent (this);
                          return (true);
                        ]]></script>
                      </method>
                    </methodList>
                  </child>
                  <child name="end" type="completeActivity">
                    <label>End</label>
                    <x>730.34766</x>
                    <y>27.0</y>
                  </child>
                </childList>
              </child>
            </childList>
          </child>
        </childList>
      </child>
      <child name="end" type="completeActivity">
        <label>End</label>
        <x>363.34766</x>
        <y>347.41406</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              rpts.updateHistoryEvent (this, "completedCheckUpdateOrder");
              debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - CheckUpdateOrder - COMPLETED!!!");
            ]]></script>
          </method>
          <method name="cwOnProcActCond" type="action">
            <category>cond</category>
            <system>true</system>
            <script><![CDATA[
              rpts.createHistoryEvent (this);
              return (true);
            ]]></script>
          </method>
        </methodList>
      </child>
    </childList>
    <methodList>
      <method name="cwOnProcActBefore" type="action">
        <category>before</category>
        <system>true</system>
        <script><![CDATA[debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - CheckUpdateOrder - Start ...");]]></script>
      </method>
    </methodList>
  </activity>
  <curRevision>true</curRevision>
  <document>doc_stcw.checkProcessDocument</document>
  <label>Check Update Order</label>
  <metaVersion>23</metaVersion>
  <priority>8</priority>
  <type>User</type>
</process>