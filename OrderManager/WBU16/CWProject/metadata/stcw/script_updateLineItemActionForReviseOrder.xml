<?xml version="1.0" encoding="UTF-8" ?>
<script name="stcw.updateLineItemActionForReviseOrder">
  <label>Update LineItemAction For Revise Order</label>
  <metaVersion>4</metaVersion>
  <parameterList>
    <parameter name="lineItem" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
    <parameter name="existingLineItem" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
    <parameter name="existingOrderWasKO" type="rifp">
      <type>dtype_com.conceptwave.system.Boolean</type>
    </parameter>
    <parameter name="validationErrors" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    /*******
       NOTE: Please refer to the following table:
    -------------+------------------------------------|
                 |              Revise                |
                 +----------------+-------------------|
                 | Already Cancel | No Cancel         |
    -------------+----------------+-------------------|
     Hold        |  REJECT        | Status: Hold      |
                 |                | Action: existing  |
                 |                | PROVISIONING      |
    -------------+----------------+-------------------|
     COMPLETED   |  REJECT        | Status: COMPLETED |
                 |                | Action: existing  |
                 |                | NO PROVISIONING   |
    -------------+------------------------------------|
     CANCELLED   |             REJECT                 |
                 |                                    |
                 |                                    |
    -------------+----------------+-------------------|
     FAILED      | REJECT         | Status: Hold      |
                 |                | Action: existing  |
                 |                | PROVISIONING      |
    -------------+----------------+-------------------|
     Submitted   | REJECT         | Status: Hold      |
                 |                | Action: M         |
                 |                | PROVISIONING      |
    -------------+------------------------------------|

    **********/

    var existingLineItemStatus = existingLineItem.lineItemStatus;
    var existingLineItemAction = existingLineItem.action;
    var existingLineItemInGranite = existingLineItem.alreadySentToGranite;

    var receivedAction = lineItem.action;

    if(existingLineItemStatus == "Hold" || existingLineItemStatus == "Waiting for Granite Resp") {
        if(lineItem.alreadyReceivedCancel) {
            validationErrors = stcw.appendToValidationErrors("AE0070", Global.translateText("AE0070", null, ["ReviseOrder"]), validationErrors, "updateLineItemActionForReviseOrder (" + lineItem.lineItemIdentifier + ")");
        }
        else {
            // just received; maintain everything
            lineItem.action = existingLineItemAction;
            lineItem.lineItemStatus = "Hold";
            lineItem.isSubmit = existingLineItem.isSubmit;
            lineItem.isCancel = false;
            lineItem.alreadySentToGranite = false;
        }
    }
    else if(existingLineItemStatus.toUpperCase() == "COMPLETED") {
        if(lineItem.alreadyReceivedCancel) {
            validationErrors = stcw.appendToValidationErrors("AE0070", Global.translateText("AE0070", null, ["ReviseOrder"]), validationErrors, "updateLineItemActionForReviseOrder (" + lineItem.lineItemIdentifier + ")");
        }
        else {
            // element COMPLETED; so nothing to do
            lineItem.action = existingLineItemAction;
            lineItem.lineItemStatus = "COMPLETED";
            lineItem.isSubmit = existingLineItem.isSubmit;
            lineItem.isCancel = false;
        }
    }
    else if(existingLineItemStatus.toUpperCase() == "CANCELLED") {
        // element CANCELLED; so REJECT
        validationErrors = stcw.appendToValidationErrors("AE0071", Global.translateText("AE0071", null, ["ReviseOrder", "CANCELLED"]), validationErrors, "updateLineItemActionForReviseOrder (" + lineItem.lineItemIdentifier + ")");
    }
    else if(existingLineItemStatus.toUpperCase() == "FAILED" && (!existingLineItemInGranite)) {
        if(lineItem.alreadyReceivedCancel) {
            validationErrors = stcw.appendToValidationErrors("AE0070", Global.translateText("AE0070", null, ["ReviseOrder"]), validationErrors, "updateLineItemActionForReviseOrder (" + lineItem.lineItemIdentifier + ")");
        }
        else {
            lineItem.action = existingLineItem.action;
            lineItem.lineItemStatus = "Hold";
            lineItem.isSubmit = existingLineItem.isSubmit;
            lineItem.isCancel = false;
            lineItem.alreadySentToGranite = false;
        }
    }
    else {
        // in provisioning
        if(lineItem.alreadyReceivedCancel) {
            validationErrors = stcw.appendToValidationErrors("AE0070", Global.translateText("AE0070", null, ["ReviseOrder"]), validationErrors, "updateLineItemActionForReviseOrder (" + lineItem.lineItemIdentifier + ")");
        }
        else {
            lineItem.action = "M";
            lineItem.lineItemStatus = "Hold";
            lineItem.isSubmit = false;
            lineItem.isCancel = false;
            lineItem.alreadySentToGranite = false;
        }
    }

    return validationErrors;
  ]]></script>
</script>