<?xml version="1.0" encoding="UTF-8" ?>
<script name="stcw.checkIfItIsLegacy_F_WithVASNotFeasible">
  <label>Check If It Is A Legacy &quot;F&quot; Order With VAS &quot;Not Feasible&quot;</label>
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="feasibleOrderId" type="rifp">
      <type>dtype_com.conceptwave.system.String</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var debugHeader = "[checkIfIsLegacyWithVASNotFeasible][" + feasibleOrderId + "]";

    var isInLegacyWithVASNotFeasible = false;

    var existingFeasibleOrder = Order.getOrderById(feasibleOrderId);
    if(existingFeasibleOrder != null && existingFeasibleOrder.orderHeader.orderType == "F") {
        // order exists and is a "F" order
        var parentLineItemContainer = existingFeasibleOrder.parentLineItems[0];
        var isLegacy = stcw.isLegacyService(parentLineItemContainer, true);
        if(isLegacy) {
            // the order is a Legacy
            var isParentFeasible = stcw.checkIfLineItemIsFeasibleForQuote(parentLineItemContainer.parentLineItem.lineItemStatus.toUpperCase(), existingFeasibleOrder.orderHeader.orderType);
            if(isParentFeasible) {
                // parentLineItem is Feasible; checking if there is at least a VAS "Not Feasible"
                var foundVASNotFeasible = false;
                if(parentLineItemContainer.services != null) {
                    for(var i=0; i<parentLineItemContainer.services.length; i++) {
                        if(parentLineItemContainer.services[i].serviceLineItem.isVAS == false) {
    debugPrintln(stcc.getSysdateForLog() + debugHeader + " Found a service that is not a VAS! Error");
                            return false;
                        }

                        if(stcw.checkIfLineItemIsNotFeasibleForQuote(parentLineItemContainer.services[i].serviceLineItem.lineItemStatus.toUpperCase(), existingFeasibleOrder.orderHeader.orderType)) {
                            foundVASNotFeasible = true;
                        }
                    }
                }
                if(foundVASNotFeasible) {
                    // found at least a VAS "Not Feasible"; checking that all the processes are completed
                    if(stcw.checkAllProcessesInOrchestrationTableAreCompleted(feasibleOrderId)) {
                        // all processes are completed ==> everything is OK
                        isInLegacyWithVASNotFeasible = true;
                    }
                    else {
                        // there are processes still running - not possible to receive an order on it
    debugPrintln(stcc.getSysdateForLog() + debugHeader + " there is at least a process not yet completed - not possible to receive an order on it");
                    }
                }
                else {
                    // there are no VAS Not Feasible - not possible to receive an order on it
    debugPrintln(stcc.getSysdateForLog() + debugHeader + " there are no VAS lineItem with status 'Not Feasible' - not possible to receive an order on it");
                }
            }
            else {
                // parentLineItem is not Feasible - not possible to receive an order on it!
    debugPrintln(stcc.getSysdateForLog() + debugHeader + " parentLineItem is not Feasible - not possible to receive an order on it");
            }
        }
        else {
            // "F" order is not a Legacy - not possible to receive an order on it!
    debugPrintln(stcc.getSysdateForLog() + debugHeader + " 'F' order is not a Legacy - not possible to receive an order on it!");
        }
    }
    else {
        // order doesn't exist or is not an "F" order - not possible to continue the analysis
    debugPrintln(stcc.getSysdateForLog() + debugHeader + "  order doesn't exist or is not an 'F' order - not possible to continue the analysis!!!");
    }

    return isInLegacyWithVASNotFeasible;
  ]]></script>
</script>