<?xml version="1.0" encoding="UTF-8" ?>
<script name="stcw.updateLineItemActionForReviseFeasibility">
  <label>Update LineItemAction For Revise Feasibility</label>
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="lineItem" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
    <parameter name="existingLineItem" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
    <parameter name="existingOrderWasKO" type="rifp">
      <type>dtype_com.conceptwave.system.Boolean</type>
    </parameter>
    <parameter name="validationErrors" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    /*******
       NOTE:  Please refer to the following table :
    -------------+---------------------+------------------------|
                 | Action: Modify      | Action: Do Nothing     |
    -------------+----------------------------------------------|
     Hold        |                   REJECT                     |
                 |                                              |
                 |                                              |
    -------------+---------------------+------------------------|
     COMPLETED   | REJECT              | Status: COMPLETED      |
                 |                     | Action: existing       |
                 |                     | NO PROVISIONING        |
    -------------+---------------------+------------------------|
     CANCELLED   |                   REJECT                     |
                 |                                              |
                 |                                              |
    -------------+---------------------+------------------------|
     FAILED      | Status: Hold        | REJECT                 |
                 | Action: existing    |                        |
                 | PROVISIONING        |                        |
    -------------+---------------------+------------------------|
     Submitted   |                   REJECT                     |
                 |                                              |
                 |                                              |
    -------------+----------------------------------------------|
    **********/

    var existingLineItemStatus = existingLineItem.lineItemStatus;
    var existingLineItemAction = existingLineItem.action;
    // 2015-12-01: added sentAnytimeToGranite management
    var existingLineItemInGranite = (existingLineItem.alreadySentToGranite || lineItem.sentAnytimeToGranite);

    var receivedAction = lineItem.action;

    if(existingLineItemStatus == "Hold") {
        if(lineItem.isVAS) {
            // maintain the received action
            lineItem.action = existingLineItemAction;
            lineItem.lineItemStatus = "Hold";
            lineItem.isSubmit = true;
            lineItem.isCancel = false;
            lineItem.alreadySentToGranite = false;
        }
        else {
            // just received; nothing happened in provisioning
            validationErrors = stcw.appendToValidationErrors("AE0157", Global.translateText("AE0157", null, ["ReviseOrder For Feasibility", receivedAction, existingLineItemStatus]),
                                                             validationErrors, "updateLineItemActionForReviseFeasibility (" + lineItem.lineItemIdentifier + ")");
        }
    }
    else if(existingLineItemStatus == "Waiting for Granite Resp") {
        // just received; nothing happened in provisioning
        validationErrors = stcw.appendToValidationErrors("AE0157", Global.translateText("AE0157", null, ["ReviseOrder For Feasibility", receivedAction, existingLineItemStatus]),
                                                         validationErrors, "updateLineItemActionForReviseFeasibility (" + lineItem.lineItemIdentifier + ")");
    }
    else if(existingLineItemStatus.toUpperCase() == "COMPLETED" || stcw.checkIfLineItemIsFeasibleForQuote(existingLineItemStatus.toUpperCase(), "F")) {
        // element completed
        if(receivedAction == "M") {
            validationErrors = stcw.appendToValidationErrors("AE0157", Global.translateText("AE0157", null, ["ReviseOrder For Feasibility", receivedAction, existingLineItemStatus]),
                                                             validationErrors, "updateLineItemActionForReviseFeasibility (" + lineItem.lineItemIdentifier + ")");
        }
        else {
            lineItem.action = "N";
            lineItem.lineItemStatus = "FEASIBLE";
        }
    }
    else if(existingLineItemStatus.toUpperCase() == "CANCELLED") {
        // element cancelled
        validationErrors = stcw.appendToValidationErrors("AE0157", Global.translateText("AE0157", null, ["ReviseOrder For Feasibility", receivedAction, existingLineItemStatus]),
                                                         validationErrors, "updateLineItemActionForReviseFeasibility (" + lineItem.lineItemIdentifier + ")");
    }
    else if(stcw.checkIfLineItemIsNotFeasibleForQuote(existingLineItemStatus.toUpperCase(), "F") || existingLineItemStatus.toUpperCase() == "FAILED" ||
            ((existingLineItemStatus.toUpperCase() == "NOT_FEASIBLE" || existingLineItemStatus.toUpperCase() == "PARTIALLY_FEASIBLE") && existingLineItem.elementTypeInOrderTree == "B")) {
        // element failed to be pushed in Granite
        if(receivedAction == "M") {
            lineItem.action = existingLineItemAction;
            lineItem.lineItemStatus = "Hold";
            lineItem.isSubmit = true;
            lineItem.isCancel = false;
            lineItem.alreadySentToGranite = false;
        }
        else {
            validationErrors = stcw.appendToValidationErrors("AE0157", Global.translateText("AE0157", null, ["ReviseOrder For Feasibility", receivedAction, existingLineItemStatus]),
                                                             validationErrors, "updateLineItemActionForReviseFeasibility (" + lineItem.lineItemIdentifier + ")");
        }
    }
    else {
        // element already pushed into Granite
        validationErrors = stcw.appendToValidationErrors("AE0157", Global.translateText("AE0157", null, ["ReviseOrder For Feasibility", receivedAction, existingLineItemStatus]),
                                                         validationErrors, "updateLineItemActionForReviseFeasibility (" + lineItem.lineItemIdentifier + ")");
    }

    return validationErrors;
  ]]></script>
</script>