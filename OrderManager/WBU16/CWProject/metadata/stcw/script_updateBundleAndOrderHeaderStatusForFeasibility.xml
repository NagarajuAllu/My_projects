<?xml version="1.0" encoding="UTF-8" ?>
<script name="stcw.updateBundleAndOrderHeaderStatusForFeasibility">
  <label>Update Bundle And OrderHeader Status For Feasibility</label>
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="bundleOrder" type="rifp">
      <type>order_stcw.wholesaleBundleOrderSTC</type>
    </parameter>
    <parameter name="lineItem" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    debugPrintln(stcc.getSysdateForLog() + "[updateBundleAndOrderHeaderStatusForFeasibility] invoking on order " + bundleOrder.id + ";" + lineItem.toXML());

    var elementStatusInUpperCase = lineItem.lineItemStatus.toUpperCase();
    var bundleLineItem = bundleOrder.parentLineItems[0].parentLineItem;

    var bundleCompletionDate = null;
    var bundleNewStatus = null;

    var orderHeaderCompletionDate = null;
    var orderHeaderNewStatus = null;

    var existProcessKO = stcw.checkIfExistProcessKOInOrchestrationTable(bundleOrder.id);

    var existFeasible = (stcw.checkIfExistALineItemInBundleWithThisStatus("FEASIBLE", bundleLineItem, false) || stcw.checkIfExistALineItemInBundleWithThisStatus("PLANNED FEASIBLE", bundleLineItem, false));
    var existNotFeasible = stcw.checkIfExistALineItemInBundleWithThisStatus("NOT FEASIBLE", bundleLineItem, false);
    var existOnHold = stcw.checkIfExistALineItemInBundleWithThisStatus("ON-HOLD", bundleLineItem, false);
    var existCancelled = stcw.checkIfExistALineItemInBundleWithThisStatus("CANCELLED", bundleLineItem, false);
    var existInProgress = stcw.checkIfExistALineItemInProgressInBundleForQuote(bundleLineItem);
    var allLineItemsOK = stcw.checkThatAllLineItemsInBundleHaveOneOfTheseStatus(["FEASIBLE", "PLANNED FEASIBLE", "CANCELLED"], bundleLineItem, bundleOrder, false);
    var allLineItemsCANCELLED = stcw.checkThatAllLineItemsInBundleHaveOneOfTheseStatus(["CANCELLED"], bundleLineItem, bundleOrder, false);
    var allLineItemsNotFeasible = stcw.checkThatAllLineItemsInBundleHaveOneOfTheseStatus(["NOT FEASIBLE"], bundleLineItem, bundleOrder, false);

    var isVAS = lineItem.isVAS;
    var containsVAS = (lineItem.elementTypeInOrderTree == "B" && bundleLineItem.parentOrderItem.services != null);

    var feasibilityApproach = stcw.getFeasibilityApproachByProductCode(bundleLineItem.productCode);

    if(elementStatusInUpperCase == "FAILED") {
        orderHeaderNewStatus = "FAILED_SUBMIT";
        if(lineItem.elementTypeInOrderTree != 'B' &&!isVAS) {
            bundleNewStatus = "FAILED_SUBMIT";
        }
    }
    else if(elementStatusInUpperCase == "ON-HOLD") {
        if(existProcessKO) {
            orderHeaderNewStatus = "FAILED_SUBMIT";
            if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                bundleNewStatus = "FAILED_SUBMIT";
            }
        }
        else if(existNotFeasible) {
            orderHeaderNewStatus = ((feasibilityApproach == "ALL_OR_NOTHING") ? "NOT_FEASIBLE" : "PARTIALLY_FEASIBLE");
            if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                bundleNewStatus = ((feasibilityApproach == "ALL_OR_NOTHING") ? "NOT_FEASIBLE" : "PARTIALLY_FEASIBLE");
            }
        }
        else if(existFeasible || existCancelled) {
            orderHeaderNewStatus = "ON-HOLD-PC";
            if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                bundleNewStatus = "ON-HOLD-PC";
            }
        }
        else {
            orderHeaderNewStatus = "ON-HOLD";
            if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                bundleNewStatus = "ON-HOLD";
            }
        }
    }
    else if(stcw.checkIfLineItemIsFeasibleForQuote(elementStatusInUpperCase, bundleOrder.orderHeader.orderType)) {
        if(lineItem.elementTypeInOrderTree == 'B') {
            bundleNewStatus = elementStatusInUpperCase;
            bundleCompletionDate = new Date();
            if(! containsVAS) {
                orderHeaderNewStatus = "COMPLETED";
                orderHeaderCompletionDate = new Date();
            }
            else {
                // checking if VAS are already completed due to action = "N"
                var allVASCompleted = true;
                for(var i=0; i<bundleLineItem.parentOrderItem.services.length; i++) {
                    var vasElementStatus = bundleLineItem.parentOrderItem.services[i].serviceLineItem.lineItemStatus.toUpperCase();
                    if(! stcw.checkIfLineItemIsFeasibleForQuote(vasElementStatus, bundleOrder.orderHeader.orderType)) {
                        allVASCompleted = false;
                    }
                }

                if(allVASCompleted) {
                    orderHeaderNewStatus = "COMPLETED";
                    orderHeaderCompletionDate = new Date();
                }
            }
        }
        else if(existProcessKO) {
            orderHeaderNewStatus = "FAILED_SUBMIT";
            if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                bundleNewStatus = "FAILED_SUBMIT";
            }
        }
        else if(existNotFeasible) {
            orderHeaderNewStatus = ((feasibilityApproach == "ALL_OR_NOTHING") ? "NOT_FEASIBLE" : "PARTIALLY_FEASIBLE");
            if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                bundleNewStatus = ((feasibilityApproach == "ALL_OR_NOTHING") ? "NOT_FEASIBLE" : "PARTIALLY_FEASIBLE");
            }
        }
        else if(allLineItemsOK) {
            orderHeaderNewStatus = "COMPLETED";
            orderHeaderCompletionDate = new Date();
            if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                bundleNewStatus = "COMPLETED";
                bundleCompletionDate = new Date();
            }
        }
        else if(existOnHold) {
            orderHeaderNewStatus = "ON-HOLD-PC";
            if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                bundleNewStatus = "ON-HOLD-PC";
            }
        }
        else {
            orderHeaderNewStatus = "IN-PROGRESS";
            if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                bundleNewStatus = "IN-PROGRESS";
            }
        }
    }
    else if(elementStatusInUpperCase == "CANCELLED") {
        if(lineItem.elementTypeInOrderTree == 'B') {
            bundleNewStatus = elementStatusInUpperCase;
            bundleCompletionDate = new Date();
            if(! containsVAS || lineItem.action == "D") {
              orderHeaderNewStatus = "CANCELLED";
              orderHeaderCompletionDate = new Date();
            }
            else if(containsVAS) {
                // checking if VAS are already completed due to action = "N"
                var allVASCancelled = true;
                for(var i=0; i<bundleLineItem.parentOrderItem.services.length; i++) {
                    var vasElementStatus = bundleLineItem.parentOrderItem.services[i].serviceLineItem.lineItemStatus.toUpperCase();
                    if(vasElementStatus != "CANCELLED") {
                        allVASCancelled = false;
                    }
                }

                if(allVASCancelled) {
                    orderHeaderNewStatus = "CANCELLED";
                    orderHeaderCompletionDate = new Date();
                }
            }
        }
        else if(existProcessKO) {
            orderHeaderNewStatus = "FAILED_SUBMIT";
            if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                bundleNewStatus = "FAILED_SUBMIT";
            }
        }
        else if(existNotFeasible) {
            orderHeaderNewStatus = ((feasibilityApproach == "ALL_OR_NOTHING") ? "NOT_FEASIBLE" : "PARTIALLY_FEASIBLE");
            if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                bundleNewStatus = ((feasibilityApproach == "ALL_OR_NOTHING") ? "NOT_FEASIBLE" : "PARTIALLY_FEASIBLE");
            }
        }
        else if(allLineItemsCANCELLED) {
            if(bundleLineItem.action != "D") {
                bundleNewStatus = elementStatusInUpperCase;
                bundleCompletionDate = new Date();
                orderHeaderNewStatus = "CANCELLED";
                orderHeaderCompletionDate = new Date();
            }
            else {
                // Introduces while managing VAS and, more specific, managing disconnection for parent!
                // nothing to do
                // because, in case the bundle has action = "D", the approach is bottom-up
            }
        }
        else if(allLineItemsOK) {
            orderHeaderNewStatus = "COMPLETED";
            orderHeaderCompletionDate = new Date();
            if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                bundleNewStatus = "COMPLETED";
                bundleCompletionDate = new Date();
            }
        }
        else if(existOnHold) {
            orderHeaderNewStatus = "ON-HOLD-PC";
            if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                bundleNewStatus = "ON-HOLD-PC";
            }
        }
        else {
            orderHeaderNewStatus = "IN-PROGRESS";
            if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                bundleNewStatus = "IN-PROGRESS";
            }
        }
    }
    else if(stcw.checkIfLineItemIsNotFeasibleForQuote(elementStatusInUpperCase, bundleOrder.orderHeader.orderType)) {
        if(existProcessKO) {
            orderHeaderNewStatus = "FAILED_SUBMIT";
            if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                bundleNewStatus = "FAILED_SUBMIT";
            }
        }
        else if(allLineItemsNotFeasible) {
            orderHeaderNewStatus = "NOT_FEASIBLE";
            if(lineItem.elementTypeInOrderTree != 'B') {
                if(!isVAS) {
                    bundleNewStatus = "NOT_FEASIBLE";
                }
                else {
                    // do nothing
                }
            }
            else {
                bundleNewStatus = elementStatusInUpperCase;
            }
        }
        else {
            orderHeaderNewStatus = ((feasibilityApproach == "ALL_OR_NOTHING") ? "NOT_FEASIBLE" : "PARTIALLY_FEASIBLE");
            if(lineItem.elementTypeInOrderTree != 'B') {
                if(!isVAS) {
                    bundleNewStatus = ((feasibilityApproach == "ALL_OR_NOTHING") ? "NOT_FEASIBLE" : "PARTIALLY_FEASIBLE");
                }
                else {
                    // do nothing
                }
            }
            else {
                bundleNewStatus = elementStatusInUpperCase
            }
        }
    }
    else {
        if(existProcessKO) {
            orderHeaderNewStatus = "FAILED_SUBMIT";
            if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                bundleNewStatus = "FAILED_SUBMIT";
            }
        }
        else if(existNotFeasible) {
            orderHeaderNewStatus = ((feasibilityApproach == "ALL_OR_NOTHING") ? "NOT_FEASIBLE" : "PARTIALLY_FEASIBLE");
            if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                bundleNewStatus = ((feasibilityApproach == "ALL_OR_NOTHING") ? "NOT_FEASIBLE" : "PARTIALLY_FEASIBLE");
            }
        }
        else if(existFeasible || existCancelled) {
            if(existOnHold) {
                orderHeaderNewStatus = "ON-HOLD-PC";
                if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                    bundleNewStatus = "ON-HOLD-PC";
                }
            }
            else {
                orderHeaderNewStatus = "IN-PROGRESS";
                if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                    bundleNewStatus = "IN-PROGRESS";
                }
            }
        }
        else {
            if(existOnHold) {
                orderHeaderNewStatus = "ON-HOLD";
                if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                    bundleNewStatus = "ON-HOLD";
                }
            }
            else {
                orderHeaderNewStatus = "ORDERED";
                if(lineItem.elementTypeInOrderTree != 'B' && !isVAS) {
                    bundleNewStatus = "ORDERED";
                }
            }
        }
    }

    // finally update bundle status!
    if(bundleNewStatus != null) {
        bundleLineItem.lineItemStatus = bundleNewStatus;
        if(bundleCompletionDate != null && bundleLineItem.completionDate == null) {
            bundleLineItem.completionDate = bundleCompletionDate;
        }

    debugPrintln(stcc.getSysdateForLog() + "[updateBundleAndOrderHeaderStatusForFeasibility] on <" + bundleOrder.orderHeader.orderNumber + "," + lineItem.lineItemIdentifier + ">; bundleLineItem.lineItemStatus = " + bundleNewStatus);
        bundleLineItem.save();
    }
    else {
    debugPrintln(stcc.getSysdateForLog() + "[updateBundleAndOrderHeaderStatusForFeasibility] on <" + bundleOrder.orderHeader.orderNumber + "," + lineItem.lineItemIdentifier + ">; bundleLineItem.lineItemStatus not changed!");
    }


    // finally update header status
    if(orderHeaderNewStatus != null) {
        bundleOrder.orderHeader.orderStatus = orderHeaderNewStatus;
        if(orderHeaderCompletionDate != null) {
            bundleOrder.orderHeader.completionDate = orderHeaderCompletionDate;
        }
    debugPrintln(stcc.getSysdateForLog() + "[updateBundleAndOrderHeaderStatusForFeasibility] on <" + bundleOrder.orderHeader.orderNumber + "," + lineItem.lineItemIdentifier + ">; bundleOrder.orderHeader.orderStatus = " + orderHeaderNewStatus);

        bundleOrder.save();
    }
    else {
    debugPrintln(stcc.getSysdateForLog() + "[updateBundleAndOrderHeaderStatusForFeasibility] on <" + bundleOrder.orderHeader.orderNumber + "," + lineItem.lineItemIdentifier + ">; bundleOrder.orderHeader.orderStatus not changed!");
    }
  ]]></script>
</script>