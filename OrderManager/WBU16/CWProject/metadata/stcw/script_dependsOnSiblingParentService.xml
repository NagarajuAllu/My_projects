<?xml version="1.0" encoding="UTF-8" ?>
<script name="stcw.dependsOnSiblingParentService">
  <label>Depends on Sibling ParentService</label>
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="serviceType" type="rifp">
      <type>dtype_com.conceptwave.system.String</type>
    </parameter>
    <parameter name="orderUnderMgmt" type="rifp">
      <type>order_stcw.wholesaleBundleOrderSTC</type>
    </parameter>
    <parameter name="elementTypeInOrderTree" type="rifp">
      <type>dtype_stcw.elementTypeInOrderTree</type>
    </parameter>
    <parameter name="priority" type="rifp">
      <type>dtype_wsws.lineItemPriority</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var debugMsg = " dependsOnParentService - ";

    debugPrintln(stcc.getSysdateForLog() + debugMsg + "Invoked with(" + serviceType + "," + orderUnderMgmt.id + "," + elementTypeInOrderTree + "," + priority + ")");

    var searchDoc = new Document("stcconf.search_serviceTypesHierarchy");
    searchDoc.childServiceType = serviceType;

    var resultList = Finder.runFinder("stcconf.findServiceTypeHierarchyConf", "select", searchDoc);

    var parentServiceId = null;

    if(resultList != null && resultList.length > 0) {
        for(var i=0; i<resultList.length && parentServiceId == null; i++) {
            var parentServiceType = resultList[i].parentServiceType;

    debugPrintln(stcc.getSysdateForLog() + debugMsg + "Found ParentService <" + parentServiceType + "> for service " + serviceType);

            var searchDocForLineItem = new Document("stcw.search_LineItemByServiceTypeAndPosition");
            searchDocForLineItem.orderId = orderUnderMgmt.id;
            searchDocForLineItem.receivedServiceType = parentServiceType;
            searchDocForLineItem.elementTypeInOrderTree = (resultList[i].isSibling ? elementTypeInOrderTree : null);
            searchDocForLineItem.priority = (resultList[i].isSibling ? priority : null);

            var resultServiceList = Finder.runFinder("stcw.findLineItemInOrderByServiceTypeAndPosition", "select", searchDocForLineItem);
            if(resultServiceList != null && resultServiceList.length > 0) {
                for (var j=0; j<resultServiceList.length && parentServiceId == null ; j++) {
                    var foundServiceId = resultServiceList[j].id;
    debugPrintln(stcc.getSysdateForLog() + debugMsg + "Processing " +  j + " instance of service <" + parentServiceType + "> in order with given priority and position: " + foundServiceId);

                    var orchestrationRecord = stcw.getRecordInOrchestrationTableByLineItemId(foundServiceId);
                    if(orchestrationRecord != null) {
                        parentServiceId = foundServiceId;
    debugPrintln(stcc.getSysdateForLog() + debugMsg + "Found parentService instance: " + parentServiceId);
                    }
                }
            }
            else {
    debugPrintln(stcc.getSysdateForLog() + debugMsg + "Not ParentService <" + parentServiceType + "> in order with given priority and position");
            }
        }
    }
    else {
    debugPrintln(stcc.getSysdateForLog() + debugMsg + "Not ParentService for serviceType <" + serviceType + "> in hierarchy");
    }

    return parentServiceId;
  ]]></script>
</script>