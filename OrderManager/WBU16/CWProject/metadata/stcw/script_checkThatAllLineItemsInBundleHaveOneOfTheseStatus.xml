<?xml version="1.0" encoding="UTF-8" ?>
<script name="stcw.checkThatAllLineItemsInBundleHaveOneOfTheseStatus">
  <label>Check That All LineItems In Bundle Have One Of These Status</label>
  <metaVersion>4</metaVersion>
  <parameterList>
    <parameter name="lineItemExpectedStatusArray" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
    <parameter name="lineItemParent" type="rifp">
      <type>doc_stcw.lineItemDocument</type>
    </parameter>
    <parameter name="bundleOrder" type="rifp">
      <type>order_stcw.wholesaleBundleOrderSTC</type>
    </parameter>
    <parameter name="considerOnlyProvisionable" type="rifp">
      <type>dtype_com.conceptwave.system.Boolean</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    debugPrintln(stcc.getSysdateForLog() + " checkThatAllLineItemsInBundleHaveOneOfTheseStatus([" + lineItemExpectedStatusArray + "]," + lineItemParent + ")");

    var sameStatus = true;
    var orchestrationRecordForChildLineItems = stcw.findRecordsInOrchTabByOrderId_ParentId(bundleOrder.id, lineItemParent.id);
    if(orchestrationRecordForChildLineItems != null && orchestrationRecordForChildLineItems.length > 0) {
        for(var i=0; i<orchestrationRecordForChildLineItems.length && sameStatus; i++) {
            var orchestrationRecord = orchestrationRecordForChildLineItems[i];
            var lineItem = Document.readDoc("stcw.lineItemDocument", orchestrationRecordForChildLineItems[i].cwDocId);

            if(orchestrationRecord.provisionable || !considerOnlyProvisionable || (lineItem.provisioningBU == "H" && lineItem.action != "N")) {
                var found = false;
                for(var j=0; j<lineItemExpectedStatusArray.length && !found; j++) {
                    found = (lineItem.lineItemStatus.toUpperCase() == lineItemExpectedStatusArray[j].toUpperCase());
                }
                sameStatus = found;
            }
            else {
                sameStatus = true;
            }

            if(sameStatus) {
                // loop for children of the record
                sameStatus = stcw.checkThatAllLineItemsInBundleHaveOneOfTheseStatus(lineItemExpectedStatusArray, lineItem, bundleOrder, considerOnlyProvisionable);
            }
        }
    }

    debugPrintln(stcc.getSysdateForLog() + " checkThatAllLineItemsInBundleHaveOneOfTheseStatus([" + lineItemExpectedStatusArray + "]," + lineItemParent + "): " + sameStatus);
    return sameStatus;
  ]]></script>
</script>