<?xml version="1.0" encoding="UTF-8" ?>
<process name="stcw.ftthSTCWOrchestrationProcess">
  <activity name="start" type="seqActivity">
    <label>Start</label>
    <x>78.0</x>
    <y>56.0</y>
    <childList>
      <child name="setProcessIdInOrchestrationTable" type="scriptActivity">
        <label>Set Process Id In Orchestration Table</label>
        <x>200.0</x>
        <y>20.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              var recordInOrchestrationTable = stcw.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);
              recordInOrchestrationTable.orchestrationProcessId = this.process.id;
              recordInOrchestrationTable.save();
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="isElementProvisionable" type="switchActivity">
        <label>Is Element Provisionable?</label>
        <x>334.0</x>
        <y>42.0</y>
        <childList>
          <child name="yes" type="caseActivity">
            <label>Yes</label>
            <x>78.0</x>
            <y>256.0</y>
            <childList>
              <child name="start" type="seqActivity">
                <label>Start</label>
                <x>481.0</x>
                <y>51.0</y>
                <childList>
                  <child name="startProvisioningProcessForEntireOrder" type="scriptActivity">
                    <label>Start Provisioning Process For Entire Order</label>
                    <x>588.0</x>
                    <y>16.0</y>
                    <methodList>
                      <method name="cwOnProcActBefore" type="action">
                        <category>before</category>
                        <system>true</system>
                        <script><![CDATA[
                          debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - starting FTTHProvisioningProcessForElement: " + this.process.processOrderItem.id);

                          var processName = "stcw.ftthSTCWProvisiongProcess";

                          var pid = Process.startProcess(processName, this.process.processOrder.id, this.process.processOrderItem.id);
                          debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - started FTTHProvisioningProcess: " + pid + "; type: " + processName + "; element: " + this.process.processOrderItem.id);

                          var recordInOrchestrationTable = stcw.getRecordInOrchestrationTableByLineItemId(this.process.processOrderItem.id);
                          recordInOrchestrationTable.provisioningProcessId = pid;
                          recordInOrchestrationTable.save();
                        ]]></script>
                      </method>
                    </methodList>
                  </child>
                  <child name="waitForProvisioningCompleted" type="syncActivity">
                    <element>signal_stcw.notifyProvisioningIsCompleted</element>
                    <label>Wait For Provisioning Completed</label>
                    <x>699.0</x>
                    <y>33.0</y>
                    <methodList>
                      <method name="cwOnProcActAfter" type="action">
                        <category>script</category>
                        <system>true</system>
                        <script><![CDATA[
                          debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - provisioningProcessForElement " + this.process.processOrderItem.id + " - Completed!");
                        ]]></script>
                      </method>
                    </methodList>
                  </child>
                </childList>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActCond" type="action">
                <category>cond</category>
                <system>true</system>
                <script><![CDATA[
                  var isProvisionable = stcw.isServiceProvisionable(this.process.processOrderItem.id);

                  debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Checked if orderItem <" + this.process.processOrderItem.id + "> is provisionable = " + isProvisionable);

                  return isProvisionable;
                ]]></script>
              </method>
            </methodList>
          </child>
          <child name="no" type="caseActivity">
            <label>No</label>
            <x>78.0</x>
            <y>256.0</y>
            <childList>
              <child name="notProvisionable" type="scriptActivity">
                <label>Not Provisionable</label>
                <x>603.0</x>
                <y>220.0</y>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[
                      debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - orderItem <" + this.process.processOrderItem.id + "> is NOT provisionable so skipping the provisioning process");
                    ]]></script>
                  </method>
                </methodList>
              </child>
            </childList>
          </child>
        </childList>
      </child>
      <child name="sendWakeUpToParentProcess" type="scriptActivity">
        <label>Send WakeUp To Parent Process</label>
        <x>842.0</x>
        <y>22.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              // it has to return the id of the parent process
              var recordForParentElementInOrchestrationTable = stcw.getRecordInOrchestrationTableForOrderHeader(this.process.processOrder.id);

              var processInstance = Process.getProcessInfo(recordForParentElementInOrchestrationTable.orchestrationProcessId);
              if(processInstance != null) {
                  if(processInstance.processStatus == 8) {
                      // the process is in status 8, so STALE; resume it
                      debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Resuming Stale process " + recordForParentElementInOrchestrationTable.orchestrationProcessId);
                      Process.resumeAllStaleProcesses(recordForParentElementInOrchestrationTable.orchestrationProcessId);
                  }
              }


              debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - SendWakeUp; parentProcessId " + recordForParentElementInOrchestrationTable.orchestrationProcessId);

              Process.sendSignal("stcw.wakeUpParentInOrchestration", recordForParentElementInOrchestrationTable.orchestrationProcessId);
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="end" type="completeActivity">
        <label>End</label>
        <x>997.0</x>
        <y>45.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Completed OrchestrationWorkflow for element " + this.process.processOrderItem.id);
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="stopProcess" type="onExceptionActivity">
        <element>excp_cwf.stop</element>
        <label>Stop Process</label>
        <x>20.0</x>
        <y>134.0</y>
        <childList>
          <child name="start" type="seqActivity">
            <label>Start</label>
            <x>78.0</x>
            <y>179.0</y>
            <childList>
              <child name="stopOrchestrationProcess" type="completeActivity">
                <label>Stop Orchestration Process</label>
                <x>64.0</x>
                <y>339.0</y>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[
                      debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Received Stop for this Orchestration process");
                    ]]></script>
                  </method>
                </methodList>
              </child>
            </childList>
          </child>
        </childList>
      </child>
    </childList>
    <methodList>
      <method name="cwOnProcActBefore" type="action">
        <category>before</category>
        <system>true</system>
        <script><![CDATA[
          debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Starting OrchestrationWorkflow for element " + this.process.processOrderItem.id);
        ]]></script>
      </method>
    </methodList>
  </activity>
  <curRevision>true</curRevision>
  <document>doc_stcw.stcwOrchestrationProcessDocument</document>
  <label>FTTH - STCW Orchestration Process</label>
  <metaVersion>25</metaVersion>
  <priority>8</priority>
  <type>User</type>
</process>