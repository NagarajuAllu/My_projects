<?xml version="1.0" encoding="UTF-8" ?>
<process name="stcw.receiveSiteInfoUpdateAckFromCRM">
  <activity name="start" type="seqActivity">
    <label>Start</label>
    <x>103.99744</x>
    <y>34.0</y>
    <childList>
      <child name="justForCompensation" type="scriptActivity">
        <label>Just For Compensation</label>
        <x>329.66412</x>
        <y>28.0</y>
        <childList>
          <child name="compensateInterfaceTimeout" type="compensateActivity">
            <compensatesList>
              <compensates>7</compensates>
            </compensatesList>
            <label>Compensate Interface Timeout</label>
            <x>604.99744</x>
            <y>112.0</y>
            <childList>
              <child name="startCompensation" type="seqActivity">
                <label>Start Compensation</label>
                <x>559.46704</x>
                <y>126.11151</y>
                <childList>
                  <child name="insertSiteInfoIntoReportTable" type="scriptActivity">
                    <label>Insert SiteInfo Into Report Table</label>
                    <x>730.0</x>
                    <y>122.70117</y>
                    <methodList>
                      <method name="cwOnProcActBefore" type="action">
                        <category>before</category>
                        <system>true</system>
                        <script><![CDATA[
                          debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Insert into REPORT table 'SITE_INFO_NOT_ACK'");

                          var graniteInput = stcw.findGenericProcessMessage(this.process.id, "GRANITE_REQUEST", "wgws:siteInformationUpdate");

                          debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - graniteInput = '" + graniteInput.toXML() + "'");

                          var recordFound = stcr.getSIUWithoutAck(graniteInput.siteID, graniteInput.ccliCode);
                          if(recordFound != null) {
                              debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Record already existing in REPORT table 'SITE_INFO_NOT_ACK'");
                          }
                          else {
                              stcr.storeSIUInfoWithoutAck(graniteInput.ccliCode, graniteInput.siteID);
                              debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Record inserted in REPORT table 'SITE_INFO_NOT_ACK'");
                          }
                        ]]></script>
                      </method>
                    </methodList>
                  </child>
                  <child name="forceSkipNextAction" type="scriptActivity">
                    <label>Force Skip Next Action</label>
                    <x>734.3428</x>
                    <y>268.50586</y>
                    <methodList>
                      <method name="cwOnProcActBefore" type="action">
                        <category>before</category>
                        <system>true</system>
                        <script><![CDATA[
                          this.process.processDocument.skipNextActivity = true;
                          debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Skip Next Action");
                        ]]></script>
                      </method>
                    </methodList>
                  </child>
                </childList>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[
                      debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Starting compensation management for missing receiving SIU_Ack");
                    ]]></script>
                  </method>
                </methodList>
              </child>
            </childList>
          </child>
        </childList>
      </child>
      <child name="skipNextActivity" type="switchActivity">
        <label>Skip Next Activity?</label>
        <x>349.2898</x>
        <y>242.40234</y>
        <childList>
          <child name="no" type="caseActivity">
            <label>No</label>
            <x>313.0</x>
            <y>266.70117</y>
            <childList>
              <child name="receiveSiteInfoUpdateAck" type="opActivity">
                <element>iface_wsws.ifExpedtier_WHOLESALE/oper_operation_SiteInformationUpdateAck</element>
                <label>Receive SiteInfoUpdateAck</label>
                <participant>part_stcw.eaiInputInterface</participant>
                <x>229.51123</x>
                <y>379.85645</y>
                <methodList>
                  <method name="cwOnProcActAfter" type="action">
                    <category>script</category>
                    <system>true</system>
                    <script><![CDATA[
                      rpts.updateHistoryEvent (this, "eaiReceiveSiteInfoUpdateAck");

                      stcw.storeGenericProcessMessage (this.process.id, "CRM_ACK", this.activityData);

                      var graniteInput = stcw.findGenericProcessMessage(this.process.id, "GRANITE_REQUEST", "wgws:siteInformationUpdate");

                      debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - graniteInput = '" + graniteInput.toXML() + "'");

                      debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - search SIUWithoutAck = <" + graniteInput.siteID + "," + graniteInput.ccliCode + ">");
                      var recordFound = stcr.getSIUWithoutAck(graniteInput.siteID, graniteInput.ccliCode);
                      if(recordFound == null) {
                          debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Record not existing in REPORT table 'SITE_INFO_NOT_ACK'");
                      }
                      else {
                          recordFound.deleteItem();
                          debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - Record deleted from REPORT table 'SITE_INFO_NOT_ACK'");
                      }
                    ]]></script>
                  </method>
                  <method name="cwOnProcActCond" type="action">
                    <category>cond</category>
                    <system>true</system>
                    <script><![CDATA[
                      rpts.createHistoryEvent (this);
                      return (true);
                    ]]></script>
                  </method>
                </methodList>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActCond" type="action">
                <category>cond</category>
                <system>true</system>
                <script><![CDATA[
                  debugPrintln(stcc.getSysdateForLog() + "[" + this.process.id + "] - skipNextAction = " + this.process.processDocument.skipNextActivity);
                  return (! this.process.processDocument.skipNextActivity);
                ]]></script>
              </method>
            </methodList>
          </child>
          <child name="yes" type="caseActivity">
            <label>Yes</label>
            <x>516.9038</x>
            <y>372.20703</y>
          </child>
        </childList>
      </child>
      <child name="done" type="scriptActivity">
        <label>Done</label>
        <x>412.66412</x>
        <y>551.0</y>
      </child>
      <child name="eaiInputInterface" type="participantActivity">
        <label>EAI Input Interface</label>
        <participant>part_stcw.eaiInputInterface</participant>
        <x>69.0</x>
        <y>303.0</y>
      </child>
    </childList>
    <methodList>
      <method name="cwOnProcActBefore" type="action">
        <category>before</category>
        <system>true</system>
        <script><![CDATA[
          this.process.processDocument.skipNextActivity = false;
          this.process.processDocument.interOperationName = "wsws:ifExpedtier_WHOLESALE/operation_SiteInformationUpdateAck";
          this.process.processDocument.rollbackNumber = "7";
        ]]></script>
      </method>
    </methodList>
  </activity>
  <curRevision>true</curRevision>
  <label>Receive SiteInfoUpdateAck From CRM</label>
  <metaVersion>22</metaVersion>
  <priority>8</priority>
  <revision>2</revision>
  <type>Sub-flow</type>
</process>