<?xml version="1.0" encoding="UTF-8" ?>
<script name="stcw.complete_F_LegacyProvisioningWithVASNotFeasible">
  <label>Complete &quot;F&quot; Legacy In Provisioning With VAS &quot;Not Feasible&quot;</label>
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="receivedOrder" type="rifp">
      <type>order_stcw.wholesaleBundleOrderSTC</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    if(receivedOrder == null) {
        return;
    }

    if(receivedOrder.parentLineItems == null || receivedOrder.parentLineItems.length == 0) {
        return;
    }

    var parentLineItem = receivedOrder.parentLineItems[0].parentLineItem;

    var provisioningLineItem = stcw.getLineItemByServiceNumberAndLIIdAndProvFlag(null, parentLineItem.lineItemIdentifier, "PROVISIONING");
    if(provisioningLineItem == null) {
        return;
    }

    if(stcw.checkIfItIsLegacy_F_WithVASNotFeasible(provisioningLineItem.orderId)) {
    debugPrintln(stcc.getSysdateForLog() + "[complete_F_LegacyProvisioningWithVASNotFeasible] - Starting Completion 'F' Legacy order in Provisioning With VAS 'Not Feasible'; provisioningOrderId " + provisioningLineItem.orderId);

        var feasibilityOrder = Order.getOrderById(provisioningLineItem.orderId);

        // archiving the ACTIVE version of the lineItem
        var activeLineItems = stcw.getAllLineItemsByIdentifierAndProvisioningFlag(provisioningLineItem.lineItemIdentifier, "B", "ACTIVE");
        for(var j=0; j<activeLineItems.length; j++) {
            activeLineItems[j].provisioningFlag = "OLD";
            activeLineItems[j].save();

            feasibilityOrder.parentLineItems[0].parentLineItem.previousActiveDocId = activeLineItems[j].id;
        }


        // cancel the "Not Feasible" lineItems
        if(feasibilityOrder.parentLineItems[0].services != null) {
            for(var j=0; j<feasibilityOrder.parentLineItems[0].services.length; j++) {
                if(stcw.checkIfLineItemIsNotFeasibleForQuote(feasibilityOrder.parentLineItems[0].services[j].serviceLineItem.lineItemStatus.toUpperCase(), feasibilityOrder.orderHeader.orderType)) {
                    feasibilityOrder.parentLineItems[0].services[j].serviceLineItem.lineItemStatus = "CANCELLED";
                    feasibilityOrder.parentLineItems[0].services[j].serviceLineItem.completionDate = new Date();
                }
            }
        }

        // complete the parent lineItem
        feasibilityOrder.parentLineItems[0].parentLineItem.provisioningFlag = "ACTIVE";

        // changing the status of the orderHeader
        feasibilityOrder.orderHeader.orderStatus = "COMPLETED";
        feasibilityOrder.orderHeader.completionDate = new Date();


        // save
        feasibilityOrder.save();
    debugPrintln(stcc.getSysdateForLog() + "[complete_F_LegacyProvisioningWithVASNotFeasible] - Done Completion 'F' Legacy order in Provisioning With VAS 'Not Feasible'; provisioningOrderId " + provisioningLineItem.orderId);
    }
  ]]></script>
</script>