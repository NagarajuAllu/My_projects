<?xml version="1.0" encoding="UTF-8" ?>
<process name="workflow.taskManagementProcess">
  <activity name="start" type="seqActivity">
    <label>Start</label>
    <x>279.62885</x>
    <y>30.0</y>
    <childList>
      <child name="startForCompensate" type="seqActivity">
        <label>Start For Compensate</label>
        <x>287.07986</x>
        <y>124.94023</y>
        <childList>
          <child name="justForCompensate" type="scriptActivity">
            <label>Just For Compensate</label>
            <x>408.6626</x>
            <y>229.992</y>
            <childList>
              <child name="taskRejectionManagement" type="compensateActivity">
                <compensatesList>
                  <compensates>1</compensates>
                </compensatesList>
                <label>Task Rejection Management</label>
                <x>433.78436</x>
                <y>130.0</y>
                <childList>
                  <child name="startBIManagementForTask" type="seqActivity">
                    <label>Start BI Management For Task</label>
                    <x>592.60693</x>
                    <y>361.47598</y>
                    <childList>
                      <child name="doSomething" type="scriptActivity">
                        <label>Do Something</label>
                        <x>598.47217</x>
                        <y>474.84845</y>
                      </child>
                    </childList>
                    <methodList>
                      <method name="cwOnProcActBefore" type="action">
                        <category>before</category>
                        <system>true</system>
                        <script><![CDATA[
                          debugPrintln(workflow.getLogHeaderForProcess(this.process.id) + "Starting compensation for Task Rejection");
                        ]]></script>
                      </method>
                    </methodList>
                  </child>
                </childList>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActBefore" type="action">
                <category>before</category>
                <system>true</system>
                <script><![CDATA[debugPrintln(workflow.getLogHeaderForProcess(this.process.id) + "do nothing - just for compensate");]]></script>
              </method>
            </methodList>
          </child>
          <child name="forkForTaskManagement" type="allActivity">
            <label>Fork For Task Management</label>
            <x>234.3378</x>
            <y>364.10678</y>
            <childList>
              <child name="startForSiteManagement" type="seqActivity">
                <label>Start For Site Management</label>
                <x>371.61417</x>
                <y>490.51974</y>
                <childList>
                  <child name="assignToAcceptRejectTask" type="opActivity">
                    <element>iface_workflow.siteTeamIF/oper_acceptingTask_Site</element>
                    <label>Assign To Accept or Reject Task</label>
                    <participant>part_workflow.siteTeamParticipant</participant>
                    <x>369.2036</x>
                    <y>600.95197</y>
                    <methodList>
                      <method name="cwOnProcActBefore" type="action">
                        <category>before</category>
                        <system>true</system>
                        <script><![CDATA[
                          if(this.process.processOrderItem.assignSiteTeamDate == null) {
                              this.process.processOrderItem.assignSiteTeamDate = new Date();
                          }

                          this.process.processOrderItem.acceptSiteTeamDate = null;
                          this.process.processOrderItem.save();
                        ]]></script>
                      </method>
                    </methodList>
                  </child>
                  <child name="acceptOrReject" type="choiceActivity">
                    <label>Accept Or Reject</label>
                    <x>301.36523</x>
                    <y>749.10724</y>
                    <childList>
                      <child name="acceptTask" type="opActivity">
                        <element>iface_workflow.siteTeamIF/oper_acceptTask</element>
                        <label>Accept Task</label>
                        <participant>part_workflow.siteTeamParticipant</participant>
                        <x>264.62012</x>
                        <y>882.86017</y>
                        <methodList>
                          <method name="cwOnProcActAfter" type="action">
                            <category>script</category>
                            <system>true</system>
                            <script><![CDATA[
                              debugPrintln(workflow.getLogHeaderForProcess(this.process.id) + "Task " + this.process.processOrderItem.taskName + " accepted by SiteTeam");

                              this.process.processOrderItem.acceptSiteTeamDate = new Date();
                              this.process.processOrderItem.status = configuration.getExternalNameForStatusByInternalName("SITE_ACCEPTED", "TFR_TASK");
                              this.process.processOrderItem.save();
                            ]]></script>
                          </method>
                        </methodList>
                      </child>
                      <child name="rejectTask" type="opActivity">
                        <element>iface_workflow.siteTeamIF/oper_rejectTask</element>
                        <label>Reject Task</label>
                        <participant>part_workflow.siteTeamParticipant</participant>
                        <x>449.97168</x>
                        <y>882.86017</y>
                        <childList>
                          <child name="taskRejectedException" type="exceptActivity">
                            <element>excp_workflow.taskRejectedException</element>
                            <label>Task Rejected Exception</label>
                            <x>440.6289</x>
                            <y>1009.26245</y>
                          </child>
                        </childList>
                        <methodList>
                          <method name="cwOnProcActAfter" type="action">
                            <category>script</category>
                            <system>true</system>
                            <script><![CDATA[
                              debugPrintln(workflow.getLogHeaderForProcess(this.process.id) + "Task  " + this.process.processOrderItem.taskName + " rejected by Site Team");

                              this.process.processOrderItem.status = configuration.getExternalNameForStatusByInternalName("REJECTED", "TFR_TASK");
                              this.process.processOrderItem.save();
                            ]]></script>
                          </method>
                        </methodList>
                      </child>
                    </childList>
                  </child>
                </childList>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[
                      workflow.overload_computeNextUser(this.process.processOrder.id, this.process.processOrderItem.id, this.process.id, "taskManagementProcess", "acceptingTask_Site");
                    ]]></script>
                  </method>
                </methodList>
              </child>
              <child name="startForQualityManagement" type="seqActivity">
                <label>Start For Quality Management</label>
                <x>220.39113</x>
                <y>490.51974</y>
                <childList>
                  <child name="assignToAcceptRejectTask" type="opActivity">
                    <element>iface_workflow.qualityTeamIF/oper_acceptingTask_Quality</element>
                    <label>Assign To Accept or Reject Task</label>
                    <participant>part_workflow.qualityTeamParticipant</participant>
                    <x>97.83838</x>
                    <y>600.95197</y>
                    <methodList>
                      <method name="cwOnProcActBefore" type="action">
                        <category>before</category>
                        <system>true</system>
                        <script><![CDATA[
                          if(this.process.processOrderItem.assignQualityTeamDate == null) {
                              this.process.processOrderItem.assignQualityTeamDate = new Date();
                          }

                          this.process.processOrderItem.acceptQualityTeamDate = null;
                          this.process.processOrderItem.save();
                        ]]></script>
                      </method>
                    </methodList>
                  </child>
                  <child name="acceptOrReject" type="choiceActivity">
                    <label>Accept Or Reject</label>
                    <x>30.0</x>
                    <y>749.10724</y>
                    <childList>
                      <child name="acceptTask" type="opActivity">
                        <element>iface_workflow.qualityTeamIF/oper_acceptTask</element>
                        <label>Accept Task</label>
                        <participant>part_workflow.qualityTeamParticipant</participant>
                        <x>76.913086</x>
                        <y>882.86017</y>
                        <methodList>
                          <method name="cwOnProcActAfter" type="action">
                            <category>script</category>
                            <system>true</system>
                            <script><![CDATA[
                              debugPrintln(workflow.getLogHeaderForProcess(this.process.id) + "Task " + this.process.processOrderItem.taskName + " accepted by QualityTeam");

                              this.process.processOrderItem.acceptQualityTeamDate = new Date();
                              this.process.processOrderItem.status = configuration.getExternalNameForStatusByInternalName("QUALITY_ACCEPTED", "TFR_TASK");
                              this.process.processOrderItem.save();
                            ]]></script>
                          </method>
                        </methodList>
                      </child>
                      <child name="rejectTask" type="opActivity">
                        <element>iface_workflow.qualityTeamIF/oper_rejectTask</element>
                        <label>Reject Task</label>
                        <participant>part_workflow.qualityTeamParticipant</participant>
                        <x>178.60645</x>
                        <y>882.86017</y>
                        <childList>
                          <child name="taskRejectedException" type="exceptActivity">
                            <element>excp_workflow.taskRejectedException</element>
                            <label>Task Rejected Exception</label>
                            <x>169.26367</x>
                            <y>1009.26245</y>
                          </child>
                        </childList>
                        <methodList>
                          <method name="cwOnProcActAfter" type="action">
                            <category>script</category>
                            <system>true</system>
                            <script><![CDATA[
                              debugPrintln(workflow.getLogHeaderForProcess(this.process.id) + "Task  " + this.process.processOrderItem.taskName + " rejected by Quality Team");

                              this.process.processOrderItem.status = configuration.getExternalNameForStatusByInternalName("REJECTED", "TFR_TASK");
                              this.process.processOrderItem.save();
                            ]]></script>
                          </method>
                        </methodList>
                      </child>
                    </childList>
                  </child>
                </childList>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[
                      workflow.overload_computeNextUser(this.process.processOrder.id, this.process.processOrderItem.id, this.process.id, "taskManagementProcess", "acceptingTask_Quality");
                    ]]></script>
                  </method>
                </methodList>
              </child>
            </childList>
          </child>
        </childList>
      </child>
      <child name="completeTask" type="seqActivity">
        <label>Complete Task</label>
        <x>66.98555</x>
        <y>1026.3142</y>
        <childList>
          <child name="completeTask" type="scriptActivity">
            <label>Complete Task</label>
            <x>69.58496</x>
            <y>1150.0671</y>
            <methodList>
              <method name="cwOnProcActBefore" type="action">
                <category>before</category>
                <system>true</system>
                <script><![CDATA[
                  debugPrintln(workflow.getLogHeaderForProcess(this.process.id) + "Task " + this.process.processOrderItem.taskName + " accepted by both the teams");

                  this.process.processOrderItem.acceptDate = new Date();
                  this.process.processOrderItem.status = configuration.getExternalNameForStatusByInternalName("ACCEPTED", "TFR_TASK");
                  this.process.processOrderItem.save();


                  var finder = new Finder("workflow.usersForOrderFinder");
                  finder.searchDocument.orderId = this.process.processOrderId;
                  finder.searchDocument.orderItemId = this.process.processOrderItemId;
                  var recordsFound = finder.search();

                  if(recordsFound != null && recordsFound.length > 0) {
                      var currentSiteUser = recordsFound[0].userId_Site;
                      workflow.setUserInUsersForOrder(this.process.processOrderId, "0", "Site", currentSiteUser);

                      var currentQualityUser = recordsFound[0].userId_Quality;
                      workflow.setUserInUsersForOrder(this.process.processOrderId, "0", "Quality", currentQualityUser);

                      recordsFound[0].deleteItem();
                  }
                ]]></script>
              </method>
            </methodList>
          </child>
          <child name="wakeUpParent" type="scriptActivity">
            <label>WakeUp Parent</label>
            <x>72.256836</x>
            <y>1276.1707</y>
            <methodList>
              <method name="cwOnProcActBefore" type="action">
                <category>before</category>
                <system>true</system>
                <script><![CDATA[
                  debugPrintln(workflow.getLogHeaderForProcess(this.process.id) + "SendWakeUp; parentProcessId " + this.process.processOrderItem.parentProcessId);

                  Process.sendSignal("workflow:wakeUpParentForTaskProcess", this.process.processOrderItem.parentProcessId);
                ]]></script>
              </method>
            </methodList>
          </child>
        </childList>
      </child>
      <child name="end" type="completeActivity">
        <label>End</label>
        <x>79.26367</x>
        <y>1387.573</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[debugPrintln(workflow.getLogHeaderForProcess(this.process.id) + "End");]]></script>
          </method>
        </methodList>
      </child>
      <child name="taskRejectionException" type="onExceptionActivity">
        <element>excp_workflow.taskRejectedException</element>
        <label>Task Rejection Exception</label>
        <x>229.0</x>
        <y>130.0</y>
        <childList>
          <child name="startTaskRejectionExceptionMgmt" type="seqActivity">
            <label>Start Task Rejection Exception Mgmt</label>
            <x>130.16225</x>
            <y>122.0</y>
            <childList>
              <child name="rollbackTaskRejection" type="rollbackActivity">
                <label>Rollback Task Rejection</label>
                <x>135.56186</x>
                <y>222.64142</y>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[
                      debugPrintln(workflow.getLogHeaderForProcess(this.process.id) + "Executing Rollback for Task Rejection");
                      return "1";
                    ]]></script>
                  </method>
                </methodList>
              </child>
              <child name="resumeTaskRejection" type="resumeActivity">
                <label>Resume Task Rejection</label>
                <x>135.56186</x>
                <y>348.74493</y>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[
                      debugPrintln(workflow.getLogHeaderForProcess(this.process.id) + "Executing Resume for Task Rejection");
                    ]]></script>
                  </method>
                </methodList>
              </child>
            </childList>
          </child>
        </childList>
      </child>
      <child name="siteTeamParticipant" type="participantActivity">
        <label>Site Team Participant</label>
        <participant>part_workflow.siteTeamParticipant</participant>
        <x>406.73047</x>
        <y>749.10724</y>
      </child>
      <child name="qualityTeamParticipant" type="participantActivity">
        <label>Quality Team Participant</label>
        <participant>part_workflow.qualityTeamParticipant</participant>
        <x>135.36523</x>
        <y>741.75665</y>
      </child>
    </childList>
    <methodList>
      <method name="cwOnProcActBefore" type="action">
        <category>before</category>
        <system>true</system>
        <script><![CDATA[
          debugPrintln(workflow.getLogHeaderForProcess(this.process.id) + "Started Task Management process for task with id " + this.process.processOrderItem.id);
        ]]></script>
      </method>
    </methodList>
  </activity>
  <curRevision>true</curRevision>
  <label>Task Management Process</label>
  <metaVersion>22</metaVersion>
  <priority>8</priority>
  <type>User</type>
</process>