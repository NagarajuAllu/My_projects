<?xml version="1.0" encoding="UTF-8" ?>
<process name="workflow.rehomingOrderProcess">
  <activity name="startRehomingProcess" type="seqActivity">
    <label>Start Rehoming process</label>
    <x>79.01503</x>
    <y>30.0</y>
    <childList>
      <child name="startDisconnectAndInstallInparalell" type="allActivity">
        <label>Start Disconnect and Install in paralell</label>
        <x>77.149414</x>
        <y>124.760925</y>
        <childList>
          <child name="startDisconnectProcessActivities" type="seqActivity">
            <label>Start Disconnect process activities</label>
            <x>133.49982</x>
            <y>281.9615</y>
            <childList>
              <child name="perepareAndStartDisconnect" type="scriptActivity">
                <label>Perepare and start Disconnect process</label>
                <x>153.36523</x>
                <y>380.66266</y>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[
                      debugPrintln("Starting Disconnect order process for Rehoming...");

                      /****
                      var sem = theAVM.getSemaphore("TFRNumberLock");
                      if(!sem){
                       sem = theAVM.setSemaphore("TFRNumberLock",0);
                      }
                      while( sem > 0){
                        sem = theAVM.getSemaphore("TFRNumberLock");
                      }
                      theAVM.setSemaphore("TFRNumberLock",0,1);
                      ***/

                      var disconnectOrder = new Order("tfs.tfsOrder");
                      var tfrToDisconnect = this.process.processOrder.tfrDocument;
                      debugPrintln("TFR to disconnect:"+tfrToDisconnect.tfrId);

                      tfrToDisconnect.mapTo(disconnectOrder, "tfs.mapTFRtoDisconnectTFROrder"); // map current TFR to disconnect tfsOrder
                      disconnectOrder.tfrDocument.disconnectedTFRId = tfrToDisconnect.tfrId;
                      disconnectOrder.tfrDocument.tfrStatus = configuration.getExternalNameForStatusByInternalName("SUBMIT", "TFR");
                      disconnectOrder.tfrDocument.creationDate = new Date();
                      disconnectOrder.tfrDocument.tfrYear = Calendar.formatDate(disconnectOrder.tfrDocument.creationDate, "yyyy");
                      disconnectOrder.tfrDocument.tfrMonth = Calendar.formatDate(disconnectOrder.tfrDocument.creationDate, "MM");
                      disconnectOrder.tfrDocument.existing = tfrToDisconnect.existing + tfrToDisconnect.required; // for Total Disconnect process existing=total, total computes as existing + required
                      disconnectOrder.tfrDocument.generateTFRNumber();
                      disconnectOrder.tfrDocument.save();

                      // Get user of TFR to be reconnected to assign tasks from Reconnect process to him
                      var initiator = this.process.processOrder.tfrDocument.currentUserId;
                      debugPrintln("Disconnect initiator:"+initiator);
                      workflow.setUserInUsersForOrder(disconnectOrder.id, "0", "OrderInitiator", initiator ); // set current user for disconnect process
                      disconnectOrder.tfrDocument.createdBy = initiator; // set created by
                      disconnectOrder.tfrDocument.parentProcId = this.process.id; // need to difine if Disconnect has been started from Rehome
                      disconnectOrder.save();

                      // theAVM.setSemaphore("TFRNumberLock",1,0);

                      var disconnectProcessId = Process.startProcess("workflow.disconnectOrderProcess", disconnectOrder.id);
                      this.process.processDocument.disconnectOrderId = disconnectOrder.id; // need to stop processes in case of need

                      debugPrintln("Disconnect Order process  started. Process Id:" + disconnectProcessId);
                    ]]></script>
                  </method>
                </methodList>
              </child>
              <child name="waitForDisconnectCompleted" type="syncActivity">
                <element>signal_workflow.tfrDisconnected</element>
                <label>Wait for Disconnect completed</label>
                <x>138.36523</x>
                <y>509.46735</y>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActBefore" type="action">
                <category>before</category>
                <system>true</system>
                <script><![CDATA[debugPrintln("Start Disconnect process activities...");]]></script>
              </method>
            </methodList>
          </child>
          <child name="startInstallProcessActivities" type="seqActivity">
            <label>Start Install(Reconnect) process activities</label>
            <x>20.999023</x>
            <y>272.02124</y>
            <childList>
              <child name="prepareAndStartInstallProcess" type="scriptActivity">
                <label>Prepare and start Install(Reconnect) process</label>
                <x>7.3359375</x>
                <y>384.66266</y>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[
                      debugPrintln("Starting reconnect process...");

                      var reconnectTFR = this.process.processOrder.tfrDocument; // tfr document to be reconnected
                      debugPrintln("TFR to be reconnected:"+reconnectTFR);

                      var reconnectOrder = new Order("tfs.tfsOrder");
                      var reconnectPRNRDocument = new Document("tfs.prnr");

                      if( this.process.processOrder.prnrDocument ){ // if prnr document exists
                          // Initialize PRNR to start Reconnect(Install) process
                          debugPrintln("Reconnect: PRNR for order:"+this.process.processOrder.id+" found.\n PRNR to be cloned for reconnect:"+this.process.processOrder.prnrDocument.prnrId);
                          reconnectPRNRDocument = this.process.processOrder.prnrDocument.copyDocument(false, false); // copy previous instance to the current one
                      }
                      else{
                          debugPrintln("Reconnect: PRNR for order:"+this.process.processOrder.id+" not found.\n Starting from new PRNR...");
                      }

                      reconnectPRNRDocument.connectionTFRId = reconnectTFR.id;
                      reconnectPRNRDocument.prnrName = common.getNextSequenceValue("STC_PRNR_NAME_SEQ", "ORDER");
                      //reconnectPRNRDocument.createdBy = this.process.processOrder.prnrDocument.createdBy;
                      reconnectPRNRDocument.creationDate = new Date();
                      reconnectPRNRDocument.prnrYear = Calendar.formatDate(reconnectPRNRDocument.creationDate, "yyyy");
                      reconnectPRNRDocument.prnrMonth = Calendar.formatDate(reconnectPRNRDocument.creationDate, "MM");
                      reconnectPRNRDocument.plannedRFSDate = null;
                      reconnectPRNRDocument.releasedDate = null;
                      reconnectPRNRDocument.prnrStatus = configuration.getExternalNameForStatusByInternalName("NEW", "PRNR");
                      reconnectPRNRDocument.parentProcId = this.process.id; // used to wake up Rehome process after Reconnect(Install) completion
                      reconnectOrder.prnrDocument = reconnectPRNRDocument.copyDocument(true, false);

                      debugPrintln("Reconnect: PRNR to be started with:"+reconnectPRNRDocument);
                      reconnectOrder.save();

                      debugPrintln("Reconnect: Order id:"+reconnectOrder.id);
                      debugPrintln("Reconnect: Order prnr document:"+reconnectOrder.prnrDocument.prnrId);

                      // get user of reconnect TFR to assign task from Reconnect process to him
                      var initiator = this.process.processOrder.tfrDocument.currentUserId;//workflow.getUserForOrder(reconnectTFR.cwOrderId, "0", "OrderInitiator");
                      debugPrintln("Reconnect initiator:"+initiator);
                      workflow.setUserInUsersForOrder(reconnectOrder.id, "0", "OrderInitiator", initiator ); // set user for Reconnect order
                      var reconnectProcessId = Process.startProcess("workflow.installOrderProcess", reconnectOrder.id);

                      this.process.processDocument.reconnectOrderId = reconnectOrder.id; // need to stop processes in case of need

                      debugPrintln("Reconnect Order process started. Process id:"+reconnectProcessId);
                    ]]></script>
                  </method>
                </methodList>
              </child>
              <child name="waitForInstallCompleted" type="syncActivity">
                <element>signal_workflow.wakeUpParent</element>
                <label>Wait for Install completed</label>
                <x>31.0</x>
                <y>517.46735</y>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActBefore" type="action">
                <category>before</category>
                <system>true</system>
                <script><![CDATA[debugPrintln("Start Install(Reconnect) process activities...");]]></script>
              </method>
            </methodList>
          </child>
        </childList>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[debugPrintln("Starting in parallel Reconnect and Disconnect procesess...");]]></script>
          </method>
        </methodList>
      </child>
      <child name="branchesCompleted" type="scriptActivity">
        <label>Branches completed</label>
        <x>77.68164</x>
        <y>646.57086</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              debugPrintln("Reconnect and Disconnect processes for TFR:" + this.process.processOrder.tfrDocument.tfrId + " are completed.");
              //workflow.setUserInUsersForOrder(this.process.processOrder.id, "0", "OrderInitiator", this.process.processOrder.tfrDocument.currentUserId );
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="startReportReviewActivities" type="seqActivity">
        <label>Start report review activities</label>
        <x>68.15097</x>
        <y>737.97327</y>
        <childList>
          <child name="startRehomeCompletionProcess" type="scriptActivity">
            <label>Start Rehome Completion Process</label>
            <x>252.151</x>
            <y>722.97327</y>
            <methodList>
              <method name="cwOnProcActBefore" type="action">
                <category>before</category>
                <system>true</system>
                <script><![CDATA[
                  // get user of Rehomed TFR to assign task from Reconnect Completion process to him
                  var initiator = this.process.processOrder.tfrDocument.currentUserId;
                  debugPrintln("Reconnect Completion initiator:"+initiator);
                  workflow.setUserInUsersForOrder(this.process.processDocument.reconnectOrderId, "0", "OrderInitiator", initiator ); // set user for Reconnect order
                  var procId = Process.startProcess("workflow.rehomingOrderCompletionProcess", this.process.processDocument.reconnectOrderId);
                  debugPrintln("Reconnect completion process started:"+procId);
                ]]></script>
              </method>
            </methodList>
          </child>
          <child name="waitRehomeCompletionFinished" type="syncActivity">
            <element>signal_workflow.wakeUpParent</element>
            <label>Rehome Completion Finished</label>
            <x>405.151</x>
            <y>734.97327</y>
            <methodList>
              <method name="cwOnProcActAfter" type="action">
                <category>script</category>
                <system>true</system>
                <script><![CDATA[
                  // resetting users at the end of the workflow
                  this.process.processOrder.tfrDocument.currentUserId = null;
                  this.process.processOrder.tfrDocument.currentUserDepartment = null;
                  this.process.processOrder.save();
                ]]></script>
              </method>
            </methodList>
          </child>
        </childList>
      </child>
      <child name="end" type="completeActivity">
        <label>End</label>
        <x>594.36426</x>
        <y>748.64233</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[debugPrintln(" Rehoming Process completed.");]]></script>
          </method>
        </methodList>
      </child>
      <child name="stopForRehoming" type="onExceptionActivity">
        <element>excp_cwf.stop</element>
        <label>Stop For Rehoming</label>
        <x>79.01503</x>
        <y>130.0</y>
        <childList>
          <child name="startManagingStop" type="seqActivity">
            <label>Start Managing Stop</label>
            <x>338.015</x>
            <y>30.0</y>
            <childList>
              <child name="stopDisconnectProcesses" type="scriptActivity">
                <label>Stop Reconnect And Disconnect Processes</label>
                <x>337.015</x>
                <y>133.0</y>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[
                      debugPrintln(workflow.getLogHeaderForProcess(this.process.id) + " Terminating Disconnect process...");

                      // Rehome process can be stopped from Reconnect process in case of it's cancel
                      // After Reconnect is canceled it is also required to stop Rehome and Disconnect processes

                      // received stop signal from Reconnect process
                      // terminate Disconnect process
                      workflow.terminateProcessByOrderId(this.process.processDocument.disconnectOrderId, "workflow.disconnectOrderProcess");
                      debugPrintln(workflow.getLogHeaderForProcess(this.process.id) + " Disconnect processes terminated.");

                      // resetting users at the end of the workflow
                      this.process.processOrder.tfrDocument.currentUserId = null;
                      this.process.processOrder.tfrDocument.currentUserDepartment = null;
                      this.process.processOrder.save();
                    ]]></script>
                  </method>
                </methodList>
              </child>
              <child name="end" type="completeActivity">
                <label>End</label>
                <x>503.015</x>
                <y>174.0</y>
                <methodList>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[debugPrintln(workflow.getLogHeaderForProcess(this.process.id) + " Rehoming Process stoped.");]]></script>
                  </method>
                </methodList>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActBefore" type="action">
                <category>before</category>
                <system>true</system>
                <script><![CDATA[
                  debugPrintln(workflow.getLogHeaderForProcess(this.process.id) + " Cancel Reconnect requested. Stopping Disconnect Order process.");
                ]]></script>
              </method>
            </methodList>
          </child>
        </childList>
      </child>
    </childList>
    <methodList>
      <method name="cwOnProcActBefore" type="action">
        <category>before</category>
        <system>true</system>
        <script><![CDATA[debugPrintln("Started Rehoming process...");]]></script>
      </method>
    </methodList>
  </activity>
  <curRevision>true</curRevision>
  <document>doc_workflow.rehomingProcessDocument</document>
  <label>Rehoming Order Process</label>
  <metaVersion>25</metaVersion>
  <priority>8</priority>
  <type>User</type>
</process>