<?xml version="1.0" encoding="UTF-8" ?>
<script name="tfs.isTFRDisconnected">
  <description><![CDATA[
    Search TFR with disconnected TFR id and checks it's status. Returns true if TFR is successfully disconnected, false - if not.
  ]]></description>
  <label>Is TFR is successfully disconnected</label>
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="tfrId" type="rifp">
      <mandatory>true</mandatory>
      <type>dtype_cwf.docId</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    /*
     * Script checks if TFR is disconnected successfully.
     * How to define: statuses for all found Disconnect TFR has to be "COMPLETED"
     * If disconnect TFR has different status from "Completed" it means that either it was cancelled or it is still in processing
     */

    debugPrintln("isTFRDisconnected()");
    debugPrintln("TFR to check:"+tfrId);

    var COMPLETED_STATUS = configuration.getExternalNameForStatusByInternalName("COMPLETED", "TFR");

    // verify that there are TFRs in which the attribute “DISCONNECTED TFR” is set with the id of the current TFR
    var discFinder = new Finder("tfs.findTFRWithDisconnectedTFRIdByTFRId");
    discFinder.searchDocument.tfrId = tfrId;
    var resultList = discFinder.search();

    // if there are such TFRs
    // these should have internal status = “CANCELLED” in case Disconnect process was cancelled
    // Assumed, that this check also verifies that there is no runninng Disconnect processes for this TFR
    // In case it is runnning, the status will be different from CANCELLED which means that process is still executing

    if( resultList.length ){ // if there is already disconnected TFRs
        debugPrintln( "Found " + resultList.length + " already disconnected TFR's. Check internal statuses..." );
        for( var i=0; i < resultList.length; i++ ){ // check internal statuses
            var currentTFR = resultList[i];
            debugPrintln("TFR status:"+currentTFR.tfrStatus);
            if( currentTFR.tfrStatus != COMPLETED_STATUS ){ // if found TFR is not in completed status
                debugPrintln("Found TFR with disconnected_tfr_id="+currentTFR.disconnectedTFRId+" and status="+currentTFR.tfrStatus+". TFR is Cancelled or Disconnect is running for such TFR.");
                //return false; // assume that disconnect was not performed successfully or is still performing
            }
            else{ // if at least one disconnect TFR is completed, assume that tfr was rehomed
                return true;
            }
        }
        //return false; // if there is no successfully disconnected TFRs
    }

    return false; // if there is no successfully disconnected TFR for this tfr
  ]]></script>
</script>