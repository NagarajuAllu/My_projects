<?xml version="1.0" encoding="UTF-8" ?>
<order name="tfs.tfsOrder">
  <attachments>true</attachments>
  <extends>order_com.conceptwave.system.Order</extends>
  <label>TFS Order</label>
  <metaVersion>21</metaVersion>
  <childList>
    <child name="prnrDocument" type="order">
      <label>PRNR Document</label>
      <orderItem>doc_tfs.prnr</orderItem>
      <orderType>document</orderType>
      <UserInterface name="UserInterface" type="tree">
        <autoExpand>true</autoExpand>
        <defaultFolderImage>undefined</defaultFolderImage>
        <defaultLeafImage>undefined</defaultLeafImage>
        <element>order_tfs.tfsOrder/order_prnrDocument</element>
        <extends>tree_com.conceptwave.system.OrderUserInterface</extends>
        <variableList>
          <variable name="model" type="uivar">
            <label>model</label>
            <valueType>order_tfs.tfsOrder/order_prnrDocument</valueType>
          </variable>
        </variableList>
        <vformList>
          <vform name="Forms" type="frmui">
            <extends>tree_com.conceptwave.system.OrderUserInterface/frmui_Forms</extends>
          </vform>
        </vformList>
      </UserInterface>
    </child>
    <child name="prnDocument" type="order">
      <label>PRN Document</label>
      <orderItem>doc_tfs.prn</orderItem>
      <orderType>document</orderType>
      <UserInterface name="UserInterface" type="tree">
        <autoExpand>true</autoExpand>
        <defaultFolderImage>undefined</defaultFolderImage>
        <defaultLeafImage>undefined</defaultLeafImage>
        <element>order_tfs.tfsOrder/order_prnDocument</element>
        <extends>tree_com.conceptwave.system.OrderUserInterface</extends>
        <variableList>
          <variable name="model" type="uivar">
            <label>model</label>
            <valueType>order_tfs.tfsOrder/order_prnDocument</valueType>
          </variable>
        </variableList>
        <vformList>
          <vform name="Forms" type="frmui">
            <extends>tree_com.conceptwave.system.OrderUserInterface/frmui_Forms</extends>
          </vform>
        </vformList>
      </UserInterface>
    </child>
    <child name="tfrDocument" type="order">
      <label>TFR Document</label>
      <orderItem>doc_tfs.tfr</orderItem>
      <orderType>document</orderType>
      <UserInterface name="UserInterface" type="tree">
        <autoExpand>true</autoExpand>
        <defaultFolderImage>undefined</defaultFolderImage>
        <defaultLeafImage>undefined</defaultLeafImage>
        <element>order_tfs.tfsOrder/order_tfrDocument</element>
        <extends>tree_com.conceptwave.system.OrderUserInterface</extends>
        <variableList>
          <variable name="model" type="uivar">
            <label>model</label>
            <valueType>order_tfs.tfsOrder/order_tfrDocument</valueType>
          </variable>
        </variableList>
        <vformList>
          <vform name="Forms" type="frmui">
            <extends>tree_com.conceptwave.system.OrderUserInterface/frmui_Forms</extends>
          </vform>
        </vformList>
      </UserInterface>
    </child>
    <child name="tasks" type="order">
      <label>Tasks</label>
      <maxInstances>999</maxInstances>
      <orderType>collection</orderType>
      <childList>
        <child name="tfrTask" type="order">
          <label>TFR Task</label>
          <mandatory>true</mandatory>
          <orderItem>doc_tfs.STC_TFR_TASK</orderItem>
          <orderType>document</orderType>
        </child>
      </childList>
    </child>
  </childList>
  <UserInterface name="UserInterface" type="tree">
    <autoExpand>true</autoExpand>
    <defaultFolderImage>undefined</defaultFolderImage>
    <defaultLeafImage>undefined</defaultLeafImage>
    <element>order_tfs.tfsOrder</element>
    <extends>tree_com.conceptwave.system.OrderUserInterface</extends>
    <tableDoc>doc_com.conceptwave.system.TreeDocument</tableDoc>
    <childList>
      <child name="prnrDocument" type="tnOi">
        <autoExpand>true</autoExpand>
        <autoSave>true</autoSave>
        <detailForm>doc_tfs.prnr/ui_UserInterface/frmui_Forms/exov_Default</detailForm>
        <detailUI>doc_tfs.prnr/ui_UserInterface</detailUI>
        <element>doc_tfs.prnr</element>
        <extends>tn_com.conceptwave.system.TreeNode</extends>
        <label>PRNR Document</label>
        <nodeType>4</nodeType>
        <orderItem>order_tfs.tfsOrder/order_prnrDocument</orderItem>
        <vformList>
          <vform name="Forms" type="frmui">
            <extends>tn_com.conceptwave.system.TreeNode/frmui_Forms</extends>
          </vform>
        </vformList>
        <methodList>
          <method name="editablePerm" type="permMethod">
            <privilegesList>
              <privileges type="ppriv">
                <privilege>STC_IOrdInitPriv</privilege>
              </privileges>
            </privilegesList>
            <privilegesType>SOME</privilegesType>
            <script><![CDATA[return (this.model.currentUserId == Global.getUserId() && $psCondition);]]></script>
          </method>
          <method name="visiblePerm" type="permMethod">
            <script><![CDATA[
              this.cw$super_visiblePerm($psCondition);
              var statusCancelled = configuration.getExternalNameForStatusByInternalName("CANCELLED", "PRN");
              if(this.order.prnDocument != null && this.order.prnDocument.prnStatus == statusCancelled){
                  return true;
              }
              return (this.order.prnDocument == null);
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="prnDocument" type="tnOi">
        <autoExpand>true</autoExpand>
        <autoSave>true</autoSave>
        <detailForm>doc_tfs.prn/ui_UserInterface/frmui_Forms/exov_Default</detailForm>
        <detailUI>doc_tfs.prn/ui_UserInterface</detailUI>
        <element>doc_tfs.prn</element>
        <extends>tn_com.conceptwave.system.TreeNode</extends>
        <label>PRN Document</label>
        <nodeType>4</nodeType>
        <orderItem>order_tfs.tfsOrder/order_prnDocument</orderItem>
        <vformList>
          <vform name="Forms" type="frmui">
            <extends>tn_com.conceptwave.system.TreeNode/frmui_Forms</extends>
          </vform>
        </vformList>
        <methodList>
          <method name="editablePerm" type="permMethod">
            <privilegesList>
              <privileges type="ppriv">
                <privilege>STC_NetwDesPriv</privilege>
              </privileges>
            </privilegesList>
            <privilegesType>SOME</privilegesType>
            <script><![CDATA[return (this.model.currentUserId == Global.getUserId() && $psCondition);]]></script>
          </method>
          <method name="visiblePerm" type="permMethod">
            <privilegesList>
              <privileges type="ppriv">
                <privilege>STC_BIPriv</privilege>
              </privileges>
              <privileges type="ppriv">
                <privilege>STC_NetwDesPriv</privilege>
              </privileges>
              <privileges type="ppriv">
                <noOtherTasks>true</noOtherTasks>
                <participantsList>
                  <participants type="ppart">
                    <operationsList>
                      <operations>iface_workflow.facilityDesignTeamIF/oper_cancellationReservationInGranite</operations>
                    </operationsList>
                    <participant>part_workflow.facilityDesignTeamParticipant</participant>
                  </participants>
                </participantsList>
                <privilege>STC_FacilityDes</privilege>
                <task>true</task>
              </privileges>
            </privilegesList>
            <privilegesType>SOME</privilegesType>
            <script><![CDATA[
              this.cw$super_visiblePerm($psCondition);

              var visible = $psCondition;
              if(visible) {
                  // checking if the user belong to BI Team; if yes and there is the TFR document, the PRN has not to be visible.
                  var isBIUser = UserProfile.hasPrivilege("STC_BIPriv");
                  if(isBIUser) {
                      var biAssociationProcesses = workflow.findRunningProcessesByType(this.model.order.id, "workflow.biAssociationProcess");
                      if(biAssociationProcesses != null && biAssociationProcesses.length > 0) {
                          var currentBIAssociationProcess = Process.getProcessInfo(biAssociationProcesses[0]);
                          var orderItemId = currentBIAssociationProcess.processOrderItemId;


                          visible = (this.model.id == currentBIAssociationProcess.processOrderItemId);
                      }
                      else {
                          debugPrintln("biAssociationProcesses = null");
                          if(this.model.order.tfrDocument != null) {
                              visible = false;
                          }
                      }
                  }
              }

              return (visible);
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="tfrDocument" type="tnOi">
        <autoExpand>true</autoExpand>
        <autoSave>true</autoSave>
        <detailForm>doc_tfs.tfr/ui_UserInterface/frmui_Forms/exov_Default</detailForm>
        <detailUI>doc_tfs.tfr/ui_UserInterface</detailUI>
        <element>doc_tfs.tfr</element>
        <extends>tn_com.conceptwave.system.TreeNode</extends>
        <label>TFR Document</label>
        <nodeType>4</nodeType>
        <orderItem>order_tfs.tfsOrder/order_tfrDocument</orderItem>
        <variableList>
          <variable name="model" type="uivar">
            <valueType>doc_tfs.tfr</valueType>
          </variable>
        </variableList>
        <vformList>
          <vform name="Forms" type="frmui">
            <extends>tn_com.conceptwave.system.TreeNode/frmui_Forms</extends>
          </vform>
        </vformList>
        <methodList>
          <method name="editablePerm" type="permMethod">
            <privilegesList>
              <privileges type="ppriv">
                <privilege>STC_IOrdInitPriv</privilege>
              </privileges>
            </privilegesList>
            <privilegesType>SOME</privilegesType>
            <script><![CDATA[return (this.model.currentUserId == Global.getUserId() && $psCondition);]]></script>
          </method>
          <method name="visiblePerm" type="permMethod">
            <privilegesList>
              <privileges type="ppriv">
                <privilege>STC_NetwDesPriv</privilege>
              </privileges>
              <privileges type="ppriv">
                <noOtherTasks>true</noOtherTasks>
                <participantsList>
                  <participants type="ppart">
                    <operationsList>
                      <operations>iface_workflow.facilityDesignTeamIF/oper_cancellationReservationInGranite</operations>
                    </operationsList>
                    <participant>part_workflow.facilityDesignTeamParticipant</participant>
                  </participants>
                </participantsList>
                <privilege>STC_FacilityDes</privilege>
                <task>true</task>
              </privileges>
            </privilegesList>
            <privilegesType>SOME</privilegesType>
            <script><![CDATA[
              this.cw$super_visiblePerm($psCondition);

              var visible = !$psCondition;
              if(visible) {
                  // checking if the user belong to BI Team; if yes and there is the TFR document, the PRN has not to be visible.
                  var isBIUser = UserProfile.hasPrivilege("STC_BIPriv");
                  if(isBIUser) {
                      var biAssociationProcesses = workflow.findRunningProcessesByType(this.model.order.id, "workflow.biAssociationProcess");
                      if(biAssociationProcesses != null && biAssociationProcesses.length > 0) {
                          var currentBIAssociationProcess = Process.getProcessInfo(biAssociationProcesses[0]);
                          var orderItemId = currentBIAssociationProcess.processOrderItemId;

                          visible = (this.model.id == currentBIAssociationProcess.processOrderItemId);
                      }
                      else {
                          if(this.model.order.tfrDocument != null) {
                              visible = false;
                          }
                      }
                  }
              }

              return (visible);
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="tasks" type="tnOi">
        <autoExpand>true</autoExpand>
        <autoSave>true</autoSave>
        <element>order_tfs.tfsOrder/order_tasks</element>
        <extends>tn_com.conceptwave.system.TreeNode</extends>
        <hideExpandIcon>true</hideExpandIcon>
        <hideWhenEmpty>true</hideWhenEmpty>
        <label>Tasks</label>
        <nodeType>4</nodeType>
        <orderItem>order_tfs.tfsOrder/order_tasks</orderItem>
        <showChildrenCount>true</showChildrenCount>
        <childList>
          <child name="tasksInstance" type="tnOi">
            <autoExpand>true</autoExpand>
            <autoSave>true</autoSave>
            <collectionInstance>true</collectionInstance>
            <element>order_tfs.tfsOrder/order_tasks</element>
            <extends>tn_com.conceptwave.system.TreeNode</extends>
            <hideExpandIcon>true</hideExpandIcon>
            <hideWhenEmpty>true</hideWhenEmpty>
            <label>Task</label>
            <nodeType>4</nodeType>
            <orderItem>order_tfs.tfsOrder/order_tasks</orderItem>
            <childList>
              <child name="task" type="tnOi">
                <autoExpand>true</autoExpand>
                <autoSave>true</autoSave>
                <detailForm>doc_tfs.STC_TFR_TASK/ui_UserInterface/frmui_Forms/exov_Default</detailForm>
                <detailUI>doc_tfs.STC_TFR_TASK/ui_UserInterface</detailUI>
                <element>doc_tfs.STC_TFR_TASK</element>
                <extends>tn_com.conceptwave.system.TreeNode</extends>
                <label>Task</label>
                <nodeType>4</nodeType>
                <orderItem>order_tfs.tfsOrder/order_tasks/order_tfrTask</orderItem>
                <vformList>
                  <vform name="Forms" type="frmui">
                    <extends>tn_com.conceptwave.system.TreeNode/frmui_Forms</extends>
                  </vform>
                </vformList>
              </child>
            </childList>
            <vformList>
              <vform name="Forms" type="frmui">
                <extends>tn_com.conceptwave.system.TreeNode/frmui_Forms</extends>
              </vform>
            </vformList>
          </child>
        </childList>
        <vformList>
          <vform name="Forms" type="frmui">
            <extends>tn_com.conceptwave.system.TreeNode/frmui_Forms</extends>
          </vform>
        </vformList>
      </child>
    </childList>
    <variableList>
      <variable name="model" type="uivar">
        <label>model</label>
        <valueType>order_tfs.tfsOrder</valueType>
      </variable>
    </variableList>
    <vformList>
      <vform name="Forms" type="frmui">
        <extends>tree_com.conceptwave.system.OrderUserInterface/frmui_Forms</extends>
        <overlayList>
          <overlay name="Menu" type="exov">
            <base>tree_com.conceptwave.system.OrderUserInterface/frmui_Forms/exov_Menu</base>
            <extends>tree_com.conceptwave.system.OrderUserInterface/frmui_Forms/exov_Menu</extends>
            <label>Menu</label>
            <overrideList>
              <override name="cwfAdd" type="elmnu">
                <clickMethod type="varPath">
                  <variablePathList>
                    <variablePath>tree_com.conceptwave.system.OrderUserInterface/usrActionMethod_addAction</variablePath>
                  </variablePathList>
                </clickMethod>
                <icon>/cwf/MenuIconAdd.gif</icon>
                <label>Add Task</label>
                <visible type="varPath">
                  <variablePathList>
                    <variablePath>tree_com.conceptwave.system.OrderUserInterface/permMethod_addVisible</variablePath>
                  </variablePathList>
                </visible>
              </override>
              <override name="cwfCopy" type="eldel"/>
              <override name="cwfDelete" type="eldel"/>
              <override name="HorizontalLayout" type="elext">
                <elementList>
                  <element name="nextUserManagementMenuItem" type="elmnu">
                    <clickMethod type="varPath">
                      <variablePathList>
                        <variablePath>order_tfs.tfsOrder/tree_UserInterface/usrActionMethod_nextUserAssignment</variablePath>
                      </variablePathList>
                    </clickMethod>
                    <label>Set Next Users</label>
                    <visible type="varPath">
                      <variablePathList>
                        <variablePath>order_tfs.tfsOrder/tree_UserInterface/permMethod_nextUserActionPermission</variablePath>
                      </variablePathList>
                    </visible>
                  </element>
                </elementList>
              </override>
              <override name="Order" type="elext">
                <elementList>
                  <element name="Separator" type="elsep"/>
                  <element name="trackingMenuItem" type="elmnu">
                    <clickMethod type="varPath">
                      <variablePathList>
                        <variablePath>order_tfs.tfsOrder/tree_UserInterface/usrActionMethod_showTracking</variablePath>
                      </variablePathList>
                    </clickMethod>
                    <icon>/cwf/element_find.png</icon>
                    <label>Show Order Tracking</label>
                  </element>
                  <element name="remarksMenuItem" type="elmnu">
                    <clickMethod type="varPath">
                      <variablePathList>
                        <variablePath>order_tfs.tfsOrder/tree_UserInterface/usrActionMethod_showRemarks</variablePath>
                      </variablePathList>
                    </clickMethod>
                    <icon>/cwf/data.gif</icon>
                    <label>Show Order Remarks</label>
                  </element>
                </elementList>
              </override>
              <override name="TaskHistory" type="eldel"/>
              <override name="Tasks" type="eldel"/>
            </overrideList>
          </overlay>
        </overlayList>
      </vform>
    </vformList>
    <methodList>
      <method name="attachAction" type="usrActionMethod">
        <dialogForm>ReferenceForm</dialogForm>
        <showInPopup>true</showInPopup>
        <script><![CDATA[
          //this.cw$super_attachAction();

          var attachmentFinder = new Finder("common.tfsAttachmentFinder");
          var finderUI = new attachmentFinder.UserInterface(attachmentFinder, this);
          finderUI.ownerItem = this.model;
          finderUI.initSearchDoc();
          finderUI.searchAction();
          return finderUI;
        ]]></script>
      </method>
      <method name="nextUserAssignment" type="usrActionMethod">
        <dialogHeight>500</dialogHeight>
        <dialogWidth>1024</dialogWidth>
        <showInPopup>true</showInPopup>
        <script><![CDATA[
          var users4OrderFinder = new Finder("workflow.usersForOrderFinder");
          users4OrderFinder.searchDocument.orderId = this.model.id;
          var recordsFound = users4OrderFinder.search();

          if(recordsFound != null && recordsFound.length > 0) {
              return recordsFound[0];
          }

          Global.throwException("AE0013", this.model.id);
        ]]></script>
      </method>
      <method name="nextUserActionPermission" type="permMethod">
        <privilegesList>
          <privileges type="ppriv">
            <privilege>STC_ASPriv</privilege>
            <task>true</task>
          </privileges>
          <privileges type="ppriv">
            <privilege>STC_ASBuiltPriv</privilege>
            <task>true</task>
          </privileges>
          <privileges type="ppriv">
            <privilege>STC_BBTransPriv</privilege>
            <task>true</task>
          </privileges>
          <privileges type="ppriv">
            <privilege>STC_BIPriv</privilege>
            <task>true</task>
          </privileges>
          <privileges type="ppriv">
            <privilege>STC_FATxPriv</privilege>
            <task>true</task>
          </privileges>
          <privileges type="ppriv">
            <privilege>STC_FacilityDes</privilege>
            <task>true</task>
          </privileges>
          <privileges type="ppriv">
            <privilege>STC_FNIPriv</privilege>
            <task>true</task>
          </privileges>
          <privileges type="ppriv">
            <privilege>STC_IOrdInitPriv</privilege>
            <task>true</task>
          </privileges>
          <privileges type="ppriv">
            <privilege>STC_IntegPriv</privilege>
            <task>true</task>
          </privileges>
          <privileges type="ppriv">
            <privilege>STC_NetwDesPriv</privilege>
            <task>true</task>
          </privileges>
          <privileges type="ppriv">
            <privilege>STC_QualityPriv</privilege>
            <task>true</task>
          </privileges>
          <privileges type="ppriv">
            <privilege>STC_SitePriv</privilege>
            <task>true</task>
          </privileges>
          <privileges type="ppriv">
            <privilege>STC_SwchActvPriv</privilege>
            <task>true</task>
          </privileges>
          <privileges type="ppriv">
            <privilege>STC_TFAModSqPriv</privilege>
            <task>true</task>
          </privileges>
          <privileges type="ppriv">
            <privilege>STC_TFAPriv</privilege>
            <task>true</task>
          </privileges>
          <privileges type="ppriv">
            <privilege>STC_TransMapPriv</privilege>
            <task>true</task>
          </privileges>
          <privileges type="ppriv">
            <privilege>STC_VerificPriv</privilege>
            <task>true</task>
          </privileges>
          <privileges type="ppriv">
            <privilege>STC_XCPriv</privilege>
            <task>true</task>
          </privileges>
        </privilegesList>
        <privilegesType>SOME</privilegesType>
      </method>
      <method name="showTracking" type="usrActionMethod">
        <dialogHeight>600</dialogHeight>
        <dialogWidth>1000</dialogWidth>
        <showInPopup>true</showInPopup>
        <script><![CDATA[
          var trackingFinder = new Finder("workflow.trackingFinder");
          trackingFinder.searchDocument.orderId = this.model.id;
          trackingFinder.search();

          return trackingFinder;
        ]]></script>
      </method>
      <method name="addVisible" type="permMethod">
        <privilegesList>
          <privileges type="ppriv">
            <privilege>STC_XCPriv</privilege>
          </privileges>
        </privilegesList>
        <privilegesType>SOME</privilegesType>
        <script>return $psCondition;</script>
      </method>
      <method name="addAction" type="usrActionMethod">
        <parameterList>
          <parameter name="dialog" type="rifp">
            <mandatory>true</mandatory>
            <type>ui_com.conceptwave.system.Dialog</type>
          </parameter>
        </parameterList>
        <validate>true</validate>
        <script><![CDATA[
          //this.cw$super_addAction(dialog);

          var selNode = this.getSingleSelection();
          if(selNode == null) {
              Global.throwException(Global.translateText("AE0024", null, null));
          }

          var order = Order.getOrderById(this.model.id);

          var selectedNodeOrderDataPath = selNode.model.orderDataPath;
          if(selectedNodeOrderDataPath == null || selectedNodeOrderDataPath != "tasks") {
              // selected root node of the tree
              selNode = getTaskContainerNode_(this);

              if(selNode == null) {
                  var newObject = this.getRoot().childNodes[0].model.addOptional("tasks");
                  if (newObject != null) {
                      selNode = getTaskContainerNode_(this);
                  }
              }
          }

          var addGroup = this.getAddGroup(selNode.model);
          var newItem = addGroup.newInstance();
          if (newItem != null) {
              if (newItem.isSingleDocCollectionInstance && newItem[0] != null) {
                  var tfrTask = newItem[0]; // select first document of the collection instance
                  tfrTask.taskName = "Task Name";
                  tfrTask.tfrId =  order.tfrDocument.tfrId;
                  tfrTask.status = "NEW";
                  tfrTask.isEnd2End = false;
                  tfrTask.creationDate = new Date();
              }
              var nodeToSelect = selNode.findNodeByModel(tfrTask);
              if (nodeToSelect != null) {
                  this.displayNode(nodeToSelect);
              }
          }


          function getTaskContainerNode_(orderUI) {
              var childNodes = orderUI.getRoot().childNodes;
              if(childNodes != null) {
                  var found = false;
                  for(var i=0; i<childNodes.length && !found; i++) {
                      var childNodePath = childNodes[i].model.orderDataPath;
                      if(childNodePath == "tasks") {
                          found = true;
                          selNode = childNodes[i];
                      }
                  }

                  if(!found) {
                      selNode = null;
                  }
              }
              else {
                  selNode = null;
              }

              return selNode;
          }
        ]]></script>
      </method>
      <method name="showRemarks" type="usrActionMethod">
        <dialogHeight>600</dialogHeight>
        <dialogWidth>1000</dialogWidth>
        <showInPopup>true</showInPopup>
        <script><![CDATA[
          var orderRemarksFinder = new Finder("tfs.findRemarksForOrder");
          orderRemarksFinder.searchDocument.cwDocID = this.model.id;
          orderRemarksFinder.search();

          return orderRemarksFinder;
        ]]></script>
      </method>
    </methodList>
  </UserInterface>
</order>