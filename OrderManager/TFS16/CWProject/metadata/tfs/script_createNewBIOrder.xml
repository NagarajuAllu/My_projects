<?xml version="1.0" encoding="UTF-8" ?>
<script name="tfs.createNewBIOrder">
  <label>Create New BI Order</label>
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="sourcePRNId" type="rifp">
      <type>dtype_cwf.docId</type>
    </parameter>
    <parameter name="sourceTFRId" type="rifp">
      <type>dtype_cwf.docId</type>
    </parameter>
    <parameter name="userId" type="rifp">
      <type>dtype_com.conceptwave.system.String</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var customerName = null;
    var buInitiator = null;

    var resultList = null;
    if(sourcePRNId != null) {
        var prnFinder = new Finder("tfs.findPRN");
        prnFinder.searchDocument.prnId = sourcePRNId;
        resultList = prnFinder.search();
    }
    else if(sourceTFRId != null) {
        var tfrFinder = new Finder("tfs.findTFR");
        tfrFinder.searchDocument.tfrId = sourceTFRId;
        resultList = tfrFinder.search();
    }

    if(resultList != null && resultList.length > 0) {
        customerName = resultList[0].customerName;
        buInitiator = (sourcePRNId != null ? resultList[0].businessUnit_Initiator : resultList[0].businessUnit_Requester);
    }

    var biOrder = new Order("tfs.biOrder");
    biOrder.biDocument.customerName = customerName;
    biOrder.biDocument.buInitiator = buInitiator;
    biOrder.biDocument.createdBy = userId;
    biOrder.save();

    var biRelationship = new Document ("tfs.STC_BI_RELATIONSHIP");
    biRelationship.biId = biOrder.biDocument.biId;
    biRelationship.prnId = (sourcePRNId != null ? sourcePRNId : "-1");
    biRelationship.tfrId = (sourceTFRId != null ? sourceTFRId : "-1");
    biRelationship.save();

    return biOrder.biDocument;
  ]]></script>
</script>