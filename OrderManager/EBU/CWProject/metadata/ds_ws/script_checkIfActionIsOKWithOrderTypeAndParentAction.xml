<?xml version="1.0" encoding="UTF-8" ?>
<script filenameHash="c338074cd5671965878b0e61c2c93b06" versionHash="a87ff679a2f3e71d9181a67b7542122c" name="ds_ws.checkIfActionIsOKWithOrderTypeAndParentAction">
  <label>Check If Action Is Compatible With OrderType And ParentAction</label>
  <metaVersion>4</metaVersion>
  <parameterList>
    <parameter name="orderType" type="rifp">
      <type>dtype_com.conceptwave.system.String</type>
    </parameter>
    <parameter name="orderStatus" type="rifp">
      <type>dtype_com.conceptwave.system.String</type>
    </parameter>
    <parameter name="parentLineItemAction" type="rifp">
      <type>dtype_com.conceptwave.system.String</type>
    </parameter>
    <parameter name="parentLineItemStatus" type="rifp">
      <type>dtype_com.conceptwave.system.String</type>
    </parameter>
    <parameter name="lineItemAction" type="rifp">
      <type>dtype_com.conceptwave.system.String</type>
    </parameter>
    <parameter name="serviceType" type="rifp">
      <type>dtype_com.conceptwave.system.String</type>
    </parameter>
    <parameter name="lineItemStatus" type="rifp">
      <type>dtype_com.conceptwave.system.String</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var compatible = false;

    if(lineItemAction == null) {
        return compatible;
    }

    var supportPartialCancel = true;
    var supportSendDisconnect = false;
    if(serviceType != null) {
        supportPartialCancel = ds_ws.checkIfServiceTypeSupportPartialCancel(serviceType);
        supportSendDisconnect = ds_ws.checkIfServiceTypeRequireDisconn4CancelOnCOMPLETED(serviceType);
    }


    // Check compatibility between orderType and lineItemAction
    if(orderType == "I") {
        // Install New: Add
        // Install Cancel: Cancel, No Change   <<<----- NO MORE; CRM will resend the existing action
        // Install Cancel: Cancel, Add, Modify
        // 2015-06-14: for Revise, "No Change" is not supported
        // So, correct is
        // Install Revise: Modify
        if(orderStatus.toUpperCase() == "NEW") {
            compatible = (lineItemAction.toUpperCase() == "A");
        }
        else if(orderStatus.toUpperCase() == "CANCEL") {
            if(supportPartialCancel) {
                compatible = (lineItemAction.toUpperCase() == "C" || lineItemAction.toUpperCase() == "A" || lineItemAction.toUpperCase() == "M" || (supportSendDisconnect && lineItemAction.toUpperCase() == "D"));
            }
            else {
                compatible = (lineItemAction.toUpperCase() == "C" || (supportSendDisconnect && lineItemAction.toUpperCase() == "D"));
            }
        }
        else if(orderStatus.toUpperCase() == "REVISE") {
            // 2015-06-14:
            // OLD & WRONG:
            //     compatible = (lineItemAction.toUpperCase() == "M" || lineItemAction.toUpperCase() == "N");
            // CORRECT:
            //     compatible = (lineItemAction.toUpperCase() == "M"

            // 2015-09-02: introducing partial revise; it means that if the lineItem is COMPLETED, action is ignored
            // compatible = (lineItemAction.toUpperCase() == "M" || processSTC.isLineItemCompleted(lineItemStatus));

            // 2016-03-31: action in revise was computely wrong (always set to "M" even if the element was new). Now the action is maintained as submit
            compatible = (lineItemAction.toUpperCase() == "M" || lineItemAction.toUpperCase() == "A" || processSTC.isLineItemCompleted(lineItemStatus));
        }
    }
    else if(orderType == "C") {
        // Change New: Modify, No Change (for Bundle)
        //             Add, Remove, Modify, No Change (for other LineItems)
        // Change Cancel: Cancel, No Change   <<<----- NO MORE; CRM will resend the existing action
        // Change Cancel: Cancel, Modify, No Change (for Bundle)
        //                Cancel, Add, Remove, Modify, No Change (for other LineItems)
        // 2015-06-14: for Revise, "No Change" is not supported
        // So, correct it
        // Change Revise: Modify
        if(orderStatus.toUpperCase() == "NEW") {
            if(parentLineItemAction == null) {
                // it's a bundle
                compatible = (lineItemAction.toUpperCase() == "M" || lineItemAction.toUpperCase() == "N");
            }
            else {
                compatible = (lineItemAction.toUpperCase() == "A" || lineItemAction.toUpperCase() == "D" || lineItemAction.toUpperCase() == "M" || lineItemAction.toUpperCase() == "N");
            }
        }
        else if(orderStatus.toUpperCase() == "CANCEL") {
            if(supportPartialCancel) {
                if(parentLineItemAction == null) {
                    // it's a bundle
                    compatible = (lineItemAction.toUpperCase() == "C" || lineItemAction.toUpperCase() == "M" || lineItemAction.toUpperCase() == "N");
                }
                else {
                    compatible = (lineItemAction.toUpperCase() == "C" || lineItemAction.toUpperCase() == "A" || lineItemAction.toUpperCase() == "D" || lineItemAction.toUpperCase() == "M" || lineItemAction.toUpperCase() == "N");
                }
            }
            else {
                compatible = (lineItemAction.toUpperCase() == "C");
            }
        }
        else if(orderStatus.toUpperCase() == "REVISE") {
            // 2015-06-14:
            // OLD & WRONG:
            //     compatible = (lineItemAction.toUpperCase() == "M" || lineItemAction.toUpperCase() == "N");
            // CORRECT:
            //     compatible = (lineItemAction.toUpperCase() == "M");

            // 2015-09-02: introducing partial revise; it means that if the lineItem is COMPLETED, action is ignored
            // compatible = (lineItemAction.toUpperCase() == "M" || processSTC.isLineItemCompleted(lineItemStatus));

            // 2016-03-31: action in revise was computely wrong (always set to "M" even if the element was new). Now the action is maintained as submit
            compatible = (lineItemAction.toUpperCase() == "M" || lineItemAction.toUpperCase() == "N" || lineItemAction.toUpperCase() == "A" || lineItemAction.toUpperCase() == "D" || processSTC.isLineItemCompleted(lineItemStatus));
        }
    }
    else if(orderType == "O") {
        // Permanent Disconnect New: Remove
        // Permanent Disconnect Cancel: Cancel, No Change   <<<----- NO MORE; CRM will resend the existing action
        // Permanent Disconnect Cancel: Cancel, Remove
        // Permanent Disconnect Revise: NOT ALLOWED
        if(orderStatus.toUpperCase() == "NEW") {
            compatible = (lineItemAction.toUpperCase() == "D");
        }
        else if(orderStatus.toUpperCase() == "CANCEL") {
            //compatible = (lineItemAction.toUpperCase() == "C" || lineItemAction.toUpperCase() == "D");
            if(supportPartialCancel){
                compatible = (lineItemAction.toUpperCase() == "C" || lineItemAction.toUpperCase() == "D" || lineItemAction.toUpperCase() == "M");
            }
            else {
                compatible = (lineItemAction.toUpperCase() == "C" || lineItemAction.toUpperCase() == "D");
            }
        }
        //Change by Dmytro: SMR 8194
        else if(orderStatus.toUpperCase() == "REVISE") {
            // compatible = (lineItemAction.toUpperCase() == "M" || processSTC.isLineItemCompleted(lineItemStatus));

            // 2016-03-31: action in revise was computely wrong (always set to "M" even if the element was new). Now the action is maintained as submit
            compatible = (lineItemAction.toUpperCase() == "M" || lineItemAction.toUpperCase() == "D" || processSTC.isLineItemCompleted(lineItemStatus));
        }
    }
    else if(orderType == "D") {
        // Temporary Disconnect New: Suspend
        // Temporary Disconnect Cancel: Cancel
        // Temporary Disconnect Revise: NOT ALLOWED
        if(orderStatus.toUpperCase() == "NEW") {
            compatible = (lineItemAction.toUpperCase() == "S");
        }
        else if(orderStatus.toUpperCase() == "CANCEL") {

            //compatible = (lineItemAction.toUpperCase() == "C");
            if(supportPartialCancel){
                compatible = (lineItemAction.toUpperCase() == "C" || lineItemAction.toUpperCase() == "M");
            }
            else{
                compatible = (lineItemAction.toUpperCase() == "C");
            }
        }
        //Change by Dmytro: SMR 8194
        else if(orderStatus.toUpperCase() == "REVISE"){
            // compatible = (lineItemAction.toUpperCase() == "M");

            // 2016-03-31: action in revise was computely wrong (always set to "M" even if the element was new). Now the action is maintained as submit
            compatible = (lineItemAction.toUpperCase() == "M" || lineItemAction.toUpperCase() == "S" || processSTC.isLineItemCompleted(lineItemStatus));
        }
    }
    else if(orderType == "E") {
        // Resume New: Resume
        // Resume Cancel: Cancel
        // Resume Revise: NOT ALLOWED
        if(orderStatus.toUpperCase() == "NEW") {
            compatible = (lineItemAction.toUpperCase() == "R");
        }
        else if(orderStatus.toUpperCase() == "CANCEL") {
            compatible = (lineItemAction.toUpperCase() == "C");
        }
        //Change by Dmytro: SMR 8194
        else if(orderStatus.toUpperCase() == "REVISE"){
            // compatible = (lineItemAction.toUpperCase() == "M" || processSTC.isLineItemCompleted(lineItemStatus));

            // 2016-03-31: action in revise was computely wrong (always set to "M" even if the element was new). Now the action is maintained as submit
            compatible = (lineItemAction.toUpperCase() == "M" || lineItemAction.toUpperCase() == "R" || processSTC.isLineItemCompleted(lineItemStatus));
        }
    }
    else if(orderType == "T") {
        // Transfer New: Modify
        // Transfer Cancel: NOT ALLOWED
        // Transfer Revise: NOT ALLOWED
        if(orderStatus.toUpperCase() == "NEW") {
            compatible = (lineItemAction.toUpperCase() == "M");
        }
    }
    else if(orderType == "F") {
        // Feasibility New: Add
        // Feasibility Cancel: Cancel
        // Feasibility Revise: NOT ALLOWED
        if(orderStatus.toUpperCase() == "NEW") {
            compatible = (lineItemAction.toUpperCase() == "A" || lineItemAction.toUpperCase() == "M");
        }
        else if(orderStatus.toUpperCase() == "CANCEL") {
            // 'C' is the default action
            // 'D' is the action internally set by WD in case it receives a cancel over a completed feasibility - to send a disconnect to GI
            compatible = (lineItemAction.toUpperCase() == "C" || lineItemAction.toUpperCase() == "D");
        }
    }

    if(compatible && parentLineItemAction != null) {
        if(orderStatus.toUpperCase() == "REVISE" && processSTC.isLineItemCompleted(parentLineItemStatus)) {
            // 2015-09-03: Partial Revise - check is ignored in case the status of the parentLineItem is COMPLETED!
            compatible = true;
        }
        else {
            // reset compatible flag to get only the compatible matches
            compatible = false;
            var isCancel = (orderStatus.toUpperCase() == "CANCEL");

            // check compatibility between parentLineItemAction and lineItemAction
            if(parentLineItemAction.toUpperCase() == "A") {
                if(!isCancel) {
                    // Add -> Add
                    compatible = (lineItemAction.toUpperCase() == "A");
                }
                else {
                    // Add -> Add, Cancel
                    compatible = (lineItemAction.toUpperCase() == "A" || lineItemAction.toUpperCase() == "C");
                }
            }
            else if(parentLineItemAction.toUpperCase() == "D") {
                if(!isCancel) {
                    // Remove -> Remove, Modify
                    compatible = (lineItemAction.toUpperCase() == "D" || lineItemAction.toUpperCase() == "M");
                }
                else {
                    // Remove -> Remove, Cancel
                    compatible = (lineItemAction.toUpperCase() == "D" || lineItemAction.toUpperCase() == "C");
                }
            }
            else if(parentLineItemAction.toUpperCase() == "M") {
                if(!isCancel) {
                    // Modify -> Add, Remove, Modify, No Change, Suspend for Revise, Resume for Revise
                    compatible = (lineItemAction.toUpperCase() == "A" || lineItemAction.toUpperCase() == "D" || lineItemAction.toUpperCase() == "M" || lineItemAction.toUpperCase() == "N" ||
                                  (lineItemAction.toUpperCase() == "S" && orderStatus.toUpperCase() == "REVISE") || (lineItemAction.toUpperCase() == "R" && orderStatus.toUpperCase() == "REVISE"));
                }
                else {
                    // Modify -> Add, Remove, Modify, No Change, Cancel
                    compatible = (lineItemAction.toUpperCase() == "A" || lineItemAction.toUpperCase() == "D" || lineItemAction.toUpperCase() == "M" || lineItemAction.toUpperCase() == "N" || lineItemAction.toUpperCase() == "C");
                }
            }
            else if(parentLineItemAction.toUpperCase() == "N") {
                // No Change -> Add, Remove, Modify, No Change, Cancel, Suspend for Revise, Resume for Revise
                compatible = (lineItemAction.toUpperCase() == "A" || lineItemAction.toUpperCase() == "D" || lineItemAction.toUpperCase() == "M" || lineItemAction.toUpperCase() == "N" || lineItemAction.toUpperCase() == "C" ||
                              (lineItemAction.toUpperCase() == "S" && orderStatus.toUpperCase() == "REVISE") || (lineItemAction.toUpperCase() == "R" && orderStatus.toUpperCase() == "REVISE"));
            }
            else if(parentLineItemAction.toUpperCase() == "C") {
                // Cancel -> Cancel
                compatible = (lineItemAction.toUpperCase() == "C" || (supportSendDisconnect && lineItemAction.toUpperCase() == "D"));
            }
            else if(parentLineItemAction.toUpperCase() == "S") {
                // Suspend -> Suspend, Modify
                compatible = (lineItemAction.toUpperCase() == "S" || lineItemAction.toUpperCase() == "M");
            }
            else if(parentLineItemAction.toUpperCase() == "R") {
                // Resume -> Resume
                compatible = (lineItemAction.toUpperCase() == "R");
            }
        }
    }

    return compatible;
  ]]></script>
</script>