<?xml version="1.0" encoding="UTF-8" ?>
<script filenameHash="83ecef9007dbfd9fa5017c32fd63c23f" versionHash="a87ff679a2f3e71d9181a67b7542122c" name="ds_ws.performOrderValidationInGranite">
  <label>Perform Order Validation In Granite</label>
  <metaVersion>4</metaVersion>
  <parameterList>
    <parameter name="bundleOrder" type="rifp">
      <type>order_ds_ws.bundleOrderSTC</type>
    </parameter>
    <parameter name="isSubmit" type="rifp">
      <type>dtype_com.conceptwave.system.Boolean</type>
    </parameter>
    <parameter name="failureArray" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var validationItemArray = ds_ws.generateInputDataForGraniteValidationWS(bundleOrder);

    if(validationItemArray != null && validationItemArray.length > 0) {

        var inputDS = new DataStructure("ifCIM_E_ws.validate");
        for(var i=0; i<validationItemArray.length; i++) {
            inputDS.arg0.validationItem[i] = validationItemArray[i];
        }
        var resultDS =  null;

        try {
            resultDS = processSTC.sendDataToInterface(inputDS, "ifCIM_E_ws.ValidationService", "validate", true, null, "InvokeValidationWSInGranite", bundleOrder.orderHeader.orderNumber, null);
        }
        catch(exc) {
            var errorType = "Application";

            if(exc.message.indexOf("XE0023") >= 0 || exc.message.indexOf("XE0002")) {
    debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "] performOrderValidationInGranite (" + bundleOrder.orderHeader.orderNumber + "): Interface Error while invoking Granite WS: " + exc.message);
                errorType = "Interface";
            }
            else {
    debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "] performOrderValidationInGranite (" + bundleOrder.orderHeader.orderNumber + "): Application Error while invoking Granite WS: " + exc.message);
                errorType = "Application";
            }

            var validationErrors = ["AE0054", Global.translateText("AE0054", null, [errorType, bundleOrder.orderHeader.orderNumber, exc.message])];
            failureArray = ds_ws.addValidationErrorsToFailureArray(validationErrors, bundleOrder.orderHeader.orderNumber, failureArray, "VALIDATION ERROR IN GRANITE", (isSubmit ? "SUBMIT ORDER" : "UPDATE ORDER"), "WD_XNG");
        }

        if(resultDS != null) {
            for(var i=0; i<resultDS.return.validationResponseItem.length; i++) {
                if(resultDS.return.validationResponseItem[i].result == "Rejected") {
                    var validationErrors = new Array();
                    var counter = 0;
                    for(var j=0; j<resultDS.return.validationResponseItem[i].failure.length; j++) {
                        validationErrors[counter++] = resultDS.return.validationResponseItem[i].failure[j].errorCode;
                        validationErrors[counter++] = resultDS.return.validationResponseItem[i].failure[j].errorDescription;
                    }

    debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "] performOrderValidationInGranite (" + resultDS.return.validationResponseItem[i].lineItemIdentifier + "): Granite WS Rejection reasons: [" + validationErrors + "]");
                    failureArray = ds_ws.addValidationErrorsToFailureArray(validationErrors, resultDS.return.validationResponseItem[i].lineItemIdentifier, failureArray, "VALIDATION ERROR IN GRANITE", (isSubmit ? "SUBMIT ORDER" : "UPDATE ORDER"), "WD_XNG");
                }
            }
        }
    }

    return failureArray;
  ]]></script>
</script>