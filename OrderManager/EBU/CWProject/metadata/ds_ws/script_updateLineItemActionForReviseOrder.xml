<?xml version="1.0" encoding="UTF-8" ?>
<script filenameHash="b01862f05b9662d2ee428994acf6d58c" versionHash="a87ff679a2f3e71d9181a67b7542122c" name="ds_ws.updateLineItemActionForReviseOrder">
  <label>Update LineItemAction For ReviseOrder</label>
  <metaVersion>4</metaVersion>
  <parameterList>
    <parameter name="lineItem" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
    <parameter name="existingLineItem" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
    <parameter name="existingOrderWasKO" type="rifp">
      <type>dtype_com.conceptwave.system.Boolean</type>
    </parameter>
    <parameter name="validationErrors" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    /*******
       NOTE: Please refer to the following table (mail sent by MR to Waleed 2015-05-01):
    -------------+-------------------+-------------------------------|
                 |                Revise                             |
                 |-------------------+-------------------------------|
                 | Already received  |         Not received          |
                 |      cancel       |            cancel             |
    -------------+-------------------+-------------------------------|
     Hold        |       REJECT      |       Status: Hold            |
                 |                   |       Action: existing        |
                 |                   |       send as Submit          |
    -------------+-------------------+-------------------+-----------|
     COMPLETED   |       REJECT      |  Prev. Action N:  |  Default: |
                 |                   | Status: COMPLETED |  REJECT   |
                 |                   | Action: existing  |           |
                 |                   | NO PROVISIONING   |           |
    -------------+-------------------+-------------------+-----------|
     CANCELLED   |                 REJECT                            |
    -------------+-------------------+-------------------------------|
     FAILED      |                 REJECT                            |
    -------------+-------------------+-------------------------------|
     Submitted   |       REJECT      |       Status: Hold            |
                 |                   |       Action: M               |
                 |                   |       send as Update          |
    -------------+-------------------+-------------------------------|


    **********/

    var existingLineItemStatus = existingLineItem.lineItemStatus;
    var existingLineItemAction = existingLineItem.action;
    var existingLineItemInGranite = existingLineItem.alreadySentToGranite;

    var receivedAction = lineItem.action;

    if(existingLineItemStatus == "Hold" || existingLineItemStatus == "Waiting for Granite Resp") {
        if(lineItem.alreadyReceivedCancel) {
            validationErrors = ds_ws.appendToValidationErrors("AE0070", Global.translateText("AE0070", null, "ReviseOrder"), validationErrors, "updateLineItemActionForReviseOrder (" + lineItem.lineItemIdentifier + ")");
        }
        else {
            // just received; maintain everything
            lineItem.action = existingLineItemAction;
            lineItem.lineItemStatus = "Hold";

            // send still as Submit! 2015-10-27: wrong approach in case it receives multiple revise before starting the processes!!! it has to set equals to the values of the previous instance of the item
            // lineItem.isSubmit = true;
            lineItem.isSubmit = existingLineItem.isSubmit;
            lineItem.isCancel = false;
        }
    }
    else if(existingLineItemStatus.toUpperCase() == "COMPLETED") {
        // element COMPLETED; so REJECT
        if(existingLineItemAction == "N") {
            // lineItem COMPLETED due the action that was "N" so nothing to do
            lineItem.action = "N";
            lineItem.lineItemStatus = "COMPLETED";
        }
        else if(existingLineItemAction == receivedAction) {
            // 2015-09-02 - Partial revise management!
            lineItem.action = existingLineItemAction;
            lineItem.lineItemStatus = "COMPLETED";
        }
        else {
            validationErrors = ds_ws.appendToValidationErrors("AE0071", Global.translateText("AE0071", null, ["ReviseOrder", "COMPLETED"]), validationErrors, "updateLineItemActionForReviseOrder (" + lineItem.lineItemIdentifier + ")");
        }
    }
    else if(existingLineItemStatus.toUpperCase() == "CANCELLED") {
        // element CANCELLED; so REJECT
        validationErrors = ds_ws.appendToValidationErrors("AE0071", Global.translateText("AE0071", null, ["ReviseOrder", "CANCELLED"]), validationErrors, "updateLineItemActionForReviseOrder (" + lineItem.lineItemIdentifier + ")");
    }
    else if(existingLineItemStatus.toUpperCase() == "FAILED" && (!existingLineItemInGranite)) {
        if(!existingOrderWasKO) {
            // it should never happens
            validationErrors = ds_ws.appendToValidationErrors("AE0071", Global.translateText("AE0071", null, ["ReviseOrder", "FAILED"]), validationErrors, "updateLineItemActionForReviseOrder (" + lineItem.lineItemIdentifier + ")");
        }
        else {
            lineItem.action = existingLineItem.action;
            lineItem.lineItemStatus = "Hold";
            lineItem.isSubmit = existingLineItem.isSubmit;
            lineItem.isCancel = existingLineItem.isCancel;
            lineItem.workOrderNumber = existingLineItem.workOrderNumber;
            lineItem.alreadySentToGranite = existingLineItem.alreadySentToGranite;
        }
    }
    else {
        // in provisioning
        if(lineItem.alreadyReceivedCancel) {
            validationErrors = ds_ws.appendToValidationErrors("AE0070", Global.translateText("AE0070", null, "ReviseOrder"), validationErrors, "updateLineItemActionForReviseOrder (" + lineItem.lineItemIdentifier + ")");
        }
        else {
            // just received; maintain everything
            lineItem.action = "M";
            lineItem.lineItemStatus = "Hold";
            // send as Update(Revise)
            lineItem.isSubmit = false;
            lineItem.isCancel = false;
            lineItem.alreadySentToGranite = false;
        }
    }

    return validationErrors;
  ]]></script>
</script>