<?xml version="1.0" encoding="UTF-8" ?>
<script filenameHash="9086b6af1e7a3352f77ff99df2195a88" versionHash="a87ff679a2f3e71d9181a67b7542122c" name="ds_ws.performFullValidationOnLegacyOrder">
  <label>Perform Full Validation On Legacy Order</label>
  <metaVersion>4</metaVersion>
  <parameterList>
    <parameter name="orderHeader" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
    <parameter name="bundleContainer" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
    <parameter name="isSubmit" type="rifp">
      <type>dtype_com.conceptwave.system.Boolean</type>
    </parameter>
    <parameter name="failureArray" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var validationErrors = null;
    var reservationStatus = "RESERVATION";
    var orderedStatus = "ORDERED";


    if(isSubmit) {
        var pathInGranite = granite.getPathInGranite(bundleContainer.bundle.serviceNumber);

        if(orderHeader.orderType == "I") {
            if(orderHeader.reservationNumber == null) {
                /***
                 * 2016/02/15 - Check removed as requested by Rao with email "SMR-3836 reservation number"
                 *
                if(pathInGranite != null) {
                    // Install, no reservation but path exists in Granite
                    validationErrors = ["AE0096", Global.translateText("AE0096", null, ["order", bundleContainer.bundle.serviceNumber])];
                }
                 *
                 ***/
            }
            else {
                if(pathInGranite == null) {
                    // Install, reservation but path is missing in Granite
                    validationErrors = ["AE0097", Global.translateText("AE0097", null, ["order linked to reservation", bundleContainer.bundle.serviceNumber])];
                }
                else {
                    if(! pathInGranite.STATUS.toUpperCase().equals(reservationStatus)) {
                        // Install, reservation, path is in Granite but has wrong status
                        validationErrors = ["AE0098", Global.translateText("AE0098", null, ["order linked to reservation", bundleContainer.bundle.serviceNumber, pathInGranite.STATUS, reservationStatus])];
                    }
                }
            }
        }
        else if(orderHeader.orderType == "C") {
            if(orderHeader.reservationNumber == null) {
                /***
                 * 2016/02/15 - Check removed as requested by Rao with email "SMR-3836 reservation number"
                 *
                if(pathInGranite != null) {
                    if(pathInGranite.STATUS.toUpperCase().equals(reservationStatus) || pathInGranite.STATUS.toUpperCase().equals(orderedStatus)) {
                        // Change, no reservation, path is in Granite but has wrong status
                        validationErrors = ["AE0099", Global.translateText("AE0099", null, [bundleContainer.bundle.serviceNumber, pathInGranite.STATUS])];
                    }
                }
                *
                ***/
            }
            else {
                if(pathInGranite == null) {
                    // Change, reservation but path is not in Granite
                    validationErrors = ["AE0097", Global.translateText("AE0097", null, ["order linked to reservation", bundleContainer.bundle.serviceNumber])];
                }
                else {
                    if(pathInGranite.STATUS.toUpperCase().equals(reservationStatus)) {
                        // Change, reservation, path is in Granite but has wrong status
                        validationErrors = ["AE0098", Global.translateText("AE0098", null, ["order linked to reservation", bundleContainer.bundle.serviceNumber, pathInGranite.STATUS, reservationStatus])];
                    }
                }
            }
        }

        if(orderHeader.orderType == "I" || orderHeader.orderType == "C") {
            if(orderHeader.reservationNumber != null && orderHeader.reservationNumber.trim().length > 0) {
                var allOrdersWithReservationNumber = ds_ws.getAllBundleOrdersByReservationNumber(orderHeader.reservationNumber);
                if(allOrdersWithReservationNumber != null) {
                    var foundOrderNumber = null;
                    for(var i=0; i<allOrdersWithReservationNumber.length && (foundOrderNumber == null); i++) {
                        var orderWithReservation = Order.getOrderById(allOrdersWithReservationNumber[i].orderId);
                        if(orderWithReservation.orderHeader.orderType != 'F' && !orderWithReservation.bundles[0].bundle.alreadyReceivedCancel) {
                            foundOrderNumber = orderWithReservation.orderHeader.orderNumber;
                        }
                    }

                    if(foundOrderNumber != null) {
                        // there is another order that is already usning the reservation
                        validationErrors = ds_ws.appendToValidationErrors("AE0094", Global.translateText("AE0094", null, foundOrderNumber), validationErrors, "performFullValidationOnLegacyOrder(" + orderHeader.orderNumber + ")");
                    }
                }
            }
        }
    }

    if(validationErrors != null) {
        failureArray = ds_ws.addValidationErrorsToFailureArrayForSub_UpdInWD(validationErrors, bundleContainer.bundle.lineItemIdentifier, failureArray, isSubmit);
    }

    //Check Block Params against configuration
    failureArray = ds_ws.performValidationForBlockParameters(bundleContainer.bundleBlockParameters, 'bundleBlockParameter', orderHeader.orderType, orderHeader.orderStatus, bundleContainer.bundle.serviceType, bundleContainer.bundle.lineItemIdentifier,
                                                             failureArray, isSubmit);

    return failureArray;
  ]]></script>
</script>