<?xml version="1.0" encoding="UTF-8" ?>
<script filenameHash="ff606e7923935a0bf8cd9f278942d8fe" versionHash="a87ff679a2f3e71d9181a67b7542122c" name="processSTC.updateGeneratedOrderWithGraniteResponse">
  <label>Update Generated Order With Granite Response</label>
  <metaVersion>4</metaVersion>
  <parameterList>
    <parameter name="orderNumber" type="rifp">
      <type>dtype_com.conceptwave.system.String</type>
    </parameter>
    <parameter name="graniteFailure" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    // search created input record
    var searchDoc = new Document("ds_ws.search_InsertFeasibilityOrder_ByOrderNumDoc");
    searchDoc.orderNumber = orderNumber;
    var resultFinder = Finder.runFinder("ds_ws.findInsertFeasibilityOrderByOrderNumber", "select", searchDoc);
    if(resultFinder != null && resultFinder.length > 0) {
        // found
        var insertedOrder = resultFinder[0];
    debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "]updateGeneratedOrderWithGraniteResponse(" + orderNumber + ") - updating generatedOrder");
        insertedOrder.graniteResponse = ((graniteFailure == null || graniteFailure.length == 0) ? "SUBMITTED" : "FAILED");
        if(graniteFailure != null) {
            for(var i=0; i<graniteFailure.length; i++) {
                insertedOrder.graniteFailureMessage = ((i==0 ? "" : insertedOrder.graniteFailureMessage + ";") + graniteFailure[i].errorDescription);
            }
        }

        insertedOrder.save();
    debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "]updateGeneratedOrderWithGraniteResponse(" + orderNumber + ") - updated generatedOrder");

        if(insertedOrder.jobId != null) {
    debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "]updateGeneratedOrderWithGraniteResponse(" + orderNumber + ") - looking for process for jobId " + insertedOrder.jobId);
            var inputSearchDoc = new Document("ds_ws.search_jobIdDocument");
            inputSearchDoc.jobId = insertedOrder.jobId;

            var resultList = Finder.runFinder("ds_ws.findJobIdProcessed", "select", inputSearchDoc);
            if(resultList != null && resultList.length>0) {
    debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "]updateGeneratedOrderWithGraniteResponse(" + orderNumber + ") - waking up process" + resultList[0].processId);
                Process.sendSignal("processSTC.wakeUpParentInBulk", resultList[0].processId);
            }
            else {
    debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "]updateGeneratedOrderWithGraniteResponse(" + orderNumber + ") - unable to find the process related to jobId " + insertedOrder.jobId);
            }
        }
        else {
    debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "]updateGeneratedOrderWithGraniteResponse(" + orderNumber + ") - there isn't any job linked");
        }
    }
    else {
    debugPrintln("[" + common.common_currentDateAsStringDDMMYYYYHH24MISS() + "]updateGeneratedOrderWithGraniteResponse(" + orderNumber + ") - there isn't generated order with such orderNumber");
    }
  ]]></script>
</script>