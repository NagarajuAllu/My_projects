<?xml version="1.0" encoding="UTF-8" ?>
<script filenameHash="9641e9a12f1714298d4b0a465169ca92" versionHash="a87ff679a2f3e71d9181a67b7542122c" name="processSTC.writeSequenceForCircuitsInOrder">
  <label>Write Sequence For Circuits In Order</label>
  <metaVersion>4</metaVersion>
  <parameterList>
    <parameter name="bundleOrder" type="rifp">
      <type>order_ds_ws.bundleOrderSTC</type>
    </parameter>
    <parameter name="bundleContainer" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var sequence                = 1;
    var priority                = 1;
    var child_processed         = 0;
    var count_processed_in_loop = 0;
    var errorFound              = null;
    var exceptionFound          = null;
    var found_record_with_higher_priority = false;

    if(bundleContainer.circuits == null) {
        return errorFound;
    }

    try {
        while(child_processed < bundleContainer.circuits.length && errorFound == null) {
            count_processed_in_loop = 0;
            found_record_with_higher_priority = false;

            for(var i=0; i<bundleContainer.circuits.length && errorFound == null; i++) {
                var isProvisionable = (!processSTC.isLineItemCompleted(bundleContainer.circuits[i].circuit.lineItemStatus) &&
                                       !ds_ws.isVAS(bundleContainer.circuits[i].circuit.lineItemType) &&
                                       ds_ws.checkIfServiceTypeAllowsProvisioning(bundleContainer.circuits[i].circuit.serviceType) &&
                                       bundleContainer.circuits[i].circuit.action != 'N');

                if(bundleContainer.circuits[i].circuit.priority == priority) {
                    // priority is good; checking if already processed
                    if(! processSTC.existRecordInOrchestrationTable(bundleContainer.circuits[i].circuit.id)) {
                        // to be processed; checking if has dependencies
                        if(bundleContainer.circuits[i].circuit.dependencies == null || bundleContainer.circuits[i].circuit.dependencies.length == 0) {
                            // no dependencies ==> add record to table
                            processSTC.writeRecordForLineItemInOrchestrationTable(bundleOrder.orderHeader.orderNumber,
                                                                                  bundleOrder.id,
                                                                                  bundleContainer.bundle.id,
                                                                                  sequence,
                                                                                  isProvisionable,
                                                                                  bundleContainer.circuits[i].circuit,
                                                                                  'C');
                            child_processed++;
                            count_processed_in_loop++;
                            errorFound = processSTC.writeSequenceForServicesInBundle(bundleOrder, bundleContainer.circuits[i]);
                        }
                        else {
                            // there are dependencies; checking if already processed
                            var all_dependencies_processed = true;
                            var dependencies = bundleContainer.circuits[i].circuit.dependencies.split(";");
                            for(var j=0; j<dependencies.length && all_dependencies_processed; j++) {
                                // check if the dependencies is in table; if yes, continue, otherwise stop;
                                var recordInOrchestrationTable = processSTC.getRecordInOrchTabByItemIdentifier_OrdNum_CwOrdId(bundleOrder.orderHeader.orderNumber, bundleOrder.id, dependencies[j]);
                                if(recordInOrchestrationTable != null) {
                                    if(recordInOrchestrationTable.elementTypeInOrchestration != 'C') {
                                        // Error in orchestration: element {0} depends on a not sibling element: {1}
                                        exceptionFound = "AE0032";
                                        Global.throwException(Global.translateText("AE0032", null, [bundleContainer.circuits[i].circuit.lineItemIdentifier, dependencies[j]]));
                                    }

                                    if(!recordInOrchestrationTable.provisionable) {
                                        // Error in orchestration: element {0} depends on a non provisionable element: {1}
                                        exceptionFound = "AE0033";
                                        Global.throwException(Global.translateText("AE0033", null, [bundleContainer.circuits[i].circuit.lineItemIdentifier, dependencies[j]]));
                                    }

                                    // checking that the current element has a higher sequence that the dependency
                                    all_dependencies_processed = (recordInOrchestrationTable.sequence < sequence);
                                }
                                else {
                                    all_dependencies_processed = false;
                                }
                            }

                            if(all_dependencies_processed) {
                                // all dependencies have been already processed ==> add record to table
                                processSTC.writeRecordForLineItemInOrchestrationTable(bundleOrder.orderHeader.orderNumber,
                                                                                      bundleOrder.id,
                                                                                      bundleContainer.bundle.id,
                                                                                      sequence,
                                                                                      isProvisionable,
                                                                                      bundleContainer.circuits[i].circuit,
                                                                                      'C');
                                child_processed++;
                                count_processed_in_loop++;
                                errorFound = processSTC.writeSequenceForServicesInBundle(bundleOrder, bundleContainer.circuits[i]);
                            }
                        }
                    }
                    else {
                        // already processed, so skipped
                    }
                }
                else {
                    // priority is different
                    if(!found_record_with_higher_priority) {
                        found_record_with_higher_priority = (bundleContainer.circuits[i].circuit.priority > priority);
                    }
                }
            } // end for

            if(count_processed_in_loop == 0) {
                // found no processable record in the for
                if(found_record_with_higher_priority) {
                    // but found a child with higher priority, so increase the priority
                    priority++
                }
                else {
                    errorFound = new DataStructure("ds_ws:OrderFailure");
                    errorFound.ErrorCode = "AE0031";
                    errorFound.ErrorDescription = Global.translateText("AE0031", null,  [bundleContainer.bundle.lineItemIdentifier, bundleOrder.orderHeader.orderNumber]);
                    errorFound.ErrorTime = common.common_currentDateAsStringDDMMYYYYHH24MISS();
                    errorFound.ErrorType = "VALIDATION ERROR";
                    errorFound.FunctionName = "SUBMIT ORDER";
                    errorFound.ObjectId = bundleOrder.orderHeader.orderNumber;
                    errorFound.SystemName = "Workflow Director";
                }
            }
            else {
                // increasing the sequence because a new loop has to start
                sequence++;
            }
        }  // end while
    }
    catch(exc) {
        errorFound = new DataStructure("ds_ws:OrderFailure");
        errorFound.ErrorCode = exceptionFound;
        errorFound.ErrorDescription = exc.message;
        errorFound.ErrorTime = common.common_currentDateAsStringDDMMYYYYHH24MISS();
        errorFound.ErrorType = "VALIDATION ERROR";
        errorFound.FunctionName = "SUBMIT ORDER";
        errorFound.ObjectId = bundleOrder.orderHeader.orderNumber;
        errorFound.SystemName = "Workflow Director";
    }

    return errorFound;
  ]]></script>
</script>