<?xml version="1.0" encoding="UTF-8" ?>
<script filenameHash="3644c25a8198b3d5509b1da1e748a213" versionHash="a87ff679a2f3e71d9181a67b7542122c" name="processSTC.prepareJMSDSOrder">
  <label>Prepare JMS DS Submit/Update Order</label>
  <metaVersion>4</metaVersion>
  <parameterList>
    <parameter name="bundleOrder" type="rifp">
      <type>order_ds_ws.bundleOrderSTC</type>
    </parameter>
    <parameter name="orderItem" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var jmsOrderDS = new DataStructure("ds_jms.bundleOrderMessage_el");

    // map orderHeader
    bundleOrder.orderHeader.mapTo(jmsOrderDS);
    jmsOrderDS.orderStatus = (orderItem.isSubmit ? "New" : (orderItem.isCancel ? "Cancel" : "Revise"));

    // adding workOrderType to orderHeader
    var workOrderType = processSTC.getWorkOrderType(bundleOrder.orderHeader.orderType, orderItem.action);
    jmsOrderDS.workOrderType = (workOrderType != null ? workOrderType : bundleOrder.orderHeader.orderType);


    // adding workOrderNumber to orderHeader
    if(orderItem.workOrderNumber != null) {
        // applicable only for updateOrder
        jmsOrderDS.workOrderNumber = orderItem.workOrderNumber;
    }
    else {
        var workOrderNumber = processSTC.generateWONumber(orderItem, workOrderType, bundleOrder); // processSTC.getNewChildOrderNumber(workOrderType);
        if(workOrderNumber == null) {
            Global.throwException("Error in generating workOrderNumber");
        }
        jmsOrderDS.workOrderNumber = workOrderNumber;

        orderItem.workOrderNumber = workOrderNumber;
        orderItem.save();
    }

    // adding reasonCode array to orderHeader
    var reasonCodeArray = ds_ws.getReasonCodesAsArray(bundleOrder.orderHeader.id);
    if(reasonCodeArray != null) {
        for(var i=0; i<reasonCodeArray.length; i++) {
            jmsOrderDS.reasonCode[i] = reasonCodeArray[i];
        }
    }

    // mapping order parameters (NV)
    if(bundleOrder.orderHeaderParameters != null) {
        for(var i=0; i<bundleOrder.orderHeaderParameters.length; i++) {
            bundleOrder.orderHeaderParameters[i].orderHeaderParameter.mapTo(jmsOrderDS.orderNameValueParameters[i]);
        }
    }


    /////////////////////////////////////////////
    //    LINE ITEM
    /////////////////////////////////////////////

    // mapping orderItem
    processSTC.mapLineItemIntoJMSDSOrder(bundleOrder, orderItem, jmsOrderDS.lineItem, true);

    return jmsOrderDS;
  ]]></script>
</script>